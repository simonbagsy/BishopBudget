<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#020617" />

  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <title>Monthly Budget</title>

  <style>
    :root{
      --bgDeep: #020617;
      --bg: #0b1120;
      --bgMid: #1f2937;

      --card: #0f172a;
      --cardSoft: #121b33;
      --pill: #16213a;

      --text: #e5e7eb;
      --textSoft: #9ca3af;
      --textMuted: #6b7280;

      --blueA: #1d4ed8;
      --blueB: #06b6d4;
      --blueSoft: #60a5fa;

      --green: #22c55e;
      --greenSoft: #bbf7d0;

      --red: #fb7185;
      --amber: #fb923c;

      --stroke: rgba(255,255,255,0.10);
      --stroke2: rgba(96,165,250,0.55);

      --radiusXL: 18px;
      --radiusLG: 14px;
      --radiusMD: 12px;
      --radiusSM: 10px;

      --shadow: 0 10px 30px rgba(0,0,0,0.28);
    }

    *{ box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body{
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 900px at 10% 0%, rgba(6,182,212,0.10), transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, rgba(29,78,216,0.12), transparent 55%),
                  linear-gradient(135deg, var(--bgDeep), var(--bg));
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    .wrap{
      max-width: 900px;
      margin: 0 auto;
      padding: 16px 14px 28px;
      padding-bottom: calc(28px + env(safe-area-inset-bottom));
    }

    .card{
      background: var(--cardSoft);
      border: 1px solid var(--stroke);
      border-radius: var(--radiusXL);
      box-shadow: var(--shadow);
    }

    .cardInner{
      padding: 14px;
    }

    .header{
      padding: 14px;
      margin-bottom: 10px;
    }

    .headerTop{
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .titleBlock{
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 0;
    }

    .title{
      font-weight: 700;
      letter-spacing: 0.2px;
      font-size: 18px;
      margin: 0;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .subtitle{
      margin: 0;
      font-size: 13px;
      color: var(--textSoft);
    }

    .appIcon{
      width: 56px;
      height: 56px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      overflow: hidden;
      flex: 0 0 auto;
      background: rgba(255,255,255,0.03);
      display: grid;
      place-items: center;
    }
    .appIcon img{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .monthRow{
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill{
      background: rgba(22,33,58,0.92);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 10px 12px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
      font-size: 13px;
      line-height: 1;
      min-height: 42px;
    }

    .pillLabel{
      color: var(--textMuted);
      font-size: 12px;
    }

    .pillValue{
      color: #c7d2fe;
      font-weight: 700;
      font-size: 13px;
    }

    .btn{
      cursor: pointer;
      user-select: none;
      background: linear-gradient(135deg, rgba(29,78,216,0.95), rgba(6,182,212,0.92));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      color: white;
      font-weight: 700;
      font-size: 13px;
      padding: 10px 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.25);
      transition: transform 0.06s ease;
    }
    .btn:active{ transform: translateY(1px); }

    .btnGhost{
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--stroke);
      box-shadow: none;
      color: var(--text);
      font-weight: 700;
    }

    .btnDanger{
      background: rgba(251,113,133,0.14);
      border: 1px solid rgba(251,113,133,0.25);
      color: var(--text);
      box-shadow: none;
    }

    .btnTiny{
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 800;
    }

    .section{
      margin-top: 10px;
    }

    .sectionTitle{
      font-size: 15px;
      font-weight: 800;
      margin: 0 0 10px 0;
      color: var(--text);
    }

    .grid2{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 680px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .summaryPill{
      background: rgba(22,33,58,0.92);
      border: 1px solid var(--stroke);
      border-radius: var(--radiusLG);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 88px;
    }

    .summaryTitle{
      font-size: 12px;
      color: var(--textSoft);
      font-weight: 700;
    }

    .summarySub{
      font-size: 11px;
      color: var(--textMuted);
    }

    .summaryVal{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .muted{ color: var(--textMuted); }
    .soft{ color: var(--textSoft); }

    .donutCard{
      cursor: pointer;
      overflow: hidden;
    }

    .donutRow{
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 680px){
      .donutRow{
        grid-template-columns: 1fr;
      }
    }

    .donutWrap{
      display: grid;
      place-items: center;
    }

    .donutCanvas{
      width: 150px;
      height: 150px;
      display: block;
    }

    .donutText{
      position: relative;
      margin-top: -122px;
      display: grid;
      place-items: center;
      pointer-events: none;
    }

    .donutPct{
      font-size: 24px;
      font-weight: 900;
      color: var(--text);
      margin: 0;
      line-height: 1;
    }

    .donutSub{
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--textSoft);
      margin: 6px 0 0 0;
    }

    .statusTitle{
      font-size: 14px;
      font-weight: 900;
      margin: 0;
    }

    .statusBody{
      margin: 6px 0 0 0;
      font-size: 13px;
      color: var(--textSoft);
      line-height: 1.35;
    }

    .graph{
      width: 100%;
      height: 78px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,0.6);
      overflow: hidden;
      margin-top: 10px;
    }

    .graph canvas{
      width: 100%;
      height: 100%;
      display: block;
    }

    .whatif{
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,0.65);
    }

    .whatifHead{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .slider{
      width: 100%;
    }

    .formGrid{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 680px){
      .formGrid{
        grid-template-columns: 1fr 1fr;
      }
    }

    .field{
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(96,165,250,0.40);
      border-radius: 12px;
      padding: 10px 12px;
      min-height: 42px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }

    .field input, .field select{
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 13px;
      font-weight: 800;
      appearance: none;
    }

    .field label{
      font-size: 12px;
      color: var(--textSoft);
      font-weight: 800;
      white-space: nowrap;
    }

    .formActions{
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .listWindow{
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,0.65);
      overflow: hidden;
    }

    /* Taller mini windows so you can see more items */
    .listScroller{
      max-height: 520px; /* about 4x taller than the old 150-ish windows */
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .itemCard{
      background: rgba(15,23,42,0.92);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .itemLeft{
      display: flex;
      flex-direction: column;
      gap: 3px;
      flex: 1;
      min-width: 0;
    }

    .itemTitle{
      font-size: 13px;
      font-weight: 900;
      margin: 0;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .itemMeta{
      font-size: 11px;
      margin: 0;
      color: var(--textMuted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .itemRight{
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 0 0 auto;
    }

    .amount{
      font-size: 13px;
      font-weight: 900;
      white-space: nowrap;
    }

    .tag{
      font-size: 11px;
      font-weight: 900;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.03);
      white-space: nowrap;
    }

    .tagRed{
      border-color: rgba(251,113,133,0.35);
      background: rgba(251,113,133,0.10);
      color: var(--red);
    }

    .tagGreen{
      border-color: rgba(34,197,94,0.35);
      background: rgba(34,197,94,0.10);
      color: var(--greenSoft);
    }

    .tagBlue{
      border-color: rgba(96,165,250,0.35);
      background: rgba(96,165,250,0.10);
      color: #c7d2fe;
    }

    .footerActions{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      margin-top: 10px;
    }

    /* Modal */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: flex-end;
      justify-content: center;
      padding: 14px;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
      z-index: 999;
    }
    .modalOverlay.show{ display: flex; }

    .modal{
      width: 100%;
      max-width: 900px;
      background: var(--cardSoft);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
      transform: translateY(0);
    }

    .modalHead{
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(15,23,42,0.7);
    }

    .modalTitle{
      margin: 0;
      font-size: 14px;
      font-weight: 900;
    }

    .modalBody{
      padding: 14px;
    }

    .radioRow{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .radio{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      user-select: none;
      font-weight: 900;
      font-size: 12px;
      color: var(--text);
    }

    .radio input{ display: none; }

    .radio.active{
      border-color: rgba(96,165,250,0.50);
      background: rgba(96,165,250,0.10);
    }

    .note{
      font-size: 12px;
      color: var(--textSoft);
      margin-top: 10px;
      line-height: 1.35;
    }

    .hr{
      height: 1px;
      background: var(--stroke);
      margin: 12px 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Header -->
    <div class="card header">
      <div class="headerTop">
        <div class="titleBlock">
          <h1 class="title">22 Bishop Road Budget</h1>
          <p class="subtitle">Clear monthly view of income, direct debits and spending.</p>
        </div>
        <div class="appIcon" aria-label="App icon">
          <img src="icon-192.png" alt="App icon" />
        </div>
      </div>

      <div class="monthRow">
        <div class="pill" style="flex: 1;">
          <span class="pillLabel">Month</span>
          <span class="pillValue" id="monthLabel">—</span>
        </div>

        <button class="btn btnGhost btnTiny" id="prevMonthBtn" type="button">◀</button>
        <button class="btn btnGhost btnTiny" id="nextMonthBtn" type="button">▶</button>
      </div>
    </div>

    <!-- Dashboard Snapshot -->
    <div class="card section" id="dashboardCard">
      <div class="cardInner">
        <h2 class="sectionTitle">Dashboard Snapshot</h2>

        <div class="grid2">
          <div class="summaryPill">
            <div class="summaryTitle">Monthly income</div>
            <div class="summarySub">For this month</div>
            <div class="summaryVal" id="incomeTotal" style="color: var(--blueSoft);">£0.00</div>
          </div>

          <div class="summaryPill">
            <div class="summaryTitle">Direct Debits & Bills</div>
            <div class="summarySub">Mortgage, utilities, tax</div>
            <div class="summaryVal" id="ddTotal" style="color: var(--text);">£0.00</div>
          </div>

          <div class="summaryPill">
            <div class="summaryTitle">Other Spending</div>
            <div class="summarySub">Food, fuel, nights out</div>
            <div class="summaryVal" id="spendTotal" style="color: var(--red);">£0.00</div>
          </div>

          <div class="summaryPill" id="leftPill">
            <div class="summaryTitle">Left after Spending</div>
            <div class="summarySub">If you stopped today</div>
            <div class="summaryVal" id="leftAfterAll" style="color: var(--green);">£0.00</div>
          </div>
        </div>

        <!-- What-if -->
        <div class="whatif">
          <div class="whatifHead">
            <div class="soft" style="font-size: 12px; font-weight: 900;">What if this month changed by…</div>
            <button class="btn btnGhost btnTiny" id="resetWhatIfBtn" type="button">Reset</button>
          </div>
          <input class="slider" id="whatIfSlider" type="range" min="-500" max="500" step="10" value="0" />
          <div class="row" style="margin-top: 6px;">
            <div class="muted" id="whatIfChange" style="font-size: 12px;">Change: £0.00</div>
            <div id="whatIfAfter" style="font-size: 12px; font-weight: 900;">After change: £0.00</div>
          </div>
        </div>

        <!-- Donut / status / graph -->
        <div class="card section donutCard" id="donutCard" style="margin-top: 12px;">
          <div class="cardInner">
            <div class="donutRow">
              <div class="donutWrap">
                <canvas class="donutCanvas" id="donutCanvas" width="150" height="150"></canvas>
                <div class="donutText">
                  <p class="donutPct" id="donutPct">0%</p>
                  <p class="donutSub">income left</p>
                </div>
              </div>

              <div>
                <p class="statusTitle" id="statusTitle">Waiting for income</p>
                <p class="statusBody" id="statusBody">Add your salary for this month to see how much is left after direct debits and spending.</p>

                <div class="graph" aria-label="Mini line graph">
                  <canvas id="miniGraph" width="600" height="180"></canvas>
                </div>

                <p class="note" style="margin-top:10px;">
                  Tap this card for a full breakdown.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="footerActions">
          <button class="btn btnGhost" id="exportAllBtn" type="button">⬇ Export all data (CSV)</button>
          <button class="btn btnDanger" id="resetAllBtn" type="button">Reset app (wipe data)</button>
        </div>
      </div>
    </div>

    <!-- Add transaction -->
    <div class="card section">
      <div class="cardInner">
        <h2 class="sectionTitle">Add transaction (one-off)</h2>

        <div class="formGrid">
          <div class="field">
            <label for="txDate">Date</label>
            <input id="txDate" type="date" />
          </div>

          <div class="field">
            <label for="txType">Type</label>
            <select id="txType">
              <option value="income">Income</option>
              <option value="spend">Spending</option>
            </select>
          </div>

          <div class="field" style="grid-column: span 2;">
            <label for="txDesc">Description</label>
            <input id="txDesc" type="text" placeholder="RN salary, Tesco shop…" />
          </div>

          <div class="field" style="grid-column: span 2;">
            <label for="txAmt">Amount</label>
            <input id="txAmt" type="number" inputmode="decimal" placeholder="0.00" />
          </div>

          <div class="field" style="grid-column: span 2; border-color: rgba(255,255,255,0.14);">
            <div class="row" style="width:100%;">
              <div class="soft" style="font-size:12px; font-weight:900;">Quick add</div>
              <button class="btn btnTiny" id="addTxBtn" type="button">Add transaction</button>
            </div>
          </div>
        </div>

        <div class="listWindow" id="txListWrap">
          <div class="listScroller" id="txList"></div>
        </div>
      </div>
    </div>

    <!-- Direct Debits -->
    <div class="card section">
      <div class="cardInner">
        <h2 class="sectionTitle">Direct debits & regular bills</h2>

        <div class="formGrid">
          <div class="field" style="grid-column: span 2;">
            <label for="ddName">Name</label>
            <input id="ddName" type="text" placeholder="Mortgage, Council tax…" />
          </div>

          <div class="field">
            <label for="ddDay">Day</label>
            <input id="ddDay" type="number" inputmode="numeric" placeholder="1–31" />
          </div>

          <div class="field">
            <label for="ddAmt">Amount</label>
            <input id="ddAmt" type="number" inputmode="decimal" placeholder="0.00" />
          </div>

          <div class="field" style="grid-column: span 2;">
            <label for="ddCat">Category</label>
            <input id="ddCat" type="text" placeholder="(optional)" />
          </div>

          <div class="field" style="grid-column: span 2; border-color: rgba(255,255,255,0.14);">
            <div class="row" style="width:100%;">
              <div class="soft" style="font-size:12px; font-weight:900;">Add to this month</div>
              <button class="btn btnTiny" id="addDdBtn" type="button">Add direct debit</button>
            </div>
          </div>
        </div>

        <div class="listWindow">
          <div class="listScroller" id="ddList"></div>
        </div>

        <p class="note">
          Edits can apply just to this month (override) or from this month onwards (new version). Previous months won’t change.
        </p>
      </div>
    </div>

    <!-- Donut detail modal -->
    <div class="modalOverlay" id="donutModal">
      <div class="modal">
        <div class="modalHead">
          <h3 class="modalTitle">Monthly breakdown</h3>
          <button class="btn btnGhost btnTiny" id="closeDonutModal" type="button">Close</button>
        </div>
        <div class="modalBody">
          <div class="row" style="margin-bottom: 10px;">
            <div class="pill" style="flex: 1;">
              <span class="pillLabel">Month</span>
              <span class="pillValue" id="modalMonthLabel">—</span>
            </div>
            <div class="pill" style="flex: 1;">
              <span class="pillLabel">Carry in</span>
              <span class="pillValue" id="modalCarryIn">£0.00</span>
            </div>
          </div>

          <div class="row" style="gap: 12px; align-items: flex-start; flex-wrap: wrap;">
            <div style="flex: 0 0 auto;">
              <canvas id="bigDonut" width="240" height="240" style="border-radius: 18px; background: rgba(15,23,42,0.55); border:1px solid var(--stroke);"></canvas>
              <div style="margin-top: -172px; text-align:center; pointer-events:none;">
                <div style="font-size:34px; font-weight: 1000;" id="bigDonutPct">0%</div>
                <div style="font-size:11px; letter-spacing: 1px; text-transform: uppercase; color: var(--textSoft); margin-top:6px;">starting funds left</div>
              </div>
            </div>

            <div style="flex: 1; min-width: 240px;">
              <div class="summaryPill" style="min-height: unset;">
                <div class="row"><div class="soft" style="font-weight:900;">Started with</div><div id="bkStart" style="font-weight: 1000;">£0.00</div></div>
                <div class="row"><div class="soft" style="font-weight:900;">Income</div><div id="bkIncome" style="font-weight: 1000;">£0.00</div></div>
                <div class="row"><div class="soft" style="font-weight:900;">Direct Debits</div><div id="bkDD" style="font-weight: 1000;">£0.00</div></div>
                <div class="row"><div class="soft" style="font-weight:900;">Spending</div><div id="bkSpend" style="font-weight: 1000;">£0.00</div></div>
                <div class="hr"></div>
                <div class="row"><div style="font-weight:1000;">Left after everything</div><div id="bkLeft" style="font-weight:1000;">£0.00</div></div>
              </div>

              <div class="note" style="margin-top: 10px;">
                Tip: Edit a direct debit in the month you’re looking at, then choose “This month only” or “From this month onwards”.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Transaction edit modal -->
    <div class="modalOverlay" id="txModal">
      <div class="modal">
        <div class="modalHead">
          <h3 class="modalTitle">Edit transaction</h3>
          <button class="btn btnGhost btnTiny" id="closeTxModal" type="button">Close</button>
        </div>
        <div class="modalBody">
          <div class="formGrid">
            <div class="field">
              <label>Date</label>
              <input id="editTxDate" type="date" />
            </div>

            <div class="field">
              <label>Type</label>
              <select id="editTxType">
                <option value="income">Income</option>
                <option value="spend">Spending</option>
              </select>
            </div>

            <div class="field" style="grid-column: span 2;">
              <label>Description</label>
              <input id="editTxDesc" type="text" />
            </div>

            <div class="field" style="grid-column: span 2;">
              <label>Amount</label>
              <input id="editTxAmt" type="number" inputmode="decimal" />
            </div>
          </div>

          <div class="formActions">
            <button class="btn" id="saveTxBtn" type="button">Save</button>
            <button class="btn btnDanger" id="deleteTxBtn" type="button">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Direct debit edit modal -->
    <div class="modalOverlay" id="ddModal">
      <div class="modal">
        <div class="modalHead">
          <h3 class="modalTitle">Edit direct debit</h3>
          <button class="btn btnGhost btnTiny" id="closeDdModal" type="button">Close</button>
        </div>
        <div class="modalBody">
          <div class="formGrid">
            <div class="field" style="grid-column: span 2;">
              <label>Name</label>
              <input id="editDdName" type="text" />
            </div>

            <div class="field">
              <label>Day</label>
              <input id="editDdDay" type="number" inputmode="numeric" />
            </div>

            <div class="field">
              <label>Amount</label>
              <input id="editDdAmt" type="number" inputmode="decimal" />
            </div>

            <div class="field" style="grid-column: span 2;">
              <label>Category</label>
              <input id="editDdCat" type="text" />
            </div>

            <div class="field" style="grid-column: span 2; border-color: rgba(251,146,60,0.35);">
              <div class="row" style="width:100%;">
                <div style="font-weight:1000; font-size:12px;">Paused</div>
                <input id="editDdPaused" type="checkbox" style="transform: scale(1.2);" />
              </div>
            </div>
          </div>

          <div class="radioRow" style="margin-top: 12px;">
            <div class="radio active" id="scopeThisMonth">
              <input type="radio" name="ddScope" value="this" checked />
              This month only
            </div>
            <div class="radio" id="scopeFromMonth">
              <input type="radio" name="ddScope" value="from" />
              From this month onwards
            </div>
          </div>

          <div class="note">
            “This month only” creates a one-month override. “From this month onwards” creates a new version starting this month and ends the previous version the month before.
          </div>

          <div class="formActions" style="margin-top: 12px;">
            <button class="btn" id="saveDdBtn" type="button">Save</button>
            <button class="btn btnDanger" id="deleteDdBtn" type="button">Delete (series)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * Storage + Models
     **********************/
    const STORAGE_KEY = "BishopBudget_HTML_v2";

    // New model:
    // data = {
    //   transactions: [{id, dateISO, description, amount, type}],
    //   ddSeries: [{id, name, category, periods: [{id, startMonth, endMonth|null, day, amount, paused}]}]
    // }
    //
    // month key format: "YYYY-MM"
    // transaction date: "YYYY-MM-DD"

    function uid(){
      return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    }

    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){
        return { transactions: [], ddSeries: [] };
      }
      try{
        const parsed = JSON.parse(raw);

        // MIGRATION SAFETY: if older shape exists, keep it simple and best-effort.
        // If someone had directDebits as a flat array with day/amount/active, we convert into series with one period.
        if(parsed && !parsed.ddSeries && Array.isArray(parsed.directDebits)){
          const series = parsed.directDebits.map(dd => ({
            id: dd.id || uid(),
            name: dd.name || "Direct Debit",
            category: dd.category || "",
            periods: [{
              id: uid(),
              startMonth: dd.monthKey || firstMonthKeyFromAnything(parsed) || monthKey(today()),
              endMonth: null,
              day: Number(dd.day || 1),
              amount: Number(dd.amount || 0),
              paused: dd.active === false
            }]
          }));
          const migrated = {
            transactions: Array.isArray(parsed.transactions) ? parsed.transactions.map(t => ({
              id: t.id || uid(),
              dateISO: (t.dateISO || t.date || toISODate(today())),
              description: t.description || "",
              amount: Number(t.amount || 0),
              type: t.type || "spend"
            })) : [],
            ddSeries: series
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
          return migrated;
        }

        // If looks already correct:
        if(parsed && Array.isArray(parsed.transactions) && Array.isArray(parsed.ddSeries)){
          // Normalise
          parsed.transactions = parsed.transactions.map(t => ({
            id: t.id || uid(),
            dateISO: (t.dateISO || toISODate(today())),
            description: t.description || "",
            amount: Number(t.amount || 0),
            type: t.type === "income" ? "income" : "spend"
          }));
          parsed.ddSeries = parsed.ddSeries.map(s => ({
            id: s.id || uid(),
            name: s.name || "Direct Debit",
            category: s.category || "",
            periods: Array.isArray(s.periods) ? s.periods.map(p => ({
              id: p.id || uid(),
              startMonth: p.startMonth || monthKey(today()),
              endMonth: p.endMonth ?? null,
              day: Number(p.day || 1),
              amount: Number(p.amount || 0),
              paused: !!p.paused
            })) : []
          }));
          return parsed;
        }

        return { transactions: [], ddSeries: [] };
      }catch(e){
        return { transactions: [], ddSeries: [] };
      }
    }

    function saveData(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
    }

    function firstMonthKeyFromAnything(parsed){
      const months = [];
      if(Array.isArray(parsed.transactions)){
        parsed.transactions.forEach(t=>{
          const d = (t.dateISO || t.date);
          if(typeof d === "string" && d.length >= 7) months.push(d.slice(0,7));
        });
      }
      if(Array.isArray(parsed.directDebits)){
        parsed.directDebits.forEach(dd=>{
          if(dd.monthKey) months.push(dd.monthKey);
        });
      }
      months.sort();
      return months[0] || null;
    }

    /**********************
     * Date helpers
     **********************/
    function pad2(n){ return String(n).padStart(2,"0"); }

    function toISODate(d){
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const day = pad2(d.getDate());
      return `${y}-${m}-${day}`;
    }

    function monthKey(d){
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      return `${y}-${m}`;
    }

    function parseMonthKey(mk){
      const [y,m] = mk.split("-").map(Number);
      return new Date(y, (m-1), 1);
    }

    function addMonths(mk, delta){
      const d = parseMonthKey(mk);
      d.setMonth(d.getMonth()+delta);
      return monthKey(d);
    }

    function compareMonthKey(a,b){
      // a,b "YYYY-MM"
      if(a===b) return 0;
      return a < b ? -1 : 1;
    }

    function monthLabel(mk){
      // "MMM-YY"
      const d = parseMonthKey(mk);
      const fmt = new Intl.DateTimeFormat("en-GB",{ month:"short", year:"2-digit" });
      // fmt gives "Dec 25" -> convert to "Dec-25"
      const parts = fmt.format(d).replace(" ","-");
      return parts;
    }

    function shortDateLabel(iso){
      // "DD-Mmm-YY"
      const d = new Date(iso+"T00:00:00");
      const day = pad2(d.getDate());
      const mon = new Intl.DateTimeFormat("en-GB",{ month:"short" }).format(d);
      const yr = String(d.getFullYear()).slice(2);
      return `${day}-${mon}-${yr}`;
    }

    function daysInMonth(mk){
      const d = parseMonthKey(mk);
      const y = d.getFullYear();
      const m = d.getMonth();
      return new Date(y, m+1, 0).getDate();
    }

    function prevMonth(mk){
      return addMonths(mk, -1);
    }

    function today(){
      return new Date();
    }

    /**********************
     * Money helpers
     **********************/
    function money(n){
      const v = Number(n || 0);
      return v.toLocaleString("en-GB",{ style:"currency", currency:"GBP", minimumFractionDigits:2, maximumFractionDigits:2 });
    }

    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    /**********************
     * Direct Debits logic (versioned)
     **********************/
    function seriesApplicablePeriod(series, mk){
      // find the period where startMonth <= mk <= endMonth (or endMonth null)
      const periods = (series.periods || []).slice().sort((a,b)=> (a.startMonth < b.startMonth ? -1 : 1));
      for(const p of periods){
        const startOk = compareMonthKey(p.startMonth, mk) <= 0;
        const endOk = (p.endMonth == null) ? true : (compareMonthKey(mk, p.endMonth) <= 0);
        if(startOk && endOk) return p;
      }
      return null;
    }

    function listDirectDebitsForMonth(mk){
      const rows = [];
      for(const s of state.data.ddSeries){
        const p = seriesApplicablePeriod(s, mk);
        if(!p) continue;
        rows.push({
          seriesId: s.id,
          seriesName: s.name,
          seriesCategory: s.category || "",
          periodId: p.id,
          startMonth: p.startMonth,
          endMonth: p.endMonth,
          day: Number(p.day||1),
          amount: Number(p.amount||0),
          paused: !!p.paused
        });
      }
      rows.sort((a,b)=> (a.day - b.day) || a.seriesName.localeCompare(b.seriesName));
      return rows;
    }

    function ddTotalForMonth(mk){
      const dds = listDirectDebitsForMonth(mk);
      return dds.filter(x=>!x.paused).reduce((sum,x)=> sum + x.amount, 0);
    }

    /**********************
     * Transactions logic
     **********************/
    function transactionsForMonth(mk){
      return state.data.transactions
        .filter(t => (t.dateISO || "").slice(0,7) === mk)
        .slice()
        .sort((a,b)=> (a.dateISO < b.dateISO ? -1 : 1));
    }

    function incomeTotalForMonth(mk){
      return transactionsForMonth(mk).filter(t=>t.type==="income").reduce((s,t)=> s + Number(t.amount||0), 0);
    }

    function spendTotalForMonth(mk){
      return transactionsForMonth(mk).filter(t=>t.type==="spend").reduce((s,t)=> s + Number(t.amount||0), 0);
    }

    /**********************
     * Carry-forward + month maths (robust)
     **********************/
    function allMonthKeysInData(){
      const set = new Set();
      state.data.transactions.forEach(t=>{
        if(t.dateISO && t.dateISO.length >= 7) set.add(t.dateISO.slice(0,7));
      });
      state.data.ddSeries.forEach(s=>{
        (s.periods||[]).forEach(p=>{
          if(p.startMonth) set.add(p.startMonth);
          if(p.endMonth) set.add(p.endMonth);
        });
      });
      return Array.from(set).sort();
    }

    function earliestMonthKey(){
      const all = allMonthKeysInData();
      return all.length ? all[0] : state.selectedMonth;
    }

    function computeMonthSummary(mk, memo){
      if(memo[mk]) return memo[mk];

      const first = earliestMonthKey();

      let carryIn = 0;
      if(compareMonthKey(mk, first) > 0){
        const pm = prevMonth(mk);
        const prevSum = computeMonthSummary(pm, memo);
        carryIn = prevSum.leftAfterAll;
      }

      const income = incomeTotalForMonth(mk);
      const dd = ddTotalForMonth(mk);
      const spend = spendTotalForMonth(mk);

      const startedWith = carryIn + income;
      const leftAfterAll = startedWith - dd - spend;

      const res = { mk, carryIn, income, dd, spend, startedWith, leftAfterAll };
      memo[mk] = res;
      return res;
    }

    function monthSummary(mk){
      const memo = {};
      return computeMonthSummary(mk, memo);
    }

    /**********************
     * Donut + graph
     **********************/
    function drawDonut(canvas, percent){
      const ctx = canvas.getContext("2d");
      const w = canvas.width, h = canvas.height;
      const cx = w/2, cy = h/2;
      const r = Math.min(w,h)/2 - 10;

      ctx.clearRect(0,0,w,h);

      // base ring
      ctx.beginPath();
      ctx.arc(cx,cy,r,0,Math.PI*2);
      ctx.strokeStyle = "rgba(31,41,55,0.9)";
      ctx.lineWidth = 16;
      ctx.lineCap = "round";
      ctx.stroke();

      const p = clamp(percent, 0, 100) / 100;
      const start = -Math.PI/2;
      const end = start + (Math.PI*2 * p);

      // gradient arc
      const grad = ctx.createLinearGradient(0,0,w,h);
      grad.addColorStop(0, "#60a5fa");
      grad.addColorStop(0.55, "#22c55e");
      grad.addColorStop(1, "#06b6d4");

      ctx.beginPath();
      ctx.arc(cx,cy,r,start,end);
      ctx.strokeStyle = grad;
      ctx.lineWidth = 16;
      ctx.lineCap = "round";
      ctx.stroke();
    }

    function drawLineGraph(canvas, mk, whatIfOffset){
      const ctx = canvas.getContext("2d");
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);

      const sum = monthSummary(mk);
      const days = daysInMonth(mk);

      // Build daily values
      const txs = transactionsForMonth(mk);
      const dds = listDirectDebitsForMonth(mk);

      // Spending by day
      const spendByDay = new Array(days).fill(0);
      for(const t of txs){
        if(t.type !== "spend") continue;
        const day = Number(t.dateISO.slice(8,10));
        if(day>=1 && day<=days) spendByDay[day-1] += Number(t.amount||0);
      }

      // DDs by day (only non-paused)
      const ddByDay = new Array(days).fill(0);
      for(const dd of dds){
        if(dd.paused) continue;
        const d = clamp(Number(dd.day||1), 1, days);
        ddByDay[d-1] += Number(dd.amount||0);
      }

      // Start with startedWith, apply whatIf linearly across month (to match your original feel)
      const baseStart = sum.startedWith;
      const values = [];
      let running = baseStart;

      for(let i=0;i<days;i++){
        const factor = (i+1)/days;
        const adjustedStart = baseStart - (whatIfOffset * factor);
        if(i===0){
          running = adjustedStart;
        }else{
          // drift from prior day's running to new adjustedStart baseline smoothly:
          // Keep it simple: set running = adjustedStart - (spent so far)
          // We'll compute from scratch each day for stability:
        }

        // compute from scratch to avoid drift
        let cur = baseStart - (whatIfOffset * factor);
        let spendSoFar = 0, ddSoFar = 0;
        for(let j=0;j<=i;j++){
          spendSoFar += spendByDay[j];
          ddSoFar += ddByDay[j];
        }
        cur = cur - spendSoFar - ddSoFar;
        values.push(cur);
      }

      if(values.length < 2){
        // draw axis anyway
        ctx.strokeStyle = "rgba(255,255,255,0.18)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(10, H-18);
        ctx.lineTo(W-10, H-18);
        ctx.stroke();
        return;
      }

      // allow negative Y
      const minV = Math.min(...values);
      const maxV = Math.max(...values);
      const range = Math.max(1, maxV - minV);

      // padding
      const left = 10, right = 10, top = 10, bottom = 18;
      const plotW = W - left - right;
      const plotH = H - top - bottom;

      // x-axis at y=0 if within range, else bottom
      let axisY;
      if(minV <= 0 && maxV >= 0){
        axisY = top + plotH * (maxV / range);
      }else{
        axisY = top + plotH;
      }

      // x-axis visible
      ctx.strokeStyle = "rgba(255,255,255,0.22)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(left, axisY);
      ctx.lineTo(left + plotW, axisY);
      ctx.stroke();

      // line
      const grad = ctx.createLinearGradient(0,0,W,0);
      grad.addColorStop(0, "#60a5fa");
      grad.addColorStop(0.6, "#22c55e");
      grad.addColorStop(1, "#06b6d4");

      ctx.strokeStyle = grad;
      ctx.lineWidth = 3;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";

      ctx.beginPath();
      for(let i=0;i<values.length;i++){
        const x = left + (plotW * (i/(values.length-1)));
        const y = top + plotH * ((maxV - values[i]) / range);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    /**********************
     * UI State
     **********************/
    const state = {
      data: loadData(),
      selectedMonth: monthKey(today()),
      whatIfOffset: 0,

      // modal editing
      editingTxId: null,
      editingDd: null, // {seriesId, periodId} for the month view
      ddEditScope: "this"
    };

    /**********************
     * DOM refs
     **********************/
    const el = {
      monthLabel: document.getElementById("monthLabel"),
      prevMonthBtn: document.getElementById("prevMonthBtn"),
      nextMonthBtn: document.getElementById("nextMonthBtn"),

      incomeTotal: document.getElementById("incomeTotal"),
      ddTotal: document.getElementById("ddTotal"),
      spendTotal: document.getElementById("spendTotal"),
      leftAfterAll: document.getElementById("leftAfterAll"),
      leftPill: document.getElementById("leftPill"),

      whatIfSlider: document.getElementById("whatIfSlider"),
      whatIfChange: document.getElementById("whatIfChange"),
      whatIfAfter: document.getElementById("whatIfAfter"),
      resetWhatIfBtn: document.getElementById("resetWhatIfBtn"),

      donutCanvas: document.getElementById("donutCanvas"),
      donutPct: document.getElementById("donutPct"),
      statusTitle: document.getElementById("statusTitle"),
      statusBody: document.getElementById("statusBody"),
      miniGraph: document.getElementById("miniGraph"),

      // transaction add
      txDate: document.getElementById("txDate"),
      txType: document.getElementById("txType"),
      txDesc: document.getElementById("txDesc"),
      txAmt: document.getElementById("txAmt"),
      addTxBtn: document.getElementById("addTxBtn"),
      txList: document.getElementById("txList"),

      // dd add
      ddName: document.getElementById("ddName"),
      ddDay: document.getElementById("ddDay"),
      ddAmt: document.getElementById("ddAmt"),
      ddCat: document.getElementById("ddCat"),
      addDdBtn: document.getElementById("addDdBtn"),
      ddList: document.getElementById("ddList"),

      // export/reset
      exportAllBtn: document.getElementById("exportAllBtn"),
      resetAllBtn: document.getElementById("resetAllBtn"),

      // donut modal
      donutCard: document.getElementById("donutCard"),
      donutModal: document.getElementById("donutModal"),
      closeDonutModal: document.getElementById("closeDonutModal"),
      modalMonthLabel: document.getElementById("modalMonthLabel"),
      modalCarryIn: document.getElementById("modalCarryIn"),
      bigDonut: document.getElementById("bigDonut"),
      bigDonutPct: document.getElementById("bigDonutPct"),
      bkStart: document.getElementById("bkStart"),
      bkIncome: document.getElementById("bkIncome"),
      bkDD: document.getElementById("bkDD"),
      bkSpend: document.getElementById("bkSpend"),
      bkLeft: document.getElementById("bkLeft"),

      // tx modal
      txModal: document.getElementById("txModal"),
      closeTxModal: document.getElementById("closeTxModal"),
      editTxDate: document.getElementById("editTxDate"),
      editTxType: document.getElementById("editTxType"),
      editTxDesc: document.getElementById("editTxDesc"),
      editTxAmt: document.getElementById("editTxAmt"),
      saveTxBtn: document.getElementById("saveTxBtn"),
      deleteTxBtn: document.getElementById("deleteTxBtn"),

      // dd modal
      ddModal: document.getElementById("ddModal"),
      closeDdModal: document.getElementById("closeDdModal"),
      editDdName: document.getElementById("editDdName"),
      editDdDay: document.getElementById("editDdDay"),
      editDdAmt: document.getElementById("editDdAmt"),
      editDdCat: document.getElementById("editDdCat"),
      editDdPaused: document.getElementById("editDdPaused"),
      scopeThisMonth: document.getElementById("scopeThisMonth"),
      scopeFromMonth: document.getElementById("scopeFromMonth"),
      saveDdBtn: document.getElementById("saveDdBtn"),
      deleteDdBtn: document.getElementById("deleteDdBtn"),
    };

    /**********************
     * Render
     **********************/
    function refresh(){
      saveData();

      el.monthLabel.textContent = monthLabel(state.selectedMonth);

      // Set tx date default to today but keep user's if already set
      if(!el.txDate.value){
        el.txDate.value = toISODate(today());
      }

      // Month summary
      const sum = monthSummary(state.selectedMonth);
      const dd = sum.dd;
      const income = sum.income;
      const spend = sum.spend;

      // Apply what-if
      const whatIf = Number(state.whatIfOffset || 0);
      const leftAfter = sum.leftAfterAll - whatIf;
      const startedWith = sum.startedWith;

      el.incomeTotal.textContent = money(income);
      el.ddTotal.textContent = money(dd);
      el.spendTotal.textContent = money(spend);
      el.leftAfterAll.textContent = money(leftAfter);

      // left pill coloring
      const leftVal = leftAfter;
      if(leftVal > 0){
        el.leftAfterAll.style.color = "var(--green)";
        el.leftPill.style.background = "rgba(34,197,94,0.12)";
      }else if(leftVal === 0){
        el.leftAfterAll.style.color = "var(--amber)";
        el.leftPill.style.background = "rgba(251,146,60,0.12)";
      }else{
        el.leftAfterAll.style.color = "var(--red)";
        el.leftPill.style.background = "rgba(251,113,133,0.12)";
      }

      // Donut percent (based on startedWith)
      const base = Math.max(0.0001, startedWith);
      const pctLeft = clamp((leftAfter / base) * 100, -9999, 9999);

      el.donutPct.textContent = `${Math.round(pctLeft)}%`;

      // status text
      if(startedWith <= 0.0001){
        el.statusTitle.textContent = "Waiting for income";
        el.statusTitle.style.color = "var(--text)";
        el.statusBody.textContent = "Add your salary for this month to see how much is left after direct debits and spending.";
      }else{
        if(leftAfter > 0){
          el.statusTitle.textContent = "You’re in the green";
          el.statusTitle.style.color = "var(--greenSoft)";
          el.statusBody.textContent = `${money(leftAfter)} left after this month’s direct debits and spending.`;
        }else if(leftAfter === 0){
          el.statusTitle.textContent = "Every pound is allocated";
          el.statusTitle.style.color = "var(--text)";
          el.statusBody.textContent = "You’ve used 100% of this month’s starting funds.";
        }else{
          el.statusTitle.textContent = "Spending over income";
          el.statusTitle.style.color = "var(--red)";
          el.statusBody.textContent = `Over by ${money(Math.abs(leftAfter))} this month.`;
        }
      }

      // Donut visuals: use percent clamped to [0..100] for ring
      drawDonut(el.donutCanvas, clamp(pctLeft, 0, 100));

      // Graph
      drawLineGraph(el.miniGraph, state.selectedMonth, whatIf);

      // What-if slider range
      const maxDelta = Math.max(500, Math.ceil(startedWith));
      el.whatIfSlider.min = String(-maxDelta);
      el.whatIfSlider.max = String(maxDelta);
      el.whatIfSlider.value = String(state.whatIfOffset);

      const absChange = Math.abs(whatIf);
      const sign = whatIf === 0 ? "" : (whatIf > 0 ? "+" : "−");
      el.whatIfChange.textContent = `Change: ${sign}${money(absChange)}`;
      el.whatIfAfter.textContent = `After change: ${money(leftAfter)}`;

      // Lists
      renderTransactions();
      renderDirectDebits();
    }

    function renderTransactions(){
      const txs = transactionsForMonth(state.selectedMonth);

      el.txList.innerHTML = "";
      if(txs.length === 0){
        el.txList.innerHTML = `<div class="note" style="padding: 8px;">No transactions yet. Add income and spending above.</div>`;
        return;
      }

      for(const tx of txs){
        const amtColor = tx.type === "income" ? "var(--green)" : "var(--red)";
        const typeLabel = tx.type === "income" ? "Income" : "Spending";

        const card = document.createElement("div");
        card.className = "itemCard";

        card.innerHTML = `
          <div class="itemLeft">
            <p class="itemTitle">${escapeHtml(tx.description || "(no description)")}</p>
            <p class="itemMeta">${shortDateLabel(tx.dateISO)} · ${typeLabel}</p>
          </div>
          <div class="itemRight">
            <div class="amount" style="color:${amtColor};">${money(tx.amount)}</div>
            <button class="btn btnGhost btnTiny" type="button" data-edit-tx="${tx.id}" style="position: relative; top: -1px;">Edit</button>
          </div>
        `;

        el.txList.appendChild(card);
      }

      // bind edit
      el.txList.querySelectorAll("[data-edit-tx]").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          const id = e.currentTarget.getAttribute("data-edit-tx");
          openTxModal(id);
        });
      });
    }

    function renderDirectDebits(){
      const rows = listDirectDebitsForMonth(state.selectedMonth);
      el.ddList.innerHTML = "";

      if(rows.length === 0){
        el.ddList.innerHTML = `<div class="note" style="padding: 8px;">No direct debits yet. Start with mortgage, council tax and utilities.</div>`;
        return;
      }

      for(const dd of rows){
        const tagClass = dd.paused ? "tagRed" : "tagGreen";
        const tagText = dd.paused ? "Paused" : "Active";

        const metaBits = [
          `${money(dd.amount)} · day ${dd.day}`,
          dd.seriesCategory ? dd.seriesCategory : ""
        ].filter(Boolean).join(" · ");

        const card = document.createElement("div");
        card.className = "itemCard";
        if(dd.paused){
          card.style.opacity = "0.92";
        }

        card.innerHTML = `
          <div class="itemLeft">
            <p class="itemTitle">${escapeHtml(dd.seriesName)}</p>
            <p class="itemMeta">${escapeHtml(metaBits)}</p>
          </div>
          <div class="itemRight">
            <div class="tag ${tagClass}">${tagText}</div>
            <button class="btn btnGhost btnTiny" type="button" data-edit-dd="${dd.seriesId}">Edit</button>
          </div>
        `;

        el.ddList.appendChild(card);
      }

      el.ddList.querySelectorAll("[data-edit-dd]").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          const seriesId = e.currentTarget.getAttribute("data-edit-dd");
          openDdModal(seriesId);
        });
      });
    }

    /**********************
     * Add transaction / DD
     **********************/
    function blurKeyboard(){
      if(document.activeElement && typeof document.activeElement.blur === "function"){
        document.activeElement.blur();
      }
    }

    function addTransaction(){
      const dateISO = el.txDate.value || toISODate(today());
      const type = el.txType.value === "income" ? "income" : "spend";
      const desc = (el.txDesc.value || "").trim();
      const amt = Number(String(el.txAmt.value || "").replace(",", "."));

      if(!desc) return alert("Please enter a description.");
      if(!Number.isFinite(amt) || amt <= 0) return alert("Please enter a valid amount.");

      state.data.transactions.push({
        id: uid(),
        dateISO,
        description: desc,
        amount: amt,
        type
      });

      el.txDesc.value = "";
      el.txAmt.value = "";
      el.txType.value = "income";
      el.txDate.value = toISODate(today());

      blurKeyboard();
      refresh();
    }

    function addDirectDebit(){
      const name = (el.ddName.value || "").trim();
      const day = Number(el.ddDay.value || 0);
      const amt = Number(String(el.ddAmt.value || "").replace(",", "."));
      const cat = (el.ddCat.value || "").trim();

      if(!name) return alert("Please enter a name.");
      if(!Number.isFinite(day) || day < 1 || day > 31) return alert("Please enter a valid day (1–31).");
      if(!Number.isFinite(amt) || amt <= 0) return alert("Please enter a valid amount.");

      const series = {
        id: uid(),
        name,
        category: cat,
        periods: [{
          id: uid(),
          startMonth: state.selectedMonth,
          endMonth: null,
          day,
          amount: amt,
          paused: false
        }]
      };

      state.data.ddSeries.push(series);

      el.ddName.value = "";
      el.ddDay.value = "";
      el.ddAmt.value = "";
      el.ddCat.value = "";

      blurKeyboard();
      refresh();
    }

    /**********************
     * Transaction modal
     **********************/
    function openTxModal(id){
      const tx = state.data.transactions.find(t=>t.id===id);
      if(!tx) return;

      state.editingTxId = id;

      el.editTxDate.value = tx.dateISO;
      el.editTxType.value = tx.type;
      el.editTxDesc.value = tx.description;
      el.editTxAmt.value = String(tx.amount);

      el.txModal.classList.add("show");
    }

    function closeTxModal(){
      state.editingTxId = null;
      el.txModal.classList.remove("show");
      blurKeyboard();
    }

    function saveTx(){
      const id = state.editingTxId;
      const tx = state.data.transactions.find(t=>t.id===id);
      if(!tx) return;

      const dateISO = el.editTxDate.value || tx.dateISO;
      const type = el.editTxType.value === "income" ? "income" : "spend";
      const desc = (el.editTxDesc.value || "").trim();
      const amt = Number(String(el.editTxAmt.value || "").replace(",", "."));

      if(!desc) return alert("Please enter a description.");
      if(!Number.isFinite(amt) || amt <= 0) return alert("Please enter a valid amount.");

      tx.dateISO = dateISO;
      tx.type = type;
      tx.description = desc;
      tx.amount = amt;

      closeTxModal();
      refresh();
    }

    function deleteTx(){
      const id = state.editingTxId;
      const idx = state.data.transactions.findIndex(t=>t.id===id);
      if(idx < 0) return;

      if(!confirm("Delete this transaction?")) return;
      state.data.transactions.splice(idx,1);

      closeTxModal();
      refresh();
    }

    /**********************
     * Direct Debit modal (versioned edits)
     **********************/
    function setScope(scope){
      state.ddEditScope = scope;
      if(scope === "this"){
        el.scopeThisMonth.classList.add("active");
        el.scopeFromMonth.classList.remove("active");
      }else{
        el.scopeThisMonth.classList.remove("active");
        el.scopeFromMonth.classList.add("active");
      }
    }

    function openDdModal(seriesId){
      const series = state.data.ddSeries.find(s=>s.id===seriesId);
      if(!series) return;

      // find applicable period for this month
      const period = seriesApplicablePeriod(series, state.selectedMonth);
      if(!period){
        // if none applies, treat as can't edit in this month
        alert("No active version for this direct debit in the selected month.");
        return;
      }

      state.editingDd = { seriesId, periodId: period.id };

      el.editDdName.value = series.name;
      el.editDdCat.value = series.category || "";
      el.editDdDay.value = String(period.day);
      el.editDdAmt.value = String(period.amount);
      el.editDdPaused.checked = !!period.paused;

      // default scope = from this month onwards (usually what you want for changes)
      setScope("from");

      el.ddModal.classList.add("show");
    }

    function closeDdModal(){
      state.editingDd = null;
      el.ddModal.classList.remove("show");
      blurKeyboard();
    }

    function saveDd(){
      const edit = state.editingDd;
      if(!edit) return;

      const series = state.data.ddSeries.find(s=>s.id===edit.seriesId);
      if(!series) return;

      const currentPeriod = seriesApplicablePeriod(series, state.selectedMonth);
      if(!currentPeriod) return;

      const newName = (el.editDdName.value || "").trim();
      const newCat = (el.editDdCat.value || "").trim();
      const newDay = Number(el.editDdDay.value || 0);
      const newAmt = Number(String(el.editDdAmt.value || "").replace(",", "."));
      const newPaused = !!el.editDdPaused.checked;

      if(!newName) return alert("Please enter a name.");
      if(!Number.isFinite(newDay) || newDay < 1 || newDay > 31) return alert("Please enter a valid day (1–31).");
      if(!Number.isFinite(newAmt) || newAmt <= 0) return alert("Please enter a valid amount.");

      // Always update series name/category (harmless)
      series.name = newName;
      series.category = newCat;

      const mk = state.selectedMonth;

      if(state.ddEditScope === "this"){
        // Create or update a one-month override period for mk:
        // If there is already a period that is exactly mk..mk, update it.
        let override = series.periods.find(p=>p.startMonth===mk && p.endMonth===mk);
        if(!override){
          override = {
            id: uid(),
            startMonth: mk,
            endMonth: mk,
            day: newDay,
            amount: newAmt,
            paused: newPaused
          };
          series.periods.push(override);
        }else{
          override.day = newDay;
          override.amount = newAmt;
          override.paused = newPaused;
        }
      }else{
        // From this month onwards:
        // 1) Find the period currently applying to this month (could be open ended).
        // 2) End it the month before mk (if it started before mk).
        // 3) Create a new period starting at mk, ending where old one ended.
        const applying = currentPeriod;

        const oldEnd = applying.endMonth ?? null;

        // If applying already starts this month, just update it.
        if(applying.startMonth === mk){
          applying.day = newDay;
          applying.amount = newAmt;
          applying.paused = newPaused;
        }else{
          // End old period at previous month
          const endOldAt = prevMonth(mk);
          applying.endMonth = endOldAt;

          // New period continues onwards (inherits old end)
          series.periods.push({
            id: uid(),
            startMonth: mk,
            endMonth: oldEnd,
            day: newDay,
            amount: newAmt,
            paused: newPaused
          });
        }
      }

      closeDdModal();
      refresh();
    }

    function deleteDdSeries(){
      const edit = state.editingDd;
      if(!edit) return;

      const idx = state.data.ddSeries.findIndex(s=>s.id===edit.seriesId);
      if(idx < 0) return;

      if(!confirm("Delete this direct debit series entirely? (This removes it from ALL months.)")) return;

      state.data.ddSeries.splice(idx,1);
      closeDdModal();
      refresh();
    }

    /**********************
     * Donut modal
     **********************/
    function openDonutModal(){
      const sum = monthSummary(state.selectedMonth);

      el.modalMonthLabel.textContent = monthLabel(state.selectedMonth);
      el.modalCarryIn.textContent = money(sum.carryIn);

      const whatIf = Number(state.whatIfOffset||0);
      const left = sum.leftAfterAll - whatIf;
      const started = sum.startedWith;

      el.bkStart.textContent = money(started);
      el.bkIncome.textContent = money(sum.income);
      el.bkDD.textContent = money(sum.dd);
      el.bkSpend.textContent = money(sum.spend);
      el.bkLeft.textContent = money(left);
      el.bkLeft.style.color = left >= 0 ? "var(--green)" : "var(--red)";

      const base = Math.max(0.0001, started);
      const pctLeft = clamp((left / base) * 100, -9999, 9999);
      el.bigDonutPct.textContent = `${Math.round(pctLeft)}%`;

      drawDonut(el.bigDonut, clamp(pctLeft, 0, 100));

      el.donutModal.classList.add("show");
    }

    function closeDonutModal(){
      el.donutModal.classList.remove("show");
    }

    /**********************
     * Export / Reset
     **********************/
    function exportAllCSV(){
      // One CSV with a RecordType column so Excel can filter/pivot easily.
      // Transactions + Direct Debit Periods (versioned).
      const lines = [];
      lines.push([
        "RecordType",
        "MonthKey",
        "Date",
        "Type",
        "Description",
        "Amount",
        "DD_SeriesId",
        "DD_Name",
        "DD_Category",
        "DD_DayOfMonth",
        "DD_PeriodStartMonth",
        "DD_PeriodEndMonth",
        "DD_Paused"
      ].join(","));

      // Transactions
      for(const tx of state.data.transactions){
        const mk = (tx.dateISO || "").slice(0,7);
        lines.push(csvRow([
          "Transaction",
          mk,
          tx.dateISO || "",
          tx.type || "",
          tx.description || "",
          num2(tx.amount),
          "",
          "",
          "",
          "",
          "",
          "",
          ""
        ]));
      }

      // DD periods
      for(const s of state.data.ddSeries){
        for(const p of (s.periods||[])){
          // For DD periods, MonthKey is the startMonth (useful for sorting); date blank
          lines.push(csvRow([
            "DirectDebitPeriod",
            p.startMonth || "",
            "",
            "",
            "",
            num2(p.amount),
            s.id,
            s.name || "",
            s.category || "",
            p.day,
            p.startMonth || "",
            (p.endMonth ?? ""),
            p.paused ? "Yes" : "No"
          ]));
        }
      }

      const csv = lines.join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });

      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "BishopBudget-Master.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    }

    function csvRow(arr){
      return arr.map(v=>{
        const s = String(v ?? "");
        const escaped = s.replaceAll('"', '""');
        return `"${escaped}"`;
      }).join(",");
    }

    function num2(n){
      const v = Number(n || 0);
      return v.toFixed(2);
    }

    function resetAll(){
      if(!confirm("This will wipe ALL budget data from this device/browser. Continue?")) return;
      localStorage.removeItem(STORAGE_KEY);
      state.data = { transactions: [], ddSeries: [] };
      state.whatIfOffset = 0;
      el.whatIfSlider.value = "0";
      refresh();
    }

    /**********************
     * Utilities
     **********************/
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /**********************
     * Events
     **********************/
    el.prevMonthBtn.addEventListener("click", ()=>{
      state.selectedMonth = addMonths(state.selectedMonth, -1);
      refresh();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    el.nextMonthBtn.addEventListener("click", ()=>{
      state.selectedMonth = addMonths(state.selectedMonth, 1);
      refresh();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    el.whatIfSlider.addEventListener("input", ()=>{
      state.whatIfOffset = Number(el.whatIfSlider.value || 0);
      refresh();
    });

    el.resetWhatIfBtn.addEventListener("click", ()=>{
      state.whatIfOffset = 0;
      el.whatIfSlider.value = "0";
      refresh();
    });

    el.addTxBtn.addEventListener("click", addTransaction);
    el.addDdBtn.addEventListener("click", addDirectDebit);

    el.exportAllBtn.addEventListener("click", exportAllCSV);
    el.resetAllBtn.addEventListener("click", resetAll);

    el.donutCard.addEventListener("click", openDonutModal);
    el.closeDonutModal.addEventListener("click", closeDonutModal);

    el.closeTxModal.addEventListener("click", closeTxModal);
    el.saveTxBtn.addEventListener("click", saveTx);
    el.deleteTxBtn.addEventListener("click", deleteTx);

    el.closeDdModal.addEventListener("click", closeDdModal);
    el.saveDdBtn.addEventListener("click", saveDd);
    el.deleteDdBtn.addEventListener("click", deleteDdSeries);

    el.scopeThisMonth.addEventListener("click", ()=> setScope("this"));
    el.scopeFromMonth.addEventListener("click", ()=> setScope("from"));

    // Tap outside modal closes (nice on iPhone)
    el.donutModal.addEventListener("click",(e)=>{ if(e.target === el.donutModal) closeDonutModal(); });
    el.txModal.addEventListener("click",(e)=>{ if(e.target === el.txModal) closeTxModal(); });
    el.ddModal.addEventListener("click",(e)=>{ if(e.target === el.ddModal) closeDdModal(); });

    // First paint
    refresh();
  </script>
</body>
</html>
