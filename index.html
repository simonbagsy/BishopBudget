<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>22 Bishop Road Budget</title>

  <!-- No pinch zoom -->
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root {
      --bg: #050713;
      --bg2: #070b16;
      --bg3: #080d1b;
      --card: #0e172c;
      --card-soft: #131f3a;
      --pill: #182648;
      --pill-soft: #1d2d55;
      --blue: #5fa9ff;
      --blue-soft: #8ec5ff;
      --green: #40e38a;
      --green-soft: #9af7c7;
      --red: #ff6a78;
      --red-soft: #ff8a94;
      --amber: #ffb24a;
      --text: #e6e8ee;
      --text-soft: #9aa3b5;
      --text-muted: #6f7888;
      --border-subtle: rgba(255, 255, 255, 0.04);
      --border-strong: rgba(255, 255, 255, 0.12);
      --shadow-strong: 0 22px 65px rgba(0, 0, 0, 0.75);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, -apple-system,
        "SF Pro Text", Segoe UI, Inter, Arial, sans-serif;
      background:
        radial-gradient(circle at top left, #161c3f 0, #050713 55%),
        radial-gradient(circle at bottom right, #050713 0, #020409 45%);
      background-attachment: fixed;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 12px 10px 26px;
    }

    .app-container {
      width: 100%;
      max-width: 520px;
      background: radial-gradient(circle at top, #151d3f 0, #050713 60%);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: var(--shadow-strong);
      padding: 16px;
      position: relative;
      overflow: hidden;
    }

    @media (min-width: 700px) {
      .app-container { padding: 20px; }
    }

    .section {
      background: var(--card-soft);
      border-radius: 18px;
      padding: 14px;
      margin-bottom: 10px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .section-title { font-size: 15px; font-weight: 600; }
    .section-subtitle { font-size: 11px; color: var(--text-muted); }

    .header-top {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .header-title { font-size: 18px; font-weight: 700; }
    .header-subtitle { font-size: 12px; color: var(--text-soft); }

    .header-icon {
      width: 68px;
      height: 68px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      object-fit: cover;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
      background: radial-gradient(circle at 20% 0, #3b86ff 0, #040615 55%);
    }

    .header-month-row {
      display: flex;
      align-items: center;
      margin-top: 4px;
      gap: 6px;
    }

    .header-month-label { font-size: 12px; color: var(--text-muted); }
    .header-month-value { font-size: 13px; font-weight: 600; color: #cfd7ff; }

    .btn {
      border-radius: 11px;
      padding: 6px 11px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: radial-gradient(circle at top, #223461 0, #141e3e 65%);
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
    }

    .btn:hover {
      filter: brightness(1.05);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4);
      transform: translateY(-0.5px);
    }

    .btn:active {
      transform: translateY(0.5px) scale(0.98);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6);
    }

    .btn-small { font-size: 12px; padding: 4px 9px; border-radius: 9px; }
    .btn-secondary { background: radial-gradient(circle at top, #27375f 0, #141d39 70%); }
    .btn-ghost { background: rgba(18, 30, 66, 0.8); border-color: rgba(255, 255, 255, 0.18); }
    .btn-danger { background: linear-gradient(180deg, #c53946, #8c2530); border-color: rgba(255, 175, 184, 0.5); }
    .btn-full { width: 100%; }
    .btn-subtle { background: rgba(9, 15, 33, 0.95); border-color: rgba(255, 255, 255, 0.18); font-size: 12px; }

    .input-label { font-size: 12px; color: var(--text-muted); margin-bottom: 3px; }

    .input {
      width: 100%;
      background: rgba(10, 17, 37, 0.9);
      border-radius: 10px;
      border: 1px solid rgba(92, 141, 255, 0.8);
      padding: 7px 9px;
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      outline: none;
      margin-bottom: 6px;
    }

    .input::placeholder {
      color: rgba(154, 163, 181, 0.82);
      font-weight: 500;
    }

    input[type="date"].input {
      -webkit-appearance: none;
      appearance: none;
      padding: 7px 9px;
      background-color: rgba(10, 17, 37, 0.9);
      border-radius: 10px;
    }

    select.input {
      padding-right: 28px;
      background-image: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0));
    }

    .inputs-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 6px;
    }

    .dashboard-card {
      background: rgba(13, 21, 45, 0.95);
      border-radius: 13px;
      padding: 8px 9px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    }

    .dashboard-label { font-size: 11px; color: var(--text-soft); }
    .dashboard-sub { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
    .dashboard-value { font-size: 14px; font-weight: 700; margin-top: 4px; }

    .status-row {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--green-soft);
      box-shadow: 0 0 0 2px rgba(64, 227, 138, 0.25);
    }

    .status-dot-red {
      background: var(--red-soft);
      box-shadow: 0 0 0 2px rgba(255, 106, 120, 0.3);
    }

    .status-text-main { font-size: 13px; font-weight: 600; }
    .status-text-sub { font-size: 11px; color: var(--text-soft); }

    .donut-row {
      display: flex;
      margin-top: 8px;
      gap: 10px;
      align-items: center;
    }

    .donut-wrapper {
      flex: 0 0 150px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .donut-wrapper canvas { cursor: pointer; border-radius: 999px; }

    .donut-legend {
      flex: 1;
      font-size: 11px;
      color: var(--text-soft);
    }

    .donut-legend-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      gap: 6px;
    }

    .donut-legend-label { display: flex; align-items: center; gap: 5px; }

    .legend-swatch { width: 10px; height: 10px; border-radius: 3px; background: var(--green-soft); }
    .legend-swatch-red { background: var(--red-soft); }
    .legend-swatch-carry { background: var(--blue-soft); }

    .list-container {
      max-height: 340px;
      overflow-y: auto;
      margin-top: 6px;
      padding-right: 2px;
    }

    .list-empty { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    .list-item {
      background: rgba(9, 15, 33, 0.96);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 8px 9px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.55);
    }

    .list-main { flex: 1; min-width: 0; }

    .list-title { font-size: 13px; font-weight: 600; margin-bottom: 2px; }

    .list-sub {
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .list-right { display: flex; align-items: center; gap: 6px; }

    .list-amount {
      font-size: 14px;
      font-weight: 700;
      text-align: right;
      white-space: nowrap;
    }

    .dd-paused .list-title { color: var(--red-soft); }
    .dd-paused .list-sub { color: #ff9fab; }

    .summary-rows { margin-top: 4px; font-size: 12px; }

    .summary-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .summary-row-label { color: var(--text-soft); }
    .summary-row-value { font-weight: 500; }

    .summary-row-strong { font-weight: 600; margin-top: 3px; }
    .summary-row-strong .summary-row-label { color: var(--text); }
    .summary-row-strong .summary-row-value { font-weight: 700; }

    .summary-card-inner {
      background: rgba(9, 15, 33, 0.96);
      border-radius: 14px;
      padding: 8px 9px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
    }

    .subtle-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.18), transparent);
      margin: 4px 0;
    }

    .line-graph-container {
      margin-top: 8px;
      background: rgba(9, 15, 33, 0.98);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 8px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7);
    }

    .line-graph-label { font-size: 11px; color: var(--text-soft); margin-bottom: 4px; }

    .line-graph-canvas {
      width: 100%;
      height: 70px;
      display: block;
      border-radius: 10px;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(1, 2, 8, 0.65);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 20;
    }

    .modal-sheet {
      width: 100%;
      max-width: 520px;
      background: radial-gradient(circle at top, #191f3e 0, #050713 65%);
      border-radius: 20px 20px 0 0;
      border-top: 1px solid rgba(255, 255, 255, 0.16);
      padding: 14px 14px 18px;
      box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.9);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .modal-title { font-size: 15px; font-weight: 600; }
    .modal-row { margin-top: 6px; }

    .modal-actions {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 10px;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 8px;
    }

    .toggle-label { font-size: 12px; color: var(--text-soft); }

    .toggle-pill {
      width: 44px;
      height: 24px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.08);
      position: relative;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: background 0.12s ease, border-color 0.12s ease;
    }

    .toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ffffff;
      transition: transform 0.12s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    .toggle-pill.on {
      background: linear-gradient(140deg, var(--green), var(--green-soft));
      border-color: rgba(159, 255, 205, 0.9);
    }

    .toggle-pill.on .toggle-thumb { transform: translateX(18px); }

    #donutBreakdown {
      display: none;
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at top, #191f3e 0, #050713 70%),
        radial-gradient(circle at bottom, #050713 0, #000000 55%);
      z-index: 15;
      overflow-y: auto;
      padding: 12px 10px 24px;
      color: var(--text);
    }

    .bd-inner { width: 100%; max-width: 520px; margin: 0 auto; }
    .bd-back-row { margin-bottom: 8px; }

    .bd-card {
      background: var(--card-soft);
      border-radius: 20px;
      border: 1px solid var(--border-strong);
      padding: 14px;
      box-shadow: 0 22px 70px rgba(0, 0, 0, 0.86);
    }

    .bd-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    .bd-mini {
      background: rgba(9, 15, 33, 0.96);
      border-radius: 14px;
      padding: 8px 9px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7);
    }

    .bd-label { font-size: 11px; color: var(--text-soft); }
    .bd-value { font-size: 14px; font-weight: 700; margin-top: 3px; }

    .bd-donut-wrap { display: flex; justify-content: center; margin-top: 10px; margin-bottom: 6px; }
    .bd-donut-wrap canvas { border-radius: 999px; }

    .bd-subtext { font-size: 12px; color: var(--text-soft); margin-top: 2px; }

    .compare-card {
      background: rgba(9, 15, 33, 0.96);
      border-radius: 16px;
      padding: 8px 9px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      margin-top: 10px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.7);
      font-size: 12px;
    }

    .compare-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
    .compare-label { color: var(--text-soft); }
    .compare-value { font-weight: 600; }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="app-container">
      <div class="section">
        <div class="header-top">
          <div>
            <div class="header-title">Monthly Budget</div>
            <div class="header-subtitle">22 Bishop Road</div>
          </div>
          <img src="icon-192.png" alt="App Icon" class="header-icon" />
        </div>

        <div class="header-month-row">
          <span class="header-month-label">Month:</span>
          <span id="monthLabel" class="header-month-value">Jan 26</span>

          <div style="margin-left:auto;display:flex;gap:6px;">
            <button class="btn btn-small btn-secondary" id="prevMonthBtn">‹</button>
            <button class="btn btn-small btn-secondary" id="nextMonthBtn">›</button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div>
            <div class="section-title">Dashboard Snapshot</div>
            <div class="section-subtitle">High-level view of this month's money.</div>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-label">Monthly income</div>
            <div class="dashboard-sub">Sum of all income transactions</div>
            <div id="incomeValue" class="dashboard-value">£0.00</div>
          </div>
          <div class="dashboard-card">
            <div class="dashboard-label">Direct Debits & Bills</div>
            <div class="dashboard-sub">Mortgage, utilities, tax</div>
            <div id="ddValue" class="dashboard-value" style="color:#ffffff;">£0.00</div>
          </div>
          <div class="dashboard-card">
            <div class="dashboard-label">Other spending</div>
            <div class="dashboard-sub">Food, fuel, nights out</div>
            <div id="spendValue" class="dashboard-value">£0.00</div>
          </div>
          <div id="leftCard" class="dashboard-card">
            <div class="dashboard-label">Left after spending</div>
            <div class="dashboard-sub">After DDs and other spend</div>
            <div id="leftValue" class="dashboard-value">£0.00</div>
          </div>
        </div>

        <!-- Spending pace + runway -->
        <div class="dashboard-grid" style="margin-top:6px;">
          <div class="dashboard-card">
            <div class="dashboard-label">Spending pace</div>
            <div id="paceSub" class="dashboard-sub">Average outflow so far</div>
            <div id="paceValue" class="dashboard-value">–</div>
          </div>
          <div class="dashboard-card">
            <div class="dashboard-label">Runway</div>
            <div id="runwaySub" class="dashboard-sub">Days until £0</div>
            <div id="runwayValue" class="dashboard-value">–</div>
          </div>
        </div>

        <div class="status-row">
          <div id="statusDot" class="status-dot"></div>
          <div>
            <div id="statusMain" class="status-text-main">Waiting for income</div>
            <div id="statusSub" class="status-text-sub">
              Add your salary to see how much is left after direct debits and spending.
            </div>
          </div>
        </div>

        <div class="donut-row">
          <div class="donut-wrapper">
            <canvas id="donutCanvas" width="150" height="150"></canvas>
          </div>
          <div class="donut-legend">
            <div class="donut-legend-row">
              <div class="donut-legend-label">
                <div class="legend-swatch legend-swatch-carry"></div>
                <span>Opening balance + income</span>
              </div>
              <span id="legendIncome" style="font-weight:600;">£0.00</span>
            </div>
            <div class="donut-legend-row">
              <div class="donut-legend-label">
                <div class="legend-swatch legend-swatch-red"></div>
                <span>DDs & spending</span>
              </div>
              <span id="legendOut" style="font-weight:600;">£0.00</span>
            </div>
            <div class="donut-legend-row">
              <div class="donut-legend-label">
                <div class="legend-swatch"></div>
                <span>Left after everything</span>
              </div>
              <span id="legendLeft" style="font-weight:600;">£0.00</span>
            </div>

            <button
              id="seeMoreDonut"
              class="btn btn-subtle"
              style="margin-top:6px;width:100%;justify-content:center;"
            >
              View detailed donut breakdown
            </button>
          </div>
        </div>

        <div class="line-graph-container">
          <div class="line-graph-label">
            Balance curve across the month (with opening balance applied)
          </div>
          <canvas id="balanceCanvas" class="line-graph-canvas"></canvas>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div>
            <div class="section-title">Add transaction (one-off)</div>
            <div class="section-subtitle">Income or spending just for this month.</div>
          </div>
        </div>

        <div class="inputs-row">
          <div>
            <div class="input-label">Date</div>
            <input id="txDate" type="date" class="input" />
          </div>
          <div>
            <div class="input-label">Type</div>
            <select id="txType" class="input">
              <option value="income">Income</option>
              <option value="spend">Spending</option>
            </select>
          </div>
        </div>

        <div class="inputs-row">
          <div>
            <div class="input-label">Description</div>
            <input id="txDesc" class="input" placeholder="e.g. RN salary, Tesco shop" />
          </div>
          <div>
            <div class="input-label">Amount</div>
            <input id="txAmt" class="input" placeholder="0.00" inputmode="decimal" />
          </div>
        </div>

        <button id="addTxBtn" class="btn btn-full" style="margin-top:4px;">
          Add transaction
        </button>

        <div id="txList" class="list-container"></div>
      </div>

      <div class="section">
        <div class="section-header">
          <div>
            <div class="section-title">Direct debits & regular bills</div>
            <div class="section-subtitle">Per-month commitments, auto-carrying to future months.</div>
          </div>
        </div>

        <div class="inputs-row">
          <div>
            <div class="input-label">Name</div>
            <input id="ddName" class="input" placeholder="e.g. Mortgage, Council tax" />
          </div>
          <div>
            <div class="input-label">Amount</div>
            <input id="ddAmt" class="input" placeholder="0.00" inputmode="decimal" />
          </div>
        </div>

        <div class="inputs-row">
          <div>
            <div class="input-label">Day of month</div>
            <input id="ddDay" class="input" placeholder="1–31" inputmode="numeric" />
          </div>
          <div>
            <div class="input-label">Category (optional)</div>
            <input id="ddCat" class="input" placeholder="e.g. Utilities, Housing" />
          </div>
        </div>

        <button id="addDdBtn" class="btn btn-full" style="margin-top:4px;">
          Add direct debit
        </button>

        <div id="ddList" class="list-container"></div>
      </div>

      <div class="section">
        <div class="section-header">
          <div>
            <div class="section-title">Month summary</div>
            <div class="section-subtitle">Where this month ends up overall.</div>
          </div>
        </div>

        <div class="summary-card-inner">
          <div class="summary-rows">
            <div class="summary-row">
              <span class="summary-row-label">Started with (opening + income)</span>
              <span id="summaryStart" class="summary-row-value">£0.00</span>
            </div>
            <div class="summary-row">
              <span class="summary-row-label">Committed to direct debits</span>
              <span id="summaryDd" class="summary-row-value">£0.00</span>
            </div>
            <div class="summary-row">
              <span class="summary-row-label">Spent this month</span>
              <span id="summarySpend" class="summary-row-value">£0.00</span>
            </div>
            <div class="subtle-divider"></div>
            <div class="summary-row summary-row-strong">
              <span class="summary-row-label">Left after everything</span>
              <span id="summaryAfter" class="summary-row-value">£0.00</span>
            </div>
          </div>
        </div>

        <div style="margin-top:8px;display:flex;gap:6px;justify-content:space-between;">
          <button id="exportCsvBtn" class="btn btn-small btn-secondary" style="flex:1;">
            Export all data (CSV)
          </button>
          <button id="resetAppBtn" class="btn btn-small btn-ghost" style="flex:1;">
            Reset app
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- TRANSACTION EDIT MODAL -->
  <div id="txModal" class="modal-overlay">
    <div class="modal-sheet">
      <div class="modal-header">
        <div class="modal-title">Edit transaction</div>
        <button class="btn btn-small btn-ghost" id="txModalDone">Done</button>
      </div>

      <div class="modal-row">
        <div class="input-label">Date</div>
        <input id="editTxDate" type="date" class="input" />
      </div>
      <div class="modal-row">
        <div class="input-label">Type</div>
        <select id="editTxType" class="input">
          <option value="income">Income</option>
          <option value="spend">Spending</option>
        </select>
      </div>
      <div class="modal-row">
        <div class="input-label">Description</div>
        <input id="editTxDesc" class="input" />
      </div>
      <div class="modal-row">
        <div class="input-label">Amount</div>
        <input id="editTxAmt" class="input" inputmode="decimal" />
      </div>

      <div class="modal-actions">
        <button id="deleteTxBtn" class="btn btn-danger">Delete</button>
        <button id="saveTxBtn" class="btn btn-secondary" style="flex:1;">
          Save changes
        </button>
      </div>
    </div>
  </div>

  <!-- DIRECT DEBIT EDIT MODAL -->
  <div id="ddModal" class="modal-overlay">
    <div class="modal-sheet">
      <div class="modal-header">
        <div class="modal-title">Edit direct debit</div>
        <button class="btn btn-small btn-ghost" id="ddModalDone">Done</button>
      </div>

      <div class="modal-row">
        <div class="input-label">Name</div>
        <input id="editDdName" class="input" />
      </div>
      <div class="modal-row">
        <div class="input-label">Amount</div>
        <input id="editDdAmt" class="input" inputmode="decimal" />
      </div>
      <div class="modal-row">
        <div class="input-label">Day of month</div>
        <input id="editDdDay" class="input" inputmode="numeric" />
      </div>
      <div class="modal-row">
        <div class="input-label">Category</div>
        <input id="editDdCat" class="input" />
      </div>

      <div class="toggle-row">
        <span class="toggle-label">Paused for this month</span>
        <div id="ddPausedToggle" class="toggle-pill">
          <div class="toggle-thumb"></div>
        </div>
      </div>

      <div class="modal-actions">
        <button id="deleteDdBtn" class="btn btn-danger">Delete this month</button>
        <button id="saveDdBtn" class="btn btn-secondary" style="flex:1;">
          Save changes
        </button>
      </div>
    </div>
  </div>

  <!-- DONUT BREAKDOWN SCREEN -->
  <div id="donutBreakdown">
    <div class="bd-inner">
      <div class="bd-back-row">
        <button class="btn btn-small btn-ghost" id="closeDonutBreakdown">
          ← Back to month
        </button>
      </div>

      <div class="bd-card">
        <div class="section-header" style="margin-bottom:4px;">
          <div>
            <div class="section-title">Detailed donut breakdown</div>
            <div class="section-subtitle">
              Income, DDs and spending for the selected month, with carry from the previous months.
            </div>
          </div>
        </div>

        <div class="bd-donut-wrap">
          <canvas id="donutBig" width="260" height="260"></canvas>
        </div>

        <div class="bd-subtext">
          The donut shows: opening balance + income vs DDs + spending, with what’s left after everything.
        </div>

        <div class="bd-grid">
          <div class="bd-mini">
            <div class="bd-label">Income this month</div>
            <div id="bdIncome" class="bd-value">£0.00</div>
          </div>
          <div class="bd-mini">
            <div class="bd-label">Direct debits & bills</div>
            <div id="bdDd" class="bd-value">£0.00</div>
          </div>
          <div class="bd-mini">
            <div class="bd-label">Other spending</div>
            <div id="bdSpend" class="bd-value">£0.00</div>
          </div>
          <div class="bd-mini">
            <div class="bd-label">Opening balance from last month</div>
            <div id="bdCarry" class="bd-value">£0.00</div>
          </div>
          <div class="bd-mini" style="grid-column:1/3;">
            <div class="bd-label">Left after everything</div>
            <div id="bdAfter" class="bd-value">£0.00</div>
          </div>
        </div>

        <div class="compare-card">
          <div class="compare-row">
            <span class="compare-label">This month left vs last month left</span>
            <span id="compareAfter" class="compare-value">–</span>
          </div>
          <div class="compare-row">
            <span class="compare-label">Income change since last month</span>
            <span id="compareIncome" class="compare-value">–</span>
          </div>
          <div class="compare-row">
            <span class="compare-label">Spending change since last month</span>
            <span id="compareSpend" class="compare-value">–</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ------------ DATA & HELPERS ------------

    let transactions = [];
    let directDebits = [];
    let ddOverrides = [];

    function loadFromStorage() {
      try {
        const txRaw = localStorage.getItem("bb_tx");
        const ddRaw = localStorage.getItem("bb_dd");
        const ovRaw = localStorage.getItem("bb_dd_overrides");
        transactions = txRaw ? JSON.parse(txRaw) : [];
        directDebits = ddRaw ? JSON.parse(ddRaw) : [];
        ddOverrides = ovRaw ? JSON.parse(ovRaw) : [];
      } catch (e) {
        transactions = [];
        directDebits = [];
        ddOverrides = [];
      }
    }

    function saveToStorage() {
      localStorage.setItem("bb_tx", JSON.stringify(transactions));
      localStorage.setItem("bb_dd", JSON.stringify(directDebits));
      localStorage.setItem("bb_dd_overrides", JSON.stringify(ddOverrides));
    }

    function uuid() {
      if (crypto.randomUUID) return crypto.randomUUID();
      return "id-" + Math.random().toString(16).slice(2);
    }

    function firstOfMonth(d) { return new Date(d.getFullYear(), d.getMonth(), 1); }

    function monthKey(d) {
      return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
    }

    function parseMonthKey(mk) {
      const [y, m] = mk.split("-").map(Number);
      if (!y || !m) return null;
      return new Date(y, m - 1, 1);
    }

    function monthLabel(d) {
      return d.toLocaleDateString("en-GB", { month: "short", year: "2-digit" });
    }

    function formatMoney(v) {
      if (!isFinite(v)) v = 0;
      return "£" + v.toFixed(2);
    }

    function formatDisplayDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      const day = String(d.getDate()).padStart(2, "0");
      const mmm = d.toLocaleDateString("en-GB", { month: "short" });
      const yy = String(d.getFullYear()).slice(-2);
      return `${day}-${mmm}-${yy}`;
    }

    // Ignore old auto-opening incomes from previous versions
    function isAutoOpening(tx) {
      return (tx.type === "income" && tx.description === "Opening balance (auto)");
    }

    // ------------ DONUT & GRAPH DRAWING ------------

    function drawDonut(canvas, openingPlusIncome, outgoing) {
      const ctx = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);

      const cx = w / 2;
      const cy = h / 2;
      const radius = Math.min(cx, cy) - 12;
      const ringWidth = 18;

      // Base ring
      ctx.beginPath();
      ctx.arc(cx, cy, radius, 0, Math.PI * 2);
      const baseGrad = ctx.createLinearGradient(cx - radius, cy, cx + radius, cy);
      baseGrad.addColorStop(0, "#1b2748");
      baseGrad.addColorStop(1, "#11182f");
      ctx.strokeStyle = baseGrad;
      ctx.lineWidth = ringWidth;
      ctx.stroke();

      const total = Math.max(openingPlusIncome, outgoing, 1);
      const rawLeft = openingPlusIncome - outgoing;
      const left = Math.max(0, rawLeft);
      const percentLeft = openingPlusIncome > 0
        ? Math.max(0, Math.min(100, (left / openingPlusIncome) * 100))
        : 0;

      const outAngle = (outgoing / total) * Math.PI * 2;
      const leftAngle = (left / total) * Math.PI * 2;
      const startAngle = -Math.PI / 2;

      // Outgoing segment
      if (outgoing > 0) {
        ctx.beginPath();
        ctx.arc(cx, cy, radius, startAngle, startAngle + outAngle);
        const gradRed = ctx.createLinearGradient(cx, cy - radius, cx, cy + radius);
        gradRed.addColorStop(0, "#ff9fab");
        gradRed.addColorStop(1, "#ff6a78");
        ctx.strokeStyle = gradRed;
        ctx.lineWidth = ringWidth;
        ctx.lineCap = "round";
        ctx.stroke();
      }

      // Left segment
      if (left > 0) {
        ctx.beginPath();
        ctx.arc(cx, cy, radius, startAngle + outAngle, startAngle + outAngle + leftAngle);
        const gradGreen = ctx.createLinearGradient(cx - radius, cy, cx + radius, cy);
        gradGreen.addColorStop(0, "#9af7c7");
        gradGreen.addColorStop(1, "#40e38a");
        ctx.strokeStyle = gradGreen;
        ctx.lineWidth = ringWidth;
        ctx.lineCap = "round";
        ctx.stroke();
      }

      // Centre text
      ctx.fillStyle = "#e8edf8";
      ctx.font = "600 22px -apple-system, system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(`${Math.round(percentLeft)}%`, cx, cy - 5);

      ctx.fillStyle = "#9aa3b1";
      ctx.font = "11px -apple-system, system-ui, sans-serif";
      ctx.fillText("income left", cx, cy + 12);
    }

    function drawBalanceLine(canvas, dailyBalances) {
      const ctx = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);

      if (!dailyBalances || dailyBalances.length === 0) return;

      const maxVal = Math.max(...dailyBalances, 0);
      const minVal = Math.min(...dailyBalances, 0);
      const range = maxVal - minVal || 1;

      const leftPadding = 4;
      const rightPadding = 4;
      const topPadding = 4;
      const bottomPadding = 4;
      const usableWidth = w - leftPadding - rightPadding;
      const usableHeight = h - topPadding - bottomPadding;

      const count = dailyBalances.length;
      const stepX = count > 1 ? usableWidth / (count - 1) : 0;

      const zeroY = topPadding + usableHeight - ((0 - minVal) / range) * usableHeight;

      ctx.strokeStyle = "rgba(255,255,255,0.16)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(leftPadding, zeroY);
      ctx.lineTo(w - rightPadding, zeroY);
      ctx.stroke();

      ctx.beginPath();
      dailyBalances.forEach((val, idx) => {
        const x = leftPadding + idx * stepX;
        const norm = (val - minVal) / range;
        const y = topPadding + usableHeight - norm * usableHeight;
        if (idx === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });

      const grad = ctx.createLinearGradient(leftPadding, 0, w - rightPadding, 0);
      grad.addColorStop(0, "#5fa9ff");
      grad.addColorStop(0.5, "#9af7c7");
      grad.addColorStop(1, "#ffb24a");
      ctx.strokeStyle = grad;
      ctx.lineWidth = 2;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.stroke();
    }

    // ------------ MONTH CALC WITH CARRY ------------

    function getAllMonthKeysIncluding(targetMonth) {
      const set = new Set();
      const targetMK = monthKey(targetMonth);

      for (const tx of transactions) {
        if (isAutoOpening(tx)) continue;
        const d = new Date(tx.date);
        if (Number.isNaN(d.getTime())) continue;
        set.add(monthKey(d));
      }

      for (const dd of directDebits) {
        if (dd.month) set.add(dd.month);
      }

      for (const ov of ddOverrides) {
        if (ov.month) set.add(ov.month);
      }

      set.add(targetMK);
      return Array.from(set).sort();
    }

    function computeRawMonthTotals(monthDate, carryIn) {
      const mk = monthKey(monthDate);

      const monthTx = transactions.filter((t) => {
        if (isAutoOpening(t)) return false;
        const d = new Date(t.date);
        if (Number.isNaN(d.getTime())) return false;
        return monthKey(d) === mk;
      });

      // DD repeats from its start month onward
      const monthBaseDDs = directDebits.filter((dd) => {
        if (!dd.month) return false;
        const baseDate = parseMonthKey(dd.month);
        if (!baseDate) return false;
        return baseDate <= monthDate;
      });

      const actualDDs = monthBaseDDs.map((dd) => {
        const override = ddOverrides.find((ov) => ov.baseId === dd.id && ov.month === mk);

        if (!override || override.type === "none") {
          const active = override ? override.active : dd.active;
          return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: active !== false };
        }
        if (override.type === "modified") {
          return { baseId: dd.id, name: override.name, amount: override.amount, day: override.day, category: override.category, active: override.active !== false };
        }
        if (override.type === "skipped") {
          return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: false };
        }
        return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: dd.active };
      });

      const activeDDs = actualDDs.filter((d) => d.active);

      const income = monthTx.filter((t) => t.type === "income").reduce((sum, t) => sum + (t.amount || 0), 0);
      const spend  = monthTx.filter((t) => t.type === "spend").reduce((sum, t) => sum + (t.amount || 0), 0);
      const ddTotal = activeDDs.reduce((sum, d) => sum + (d.amount || 0), 0);

      const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();

      const dailyBalances = [];
      for (let day = 1; day <= daysInMonth; day++) {
        const ddUpToDay = activeDDs.filter((d) => d.day <= day).reduce((sum, d) => sum + (d.amount || 0), 0);

        const spendUpToDay = monthTx
          .filter((t) => t.type === "spend")
          .filter((t) => {
            const d = new Date(t.date);
            return !Number.isNaN(d.getTime()) && d.getDate() <= day;
          })
          .reduce((sum, t) => sum + (t.amount || 0), 0);

        const incomeUpToDay = monthTx
          .filter((t) => t.type === "income")
          .filter((t) => {
            const d = new Date(t.date);
            return !Number.isNaN(d.getTime()) && d.getDate() <= day;
          })
          .reduce((sum, t) => sum + (t.amount || 0), 0);

        const bal = carryIn + incomeUpToDay - ddUpToDay - spendUpToDay;
        dailyBalances.push(bal);
      }

      const afterAll = carryIn + income - ddTotal - spend;

      return { carryIn, income, spend, ddTotal, afterAll, dailyBalances, activeDDs, rawTransactions: monthTx };
    }

    function computeMonthWithCarry(targetMonth) {
      const targetMK = monthKey(targetMonth);
      const allMKs = getAllMonthKeysIncluding(targetMonth);
      let carry = 0;
      let result = null;

      for (const mk of allMKs) {
        const mDate = parseMonthKey(mk);
        if (!mDate) continue;

        const raw = computeRawMonthTotals(mDate, carry);
        if (mk === targetMK) { result = raw; break; }
        carry = raw.afterAll;
      }

      if (!result) return computeRawMonthTotals(targetMonth, 0);
      return result;
    }

    // ------------ UI RENDERING ------------

    let selectedMonth = firstOfMonth(new Date());
    let currentEditingTxId = null;
    let currentEditingDdBaseId = null;
    let currentEditingDdMonthKey = null;

    function refreshUI() {
      const monthLabelEl = document.getElementById("monthLabel");
      const incomeValueEl = document.getElementById("incomeValue");
      const ddValueEl = document.getElementById("ddValue");
      const spendValueEl = document.getElementById("spendValue");
      const leftValueEl = document.getElementById("leftValue");
      const leftCardEl = document.getElementById("leftCard");
      const donutCanvas = document.getElementById("donutCanvas");
      const balanceCanvas = document.getElementById("balanceCanvas");

      const summaryStartEl = document.getElementById("summaryStart");
      const summaryDdEl = document.getElementById("summaryDd");
      const summarySpendEl = document.getElementById("summarySpend");
      const summaryAfterEl = document.getElementById("summaryAfter");

      const legendIncomeEl = document.getElementById("legendIncome");
      const legendOutEl = document.getElementById("legendOut");
      const legendLeftEl = document.getElementById("legendLeft");

      const statusDotEl = document.getElementById("statusDot");
      const statusMainEl = document.getElementById("statusMain");
      const statusSubEl = document.getElementById("statusSub");

      monthLabelEl.textContent = monthLabel(selectedMonth);

      const totals = computeMonthWithCarry(selectedMonth);
      const income = totals.income;
      const spend = totals.spend;
      const ddTotal = totals.ddTotal;
      const carryIn = totals.carryIn;
      const baseAfterAll = totals.afterAll;

      const openingPlusIncome = carryIn + income;
      const totalOut = ddTotal + spend;

      incomeValueEl.textContent = formatMoney(income);
      ddValueEl.textContent = formatMoney(ddTotal);
      spendValueEl.textContent = formatMoney(spend);
      leftValueEl.textContent = formatMoney(baseAfterAll);

      legendIncomeEl.textContent = formatMoney(openingPlusIncome);
      legendOutEl.textContent = formatMoney(totalOut);
      legendLeftEl.textContent = formatMoney(baseAfterAll);

      // Spending pace + runway
      const paceValueEl = document.getElementById('paceValue');
      const paceSubEl = document.getElementById('paceSub');
      const runwayValueEl = document.getElementById('runwayValue');
      const runwaySubEl = document.getElementById('runwaySub');

      const today = new Date();
      const thisMonthStart = firstOfMonth(today);
      const selMK = monthKey(selectedMonth);
      const todayMK = monthKey(thisMonthStart);
      const daysInMonth = totals.dailyBalances.length || new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1, 0).getDate();

      let elapsedDays = 0;
      if (selMK === todayMK) {
        elapsedDays = Math.min(today.getDate(), daysInMonth);
      } else if (selectedMonth < thisMonthStart) {
        elapsedDays = daysInMonth;
      } else {
        elapsedDays = 0;
      }

      if (!elapsedDays) {
        paceValueEl.textContent = '–';
        paceSubEl.textContent = 'Select a current or past month';
        runwayValueEl.textContent = '–';
        runwaySubEl.textContent = 'Select a current or past month';
      } else {
        const ddSoFar = totals.activeDDs
          .filter(d => (d.day || 0) <= elapsedDays)
          .reduce((s, d) => s + (d.amount || 0), 0);

        const spendSoFar = totals.rawTransactions
          .filter(t => t.type === 'spend')
          .filter(t => {
            const d = new Date(t.date);
            return !Number.isNaN(d.getTime()) && d.getDate() <= elapsedDays;
          })
          .reduce((s, t) => s + (t.amount || 0), 0);

        const outSoFar = ddSoFar + spendSoFar;
        const avgOut = outSoFar / Math.max(elapsedDays, 1);

        const projectedOut = avgOut * daysInMonth;
        const projectedLeft = openingPlusIncome - projectedOut;

        paceValueEl.textContent = `${formatMoney(avgOut)}/day`;
        paceSubEl.textContent = `Projected left at month end: ${formatMoney(projectedLeft)}`;
        paceSubEl.style.color = projectedLeft >= 0 ? 'var(--text-soft)' : 'var(--red-soft)';
        paceValueEl.style.color = avgOut > 0 ? 'var(--blue-soft)' : 'var(--text)';

        const currentBalance = totals.dailyBalances[Math.max(0, elapsedDays - 1)] ?? baseAfterAll;

        if (avgOut <= 0) {
          runwayValueEl.textContent = '–';
          runwaySubEl.textContent = 'No outflow yet';
          runwayValueEl.style.color = 'var(--text)';
        } else if (currentBalance <= 0) {
          runwayValueEl.textContent = '0 days';
          runwaySubEl.textContent = 'Already at or below £0';
          runwayValueEl.style.color = 'var(--red-soft)';
        } else {
          const days = Math.floor(currentBalance / avgOut);
          runwayValueEl.textContent = `${days} day${days === 1 ? '' : 's'}`;
          runwaySubEl.textContent = `At current outflow rate (balance now: ${formatMoney(currentBalance)})`;
          runwayValueEl.style.color = days <= 7 ? 'var(--amber)' : 'var(--green-soft)';
        }
      }

      summaryStartEl.textContent = formatMoney(openingPlusIncome);
      summaryDdEl.textContent = formatMoney(ddTotal);
      summarySpendEl.textContent = formatMoney(spend);
      summaryAfterEl.textContent = formatMoney(baseAfterAll);

      if (baseAfterAll > 0) {
        leftCardEl.style.borderColor = "rgba(64,227,138,0.5)";
        leftCardEl.style.boxShadow = "0 12px 30px rgba(64,227,138,0.35)";
        leftValueEl.style.color = "var(--green-soft)";

        statusDotEl.classList.remove("status-dot-red");
        statusDotEl.classList.add("status-dot");
        statusMainEl.textContent = "You’re in the green";
        statusMainEl.style.color = "var(--green-soft)";
        statusSubEl.textContent = `${formatMoney(baseAfterAll)} left after this month’s direct debits and spending.`;
      } else if (baseAfterAll < 0) {
        leftCardEl.style.borderColor = "rgba(255,106,120,0.55)";
        leftCardEl.style.boxShadow = "0 12px 30px rgba(255,106,120,0.4)";
        leftValueEl.style.color = "var(--red-soft)";

        statusDotEl.classList.remove("status-dot");
        statusDotEl.classList.add("status-dot-red");
        statusMainEl.textContent = "Spending over income";
        statusMainEl.style.color = "var(--red-soft)";
        statusSubEl.textContent = `Over by ${formatMoney(Math.abs(baseAfterAll))} this month.`;
      } else {
        leftCardEl.style.borderColor = "rgba(255,255,255,0.12)";
        leftCardEl.style.boxShadow = "0 12px 30px rgba(0,0,0,0.7)";
        leftValueEl.style.color = "var(--text)";

        statusDotEl.classList.remove("status-dot-red");
        statusDotEl.classList.add("status-dot");
        statusMainEl.textContent = "Every pound is allocated";
        statusMainEl.style.color = "var(--text)";
        statusSubEl.textContent = "You’ve used 100% of this month’s opening + income.";
      }

      drawBalanceLine(balanceCanvas, totals.dailyBalances);
      drawDonut(donutCanvas, openingPlusIncome, totalOut);

      renderTransactionList();
      renderDirectDebitList();
    }

    function renderTransactionList() {
      const mk = monthKey(selectedMonth);
      const txList = document.getElementById("txList");
      txList.innerHTML = "";

      const filtered = transactions.filter((t) => {
        if (isAutoOpening(t)) return false;
        const d = new Date(t.date);
        if (Number.isNaN(d.getTime())) return false;
        return monthKey(d) === mk;
      });

      if (filtered.length === 0) {
        const empty = document.createElement("div");
        empty.className = "list-empty";
        empty.textContent = "No transactions yet. Add income and spending above.";
        txList.appendChild(empty);
        return;
      }

      const sorted = filtered.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

      for (const tx of sorted) {
        const row = document.createElement("div");
        row.className = "list-item";

        const main = document.createElement("div");
        main.className = "list-main";

        const title = document.createElement("div");
        title.className = "list-title";
        title.textContent = tx.description;

        const sub = document.createElement("div");
        sub.className = "list-sub";
        sub.textContent = `${formatDisplayDate(tx.date)} · ${tx.type === "income" ? "Income" : "Spending"}`;

        main.appendChild(title);
        main.appendChild(sub);

        const right = document.createElement("div");
        right.className = "list-right";

        const amt = document.createElement("div");
        amt.className = "list-amount";
        amt.style.color = tx.type === "income" ? "var(--green-soft)" : "var(--red-soft)";
        amt.textContent = formatMoney(tx.amount);

        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-small btn-ghost";
        editBtn.textContent = "Edit";
        editBtn.style.marginTop = "-2px";
        editBtn.addEventListener("click", () => openTransactionEditModal(tx));

        right.appendChild(amt);
        right.appendChild(editBtn);

        row.appendChild(main);
        row.appendChild(right);

        txList.appendChild(row);
      }
    }

    function renderDirectDebitList() {
      const mk = monthKey(selectedMonth);
      const ddList = document.getElementById("ddList");
      ddList.innerHTML = "";

      const monthBaseDDs = directDebits.filter((dd) => {
        if (!dd.month) return false;
        const baseDate = parseMonthKey(dd.month);
        if (!baseDate) return false;
        return baseDate <= selectedMonth;
      });

      const actualDDs = monthBaseDDs.map((dd) => {
        const override = ddOverrides.find((ov) => ov.baseId === dd.id && ov.month === mk);
        if (!override || override.type === "none") {
          const active = override ? override.active : dd.active;
          return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: active !== false };
        }
        if (override.type === "modified") {
          return { baseId: dd.id, name: override.name, amount: override.amount, day: override.day, category: override.category, active: override.active !== false };
        }
        if (override.type === "skipped") {
          return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: false };
        }
        return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: dd.active };
      });

      if (actualDDs.length === 0) {
        const empty = document.createElement("div");
        empty.className = "list-empty";
        empty.textContent = "No direct debits yet. Start with mortgage, council tax and utilities.";
        ddList.appendChild(empty);
        return;
      }

      const sorted = actualDDs.slice().sort((a, b) => a.day - b.day || a.name.localeCompare(b.name));

      for (const dd of sorted) {
        const row = document.createElement("div");
        row.className = "list-item";
        if (!dd.active) row.classList.add("dd-paused");

        const main = document.createElement("div");
        main.className = "list-main";

        const title = document.createElement("div");
        title.className = "list-title";
        title.textContent = dd.name;

        const sub = document.createElement("div");
        sub.className = "list-sub";
        sub.textContent = `${formatMoney(dd.amount)} · day ${dd.day}${dd.category ? " · " + dd.category : ""}`;

        main.appendChild(title);
        main.appendChild(sub);

        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-small btn-ghost";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => openDirectDebitEditModal(dd.baseId));

        row.appendChild(main);
        row.appendChild(editBtn);

        ddList.appendChild(row);
      }
    }

    // ------------ ADD / EDIT / DELETE ------------

    function addTransaction() {
      const dateVal = document.getElementById("txDate").value;
      const typeVal = document.getElementById("txType").value;
      const descVal = document.getElementById("txDesc").value.trim();
      const amtStr = document.getElementById("txAmt").value.replace(",", ".");
      const amt = parseFloat(amtStr);

      if (!dateVal || !descVal || !isFinite(amt)) return;

      transactions.push({ id: uuid(), date: dateVal, type: typeVal, description: descVal, amount: amt });
      saveToStorage();

      document.getElementById("txDesc").value = "";
      document.getElementById("txAmt").value = "";
      document.getElementById("txType").value = "income";
      document.getElementById("txDate").value = "";

      if (document.activeElement) document.activeElement.blur();
      refreshUI();
    }

    function addDirectDebit() {
      const nameVal = document.getElementById("ddName").value.trim();
      const amtStr = document.getElementById("ddAmt").value.replace(",", ".");
      const amt = parseFloat(amtStr);
      const dayVal = parseInt(document.getElementById("ddDay").value, 10);
      const catVal = document.getElementById("ddCat").value.trim();

      if (!nameVal || !isFinite(amt) || !isFinite(dayVal)) return;
      if (dayVal < 1 || dayVal > 31) return;

      directDebits.push({
        id: uuid(),
        month: monthKey(selectedMonth),
        name: nameVal,
        amount: amt,
        day: dayVal,
        category: catVal,
        active: true
      });

      saveToStorage();

      document.getElementById("ddName").value = "";
      document.getElementById("ddAmt").value = "";
      document.getElementById("ddDay").value = "";
      document.getElementById("ddCat").value = "";

      if (document.activeElement) document.activeElement.blur();
      refreshUI();
    }

    function openTransactionEditModal(tx) {
      currentEditingTxId = tx.id;
      document.getElementById("editTxDate").value = tx.date;
      document.getElementById("editTxType").value = tx.type;
      document.getElementById("editTxDesc").value = tx.description;
      document.getElementById("editTxAmt").value = tx.amount.toFixed(2);
      document.getElementById("txModal").style.display = "flex";
    }

    function closeTransactionEditModal() {
      document.getElementById("txModal").style.display = "none";
      currentEditingTxId = null;
    }

    function saveTransactionEdit() {
      if (!currentEditingTxId) return;
      const tx = transactions.find((t) => t.id === currentEditingTxId);
      if (!tx) return;

      const dateVal = document.getElementById("editTxDate").value;
      const typeVal = document.getElementById("editTxType").value;
      const descVal = document.getElementById("editTxDesc").value.trim();
      const amtStr = document.getElementById("editTxAmt").value.replace(",", ".");
      const amt = parseFloat(amtStr);

      if (!dateVal || !descVal || !isFinite(amt)) return;

      tx.date = dateVal;
      tx.type = typeVal;
      tx.description = descVal;
      tx.amount = amt;

      saveToStorage();
      refreshUI();
      closeTransactionEditModal();
    }

    function deleteTransaction() {
      if (!currentEditingTxId) return;
      transactions = transactions.filter((t) => t.id !== currentEditingTxId);
      saveToStorage();
      refreshUI();
      closeTransactionEditModal();
    }

    function openDirectDebitEditModal(baseId) {
      currentEditingDdBaseId = baseId;
      currentEditingDdMonthKey = monthKey(selectedMonth);

      const base = directDebits.find((d) => d.id === baseId);
      if (!base) return;

      const mk = monthKey(selectedMonth);
      const override = ddOverrides.find((ov) => ov.baseId === baseId && ov.month === mk);

      let effective = { name: base.name, amount: base.amount, day: base.day, category: base.category, active: base.active };

      if (override) {
        if (override.type === "modified") {
          effective = { name: override.name, amount: override.amount, day: override.day, category: override.category, active: override.active };
        } else if (override.type === "skipped") {
          effective.active = false;
        }
      }

      document.getElementById("editDdName").value = effective.name;
      document.getElementById("editDdAmt").value = effective.amount.toFixed(2);
      document.getElementById("editDdDay").value = effective.day;
      document.getElementById("editDdCat").value = effective.category || "";

      const pausedToggle = document.getElementById("ddPausedToggle");
      pausedToggle.classList.toggle("on", !effective.active);

      document.getElementById("ddModal").style.display = "flex";
    }

    function closeDirectDebitEditModal() {
      document.getElementById("ddModal").style.display = "none";
      currentEditingDdBaseId = null;
      currentEditingDdMonthKey = null;
    }

    function toggleDdPaused() {
      document.getElementById("ddPausedToggle").classList.toggle("on");
    }

    function saveDirectDebitEdit() {
      if (!currentEditingDdBaseId || !currentEditingDdMonthKey) return;

      const base = directDebits.find((d) => d.id === currentEditingDdBaseId);
      if (!base) return;

      const nameVal = document.getElementById("editDdName").value.trim();
      const amtStr = document.getElementById("editDdAmt").value.replace(",", ".");
      const amt = parseFloat(amtStr);
      const dayVal = parseInt(document.getElementById("editDdDay").value, 10);
      const catVal = document.getElementById("editDdCat").value.trim();
      const paused = document.getElementById("ddPausedToggle").classList.contains("on");

      if (!nameVal || !isFinite(amt) || !isFinite(dayVal)) return;
      if (dayVal < 1 || dayVal > 31) return;

      let override = ddOverrides.find((ov) => ov.baseId === currentEditingDdBaseId && ov.month === currentEditingDdMonthKey);

      if (!override) {
        override = { baseId: currentEditingDdBaseId, month: currentEditingDdMonthKey, type: "none", active: base.active };
        ddOverrides.push(override);
      }

      override.type = "modified";
      override.name = nameVal;
      override.amount = amt;
      override.day = dayVal;
      override.category = catVal;
      override.active = !paused;

      if (
        override.name === base.name &&
        override.amount === base.amount &&
        override.day === base.day &&
        (override.category || "") === (base.category || "") &&
        override.active === base.active
      ) {
        ddOverrides = ddOverrides.filter((ov) => !(ov.baseId === currentEditingDdBaseId && ov.month === currentEditingDdMonthKey));
      }

      saveToStorage();
      closeDirectDebitEditModal();
      refreshUI();
    }

    function deleteDirectDebitForMonth() {
      if (!currentEditingDdBaseId || !currentEditingDdMonthKey) return;

      let override = ddOverrides.find((ov) => ov.baseId === currentEditingDdBaseId && ov.month === currentEditingDdMonthKey);

      if (!override) {
        override = { baseId: currentEditingDdBaseId, month: currentEditingDdMonthKey, type: "skipped", active: false };
        ddOverrides.push(override);
      } else {
        override.type = "skipped";
        override.active = false;
      }

      saveToStorage();
      closeDirectDebitEditModal();
      refreshUI();
    }

    // ------------ DONUT BREAKDOWN ------------

    function openDonutBreakdown() {
      const thisTotals = computeMonthWithCarry(selectedMonth);
      const carryIn = thisTotals.carryIn;
      const thisIncome = thisTotals.income;
      const thisSpend = thisTotals.spend;
      const thisDd = thisTotals.ddTotal;
      const thisAfter = thisTotals.afterAll;

      const prevMonth = new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1, 1);
      const prevTotals = computeMonthWithCarry(prevMonth);
      const lastMonthAfter = prevTotals.afterAll;
      const lastMonthIncomeTotal = prevTotals.income + prevTotals.carryIn;

      document.getElementById("bdIncome").textContent = formatMoney(thisIncome);
      document.getElementById("bdDd").textContent = formatMoney(thisDd);
      document.getElementById("bdSpend").textContent = formatMoney(thisSpend);
      document.getElementById("bdCarry").textContent = formatMoney(carryIn);
      document.getElementById("bdAfter").textContent = formatMoney(thisAfter);

      const diffAfter = thisAfter - lastMonthAfter;
      const diffIncome = (thisIncome + carryIn) - lastMonthIncomeTotal;
      const diffSpend = thisSpend - prevTotals.spend;

      const afterLabel =
        !isFinite(lastMonthAfter) || lastMonthAfter === 0
          ? "–"
          : `${diffAfter >= 0 ? "+" : "−"}${formatMoney(Math.abs(diffAfter)).replace("£", "")}`;
      const incomeLabel =
        !isFinite(lastMonthIncomeTotal) || lastMonthIncomeTotal === 0
          ? "–"
          : `${diffIncome >= 0 ? "+" : "−"}${formatMoney(Math.abs(diffIncome)).replace("£", "")}`;
      const spendLabel =
        !isFinite(prevTotals.spend) || prevTotals.spend === 0
          ? "–"
          : `${diffSpend >= 0 ? "+" : "−"}${formatMoney(Math.abs(diffSpend)).replace("£", "")}`;

      document.getElementById("compareAfter").textContent = afterLabel;
      document.getElementById("compareIncome").textContent = incomeLabel;
      document.getElementById("compareSpend").textContent = spendLabel;

      const donutBig = document.getElementById("donutBig");
      const effectiveIncome = carryIn + thisIncome;
      const totalOut = thisDd + thisSpend;
      drawDonut(donutBig, effectiveIncome, totalOut);

      document.getElementById("donutBreakdown").style.display = "block";
    }

    function closeDonutBreakdown() {
      document.getElementById("donutBreakdown").style.display = "none";
    }

    // ------------ EXPORT & RESET ------------

    function exportAllData() {
      function esc(str) {
        if (str == null) str = "";
        str = String(str).replace(/"/g, '""');
        return `"${str}"`;
      }

      const lines = [];
      lines.push([
        "RowType","MonthKey","Date","TxType","Description","TxAmount",
        "DDName","DDAmount","DDDay","DDCategory","DDActive",
        "OverrideMonth","OverrideType","OverrideAmount","OverrideDay","OverrideCategory","OverrideActive"
      ].join(","));

      for (const t of transactions) {
        if (isAutoOpening(t)) continue;
        const d = new Date(t.date);
        const mk = Number.isNaN(d.getTime()) ? "" : monthKey(d);
        lines.push([
          "TRANSACTION", mk, t.date || "", t.type || "", esc(t.description || ""),
          t.amount != null ? t.amount.toFixed(2) : "",
          "","","","","","","","","","",""
        ].join(","));
      }

      for (const dd of directDebits) {
        lines.push([
          "DIRECT_DEBIT", dd.month || "", "","","","",
          esc(dd.name || ""),
          dd.amount != null ? dd.amount.toFixed(2) : "",
          dd.day != null ? String(dd.day) : "",
          esc(dd.category || ""),
          dd.active ? "Yes" : "No",
          "","","","","",""
        ].join(","));
      }

      for (const ov of ddOverrides) {
        lines.push([
          "DD_OVERRIDE", ov.month || "", "","","","",
          "","","","","",
          ov.month || "",
          ov.type || "",
          ov.amount != null ? ov.amount.toFixed(2) : "",
          ov.day != null ? String(ov.day) : "",
          esc(ov.category || ""),
          ov.active === false ? "No" : "Yes"
        ].join(","));
      }

      const csv = lines.join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "BishopBudget-AllData.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function resetApp() {
      const ok = confirm("This will delete ALL transactions, direct debits and overrides.\n\nAre you sure?");
      if (!ok) return;

      localStorage.removeItem("bb_tx");
      localStorage.removeItem("bb_dd");
      localStorage.removeItem("bb_dd_overrides");
      transactions = [];
      directDebits = [];
      ddOverrides = [];
      selectedMonth = firstOfMonth(new Date());
      refreshUI();
    }

    // ------------ INIT ------------

    function init() {
      loadFromStorage();
      selectedMonth = firstOfMonth(new Date());

      const today = new Date();
      document.getElementById("txDate").value = today.toISOString().slice(0, 10);

      document.getElementById("prevMonthBtn").addEventListener("click", () => {
        selectedMonth = new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1, 1);
        refreshUI();
      });

      document.getElementById("nextMonthBtn").addEventListener("click", () => {
        selectedMonth = new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1, 1);
        refreshUI();
      });

      document.getElementById("addTxBtn").addEventListener("click", addTransaction);
      document.getElementById("addDdBtn").addEventListener("click", addDirectDebit);

      document.getElementById("donutCanvas").addEventListener("click", openDonutBreakdown);
      document.getElementById("seeMoreDonut").addEventListener("click", openDonutBreakdown);
      document.getElementById("closeDonutBreakdown").addEventListener("click", closeDonutBreakdown);

      document.getElementById("txModalDone").addEventListener("click", closeTransactionEditModal);
      document.getElementById("saveTxBtn").addEventListener("click", saveTransactionEdit);
      document.getElementById("deleteTxBtn").addEventListener("click", deleteTransaction);

      document.getElementById("ddModalDone").addEventListener("click", closeDirectDebitEditModal);
      document.getElementById("ddPausedToggle").addEventListener("click", toggleDdPaused);
      document.getElementById("saveDdBtn").addEventListener("click", saveDirectDebitEdit);
      document.getElementById("deleteDdBtn").addEventListener("click", deleteDirectDebitForMonth);

      document.getElementById("exportCsvBtn").addEventListener("click", exportAllData);
      document.getElementById("resetAppBtn").addEventListener("click", resetApp);

      refreshUI();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
