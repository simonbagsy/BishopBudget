<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>BishopBudget</title>

  <!-- Prevent double-tap zoom as well -->
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    html, body { touch-action: manipulation; }
  </style>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#071028;
      --bg2:#0b1120;

      --card:#0f172a;
      --card2:#101b33;
      --pill:#121f3a;

      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(96,165,250,.28);

      --text:#e5e7eb;
      --soft:#9ca3af;
      --muted:#6b7280;

      --blue1:#1d4ed8;
      --blue2:#38bdf8;
      --green:#22c55e;
      --greenSoft:#bbf7d0;
      --red:#fb7185;
      --amber:#f59e0b;

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:14px;
    }

    *{
      box-sizing:border-box;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,Segoe UI,Roboto,Arial;
    }

    body{
      margin:0;
      color:var(--text);
      background: radial-gradient(1200px 1200px at 20% -10%, rgba(56,189,248,.22), transparent 55%),
                  radial-gradient(1000px 1000px at 90% 10%, rgba(34,197,94,.14), transparent 55%),
                  linear-gradient(135deg, var(--bg0), var(--bg1) 40%, var(--bg2));
      min-height:100vh;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 40px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brandIcon{
      width: 64px;
      height: 64px;
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
      background: rgba(255,255,255,.03);
      flex: 0 0 auto;
    }
    .brandIcon img{ width:100%; height:100%; object-fit:cover; display:block; }

    .brandText h1{
      font-size:18px;
      margin:0;
      letter-spacing:.2px;
    }
    .brandText p{
      margin:4px 0 0 0;
      color:var(--soft);
      font-size:12px;
      line-height:1.2;
    }

    .monthNav{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .pillBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight: 800;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.28);
      transition: transform .06s ease, filter .15s ease;
      user-select:none;
    }
    .pillBtn:active{ transform: translateY(1px); filter: brightness(1.05); }
    .pillBtn.primary{
      border-color: rgba(255,255,255,.18);
      background: linear-gradient(135deg, rgba(29,78,216,.95), rgba(56,189,248,.75));
    }
    .pillBtn.danger{
      border-color: rgba(251,113,133,.35);
      background: rgba(251,113,133,.12);
      color: var(--text);
    }
    .pillBtn.small{
      padding:8px 10px;
      font-size:12px;
      border-radius: 12px;
      box-shadow: none;
    }
    .pillBtn.ghost{
      background: rgba(255,255,255,.04);
      box-shadow:none;
    }

    .card{
      background: rgba(15,23,42,.86);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 14px;
      backdrop-filter: blur(10px);
    }

    .cardTitle{
      margin:0 0 10px 0;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .subtle{
      margin: 0;
      color: var(--soft);
      font-size: 12px;
      line-height:1.3;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px){
      .grid2{ grid-template-columns: 1fr; }
      .brandIcon{ width:56px; height:56px; border-radius:16px; }
    }

    .pill{
      background: rgba(18,31,58,.9);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 10px 10px;
      min-height: 76px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 3px;
    }

    .pill .label{
      font-size: 12px;
      color: var(--soft);
      font-weight: 700;
    }
    .pill .hint{
      font-size: 11px;
      color: var(--muted);
    }
    .pill .value{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      margin-top: 2px;
    }

    .value.blue{ color: #93c5fd; }
    .value.green{ color: var(--green); }
    .value.red{ color: var(--red); }
    .value.white{ color: var(--text); }
    .value.amber{ color: #fbbf24; }

    .donutRow{
      display:flex;
      align-items:flex-start;
      justify-content:center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .donutCard{
      width: 100%;
      max-width: 880px;
      border-radius: 22px;
      padding: 16px;
      background: linear-gradient(180deg, rgba(16,27,51,.92), rgba(15,23,42,.86));
      border: 1px solid rgba(255,255,255,.12);
      cursor:pointer;
      user-select:none;
    }

    .donutInner{
      display:flex;
      align-items:flex-start;
      gap: 16px;
    }
    @media (max-width: 720px){
      .donutInner{ flex-direction: column; align-items:center; }
    }

    .donutWrap{
      width: 190px;
      height: 190px;
      position: relative;
      flex: 0 0 auto;
    }

    .donutCenter{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 3px;
      text-align:center;
      pointer-events:none;
    }
    .donutCenter .pct{
      font-size: 34px;
      font-weight: 1000;
      letter-spacing:.3px;
    }
    .donutCenter .sub{
      font-size: 12px;
      color: var(--soft);
      text-transform: uppercase;
      letter-spacing: .18em;
    }

    .donutText{
      flex: 1 1 auto;
      min-width: 260px;
    }

    .donutText h3{
      margin: 2px 0 6px 0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .donutText p{
      margin: 0;
      color: var(--soft);
      font-size: 13px;
      line-height: 1.35;
    }

    .miniGraph{
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(2,6,23,.25);
      padding: 10px;
    }

    .miniGraph .title{
      color: var(--soft);
      font-size: 12px;
      font-weight: 800;
      margin-bottom: 6px;
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 720px){
      .formGrid{ grid-template-columns: 1fr; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .field label{
      font-size: 12px;
      color: var(--soft);
      font-weight: 800;
    }
    .control{
      width: 100%;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(96,165,250,.45);
      background: rgba(15,23,42,.55);
      color: var(--text);
      padding: 0 12px;
      font-weight: 800;
      outline: none;
    }
    .control:focus{
      border-color: rgba(56,189,248,.75);
      box-shadow: 0 0 0 3px rgba(56,189,248,.18);
    }
    .control::placeholder{
      color: rgba(156,163,175,.7);
      font-weight: 700;
    }

    .rowBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      margin-top: 10px;
    }

    .listBox{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(2,6,23,.20);
      padding: 10px;
      max-height: 520px; /* Taller so you see more items */
      overflow:auto;
    }

    .listHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .listHead .title{
      font-size: 13px;
      color: var(--soft);
      font-weight: 900;
    }

    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(15,23,42,.55);
      margin-bottom: 8px;
    }
    .item:last-child{ margin-bottom: 0; }

    .item .left{
      display:flex;
      flex-direction:column;
      gap: 3px;
      min-width: 0;
    }
    .item .name{
      font-weight: 900;
      font-size: 16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 440px;
    }
    .item .meta{
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .2px;
    }

    .item .right{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
    }

    .amount{
      font-weight: 1000;
      font-size: 18px;
      min-width: 110px;
      text-align:right;
      letter-spacing:.2px;
    }

    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .badge.red{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.12); color: var(--red); }
    .badge.green{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); color: var(--greenSoft); }
    .badge.blue{ border-color: rgba(96,165,250,.35); background: rgba(96,165,250,.12); color: #93c5fd; }

    .mutedRow{
      opacity: .75;
      border-color: rgba(251,113,133,.24);
    }

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      z-index: 1000;
    }
    .modalBackdrop.show{ display:flex; }

    .modal{
      width: 100%;
      max-width: 920px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(16,27,51,.98), rgba(15,23,42,.95));
      box-shadow: 0 30px 70px rgba(0,0,0,.6);
      overflow:hidden;
      max-height: 88vh;
      display:flex;
      flex-direction:column;
    }

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalHeader .title{
      font-weight: 1000;
      letter-spacing: .2px;
    }
    .modalBody{
      padding: 14px;
      overflow:auto;
    }

    .hr{
      height: 1px;
      background: rgba(255,255,255,.10);
      margin: 12px 0;
    }

    a{ color: inherit; }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="brandIcon" title="App Icon">
          <!-- Replace path if needed -->
          <img src="icon-512.png" alt="App Icon" />
        </div>
        <div class="brandText">
          <h1>22 Bishop Road Budget</h1>
          <p>Monthly snapshot budgeting. Direct debits are per-month, carry-forward is automatic.</p>
        </div>
      </div>

      <div class="monthNav">
        <button class="pillBtn ghost" id="prevMonthBtn">◀</button>
        <button class="pillBtn ghost" id="nextMonthBtn">▶</button>
      </div>
    </div>

    <div class="card">
      <div class="grid2" style="align-items:stretch">
        <div class="pill">
          <div class="label">Month</div>
          <div class="hint">Current view</div>
          <div class="value blue" id="monthLabel">—</div>
        </div>
        <div class="pill">
          <div class="label">Carry-forward</div>
          <div class="hint">Opening balance (auto)</div>
          <div class="value white" id="openingValue">—</div>
        </div>
      </div>

      <div style="margin-top:10px" id="copyDDBanner" class="pill" hidden>
        <div class="label">Direct debits for this month</div>
        <div class="hint">This month has no direct debits yet. Want to copy them from last month?</div>
        <div class="rowBtns">
          <button class="pillBtn primary" id="copyDDBtn">Copy last month’s direct debits</button>
          <button class="pillBtn ghost" id="dismissCopyDDBtn">Not now</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="grid2">
        <div class="pill">
          <div class="label">Monthly income</div>
          <div class="hint">Including opening balance</div>
          <div class="value blue" id="incomeTotal">£0.00</div>
        </div>
        <div class="pill" style="background: rgba(18,31,58,.95)">
          <div class="label">Direct Debits & Bills</div>
          <div class="hint">This month only</div>
          <div class="value white" id="ddTotal">£0.00</div>
        </div>
        <div class="pill">
          <div class="label">Other Spending</div>
          <div class="hint">This month</div>
          <div class="value red" id="spendTotal">£0.00</div>
        </div>
        <div class="pill" id="leftPill">
          <div class="label">Left after Spending</div>
          <div class="hint">As of now</div>
          <div class="value green" id="leftTotal">£0.00</div>
        </div>
      </div>

      <div style="margin-top:12px" class="donutRow">
        <div class="donutCard" id="donutCard" title="Tap for details">
          <div class="donutInner">
            <div class="donutWrap">
              <svg viewBox="0 0 120 120" width="190" height="190" style="display:block">
                <defs>
                  <linearGradient id="gLine" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#93c5fd"></stop>
                    <stop offset="55%" stop-color="#22c55e"></stop>
                    <stop offset="100%" stop-color="#38bdf8"></stop>
                  </linearGradient>
                  <filter id="glow">
                    <feGaussianBlur stdDeviation="2.2" result="blur"></feGaussianBlur>
                    <feMerge>
                      <feMergeNode in="blur"></feMergeNode>
                      <feMergeNode in="SourceGraphic"></feMergeNode>
                    </feMerge>
                  </filter>
                </defs>

                <circle cx="60" cy="60" r="44" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="10"></circle>
                <circle id="donutArc"
                        cx="60" cy="60" r="44"
                        fill="none"
                        stroke="url(#gLine)"
                        stroke-width="10"
                        stroke-linecap="round"
                        stroke-dasharray="0 276"
                        transform="rotate(-90 60 60)"
                        filter="url(#glow)"></circle>
              </svg>
              <div class="donutCenter">
                <div class="pct" id="donutPct">0%</div>
                <div class="sub">income left</div>
              </div>
            </div>

            <div class="donutText">
              <h3 id="donutHeadline">Waiting for income</h3>
              <p id="donutSubtext">Add salary and bills to see how much is left.</p>

              <div class="miniGraph">
                <div class="title">Daily balance this month</div>
                <canvas id="miniCanvas" height="90"></canvas>
              </div>

              <div class="rowBtns" style="margin-top:10px">
                <button class="pillBtn ghost" id="whatIfResetBtn">Reset “What if” to zero</button>
              </div>

              <div style="margin-top:10px">
                <div class="subtle">What if the month changed by…</div>
                <input id="whatIf" type="range" min="-5000" max="5000" step="10" value="0" style="width:100%; margin-top:8px">
                <div class="subtle" id="whatIfLabel" style="margin-top:6px">Change: £0.00</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Transactions -->
    <div class="card">
      <h2 class="cardTitle">Add transaction (one-off)</h2>

      <div class="formGrid">
        <div class="field">
          <label>Date</label>
          <input class="control" id="txDate" type="date" />
        </div>

        <div class="field">
          <label>Type</label>
          <select class="control" id="txType">
            <option value="income">Income</option>
            <option value="spend">Spending</option>
          </select>
        </div>

        <div class="field" style="grid-column: 1 / -1">
          <label>Description</label>
          <input class="control" id="txDesc" type="text" placeholder="e.g. RN salary, Tesco shop" />
        </div>

        <div class="field" style="grid-column: 1 / -1">
          <label>Amount</label>
          <input class="control" id="txAmount" inputmode="decimal" type="text" placeholder="0.00" />
        </div>
      </div>

      <div class="rowBtns">
        <button class="pillBtn primary" id="addTxBtn">Add transaction</button>
      </div>

      <div class="listBox">
        <div class="listHead">
          <div class="title">Transactions this month</div>
        </div>
        <div id="txList"></div>
      </div>
    </div>

    <!-- Direct debits -->
    <div class="card">
      <h2 class="cardTitle">Direct debits & regular bills</h2>

      <div class="formGrid">
        <div class="field" style="grid-column: 1 / -1">
          <label>Name</label>
          <input class="control" id="ddName" type="text" placeholder="e.g. Mortgage, Council tax" />
        </div>

        <div class="field">
          <label>Amount (per month)</label>
          <input class="control" id="ddAmount" inputmode="decimal" type="text" placeholder="0.00" />
        </div>

        <div class="field">
          <label>Day of month (1–31)</label>
          <input class="control" id="ddDay" inputmode="numeric" type="text" placeholder="1" />
        </div>

        <div class="field" style="grid-column: 1 / -1">
          <label>Category</label>
          <input class="control" id="ddCategory" type="text" placeholder="Utilities, Housing, Subscription..." />
        </div>
      </div>

      <div class="rowBtns">
        <button class="pillBtn ghost" id="addDDBtn">Add direct debit</button>
      </div>

      <div class="listBox">
        <div class="listHead">
          <div class="title">Direct debits this month</div>
        </div>
        <div id="ddList"></div>
      </div>
    </div>

    <!-- Export / Reset -->
    <div class="card">
      <div class="rowBtns">
        <button class="pillBtn" id="exportBtn">Export all data (CSV)</button>
        <button class="pillBtn danger" id="resetBtn">Reset app (delete everything)</button>
      </div>
      <p class="subtle" style="margin-top:10px">
        Export creates <b>BishopBudget-AllData.csv</b> in the exact column format you showed.
      </p>
    </div>

  </div>

  <!-- Donut detail modal -->
  <div class="modalBackdrop" id="donutModalBackdrop" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="title" id="donutModalTitle">Monthly Breakdown</div>
        <button class="pillBtn ghost small" id="closeDonutModalBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div class="pill">
            <div class="label">Income</div>
            <div class="hint">This month</div>
            <div class="value blue" id="mIncome">£0.00</div>
          </div>
          <div class="pill">
            <div class="label">Direct Debits</div>
            <div class="hint">Active this month</div>
            <div class="value white" id="mDD">£0.00</div>
          </div>
          <div class="pill">
            <div class="label">Spending</div>
            <div class="hint">This month</div>
            <div class="value red" id="mSpend">£0.00</div>
          </div>
          <div class="pill">
            <div class="label">Left</div>
            <div class="hint">After bills + spending</div>
            <div class="value green" id="mLeft">£0.00</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="subtle" style="margin-bottom:10px">Tap items to edit (month-specific).</div>

        <div class="grid2">
          <div class="card" style="margin:0; box-shadow:none">
            <div class="listHead">
              <div class="title">Transactions</div>
            </div>
            <div class="listBox" style="max-height: 240px">
              <div id="modalTxList"></div>
            </div>
          </div>

          <div class="card" style="margin:0; box-shadow:none">
            <div class="listHead">
              <div class="title">Direct debits</div>
            </div>
            <div class="listBox" style="max-height: 240px">
              <div id="modalDDList"></div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="subtle">Tip: if your mortgage changes next month, edit the <b>next month</b> row only.</div>
      </div>
    </div>
  </div>

  <!-- Editor modal (reused) -->
  <div class="modalBackdrop" id="editModalBackdrop" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="title" id="editTitle">Edit</div>
        <button class="pillBtn ghost small" id="closeEditModalBtn">Close</button>
      </div>
      <div class="modalBody" id="editBody"></div>
    </div>
  </div>

  <script>
    // ========= Storage (Monthly Snapshot Model) =========
    const STORAGE_KEY = "BishopBudget_Snapshot_v1";

    const state = {
      selectedMonth: monthKeyFromDate(new Date()),
      data: {
        transactions: [],
        directDebits: []
      },
      dismissedCopyDDBanner: {}
    };

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && parsed.data){
            state.selectedMonth = parsed.selectedMonth || state.selectedMonth;
            state.data = parsed.data || state.data;
            state.dismissedCopyDDBanner = parsed.dismissedCopyDDBanner || {};
          }
        }
      }catch(e){
        console.warn("Load failed:", e);
      }
    }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        selectedMonth: state.selectedMonth,
        data: state.data,
        dismissedCopyDDBanner: state.dismissedCopyDDBanner
      }));
    }

    // ========= Utilities =========
    function uid(){
      return (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2);
    }

    function monthKeyFromDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }

    function dateISOToMonthKey(iso){
      // iso: YYYY-MM-DD
      if(!iso || iso.length < 7) return "";
      return iso.slice(0,7);
    }

    function monthKeyToLabel(mk){
      // mk: YYYY-MM
      const [y,m] = mk.split("-").map(Number);
      const d = new Date(y, (m||1)-1, 1);
      const mmm = d.toLocaleString("en-GB",{month:"short"});
      const yy = String(y).slice(-2);
      return `${mmm} ${yy}`;
    }

    function fmtMoney(n){
      const v = Number(n || 0);
      return v.toLocaleString("en-GB", { style:"currency", currency:"GBP", minimumFractionDigits:2, maximumFractionDigits:2 });
    }

    function fmtDateDisplay(iso){
      // DD-Mmm-YY
      if(!iso) return "";
      const [y,m,d] = iso.split("-").map(Number);
      const dt = new Date(y, (m||1)-1, d||1);
      const dd = String(dt.getDate()).padStart(2,"0");
      const mmm = dt.toLocaleString("en-GB",{month:"short"});
      const yy = String(dt.getFullYear()).slice(-2);
      return `${dd}-${mmm}-${yy}`;
    }

    function parseAmount(str){
      if(str == null) return NaN;
      const s = String(str).trim().replaceAll(",", ".");
      const v = Number(s);
      return Number.isFinite(v) ? v : NaN;
    }

    function parseIntSafe(str){
      const v = parseInt(String(str).trim(), 10);
      return Number.isFinite(v) ? v : NaN;
    }

    function prevMonthKey(mk){
      const [y,m] = mk.split("-").map(Number);
      const d = new Date(y, (m||1)-1, 1);
      d.setMonth(d.getMonth()-1);
      return monthKeyFromDate(d);
    }

    function nextMonthKey(mk){
      const [y,m] = mk.split("-").map(Number);
      const d = new Date(y, (m||1)-1, 1);
      d.setMonth(d.getMonth()+1);
      return monthKeyFromDate(d);
    }

    function monthRangeKeys(minMK, maxMK){
      // inclusive
      const keys = [];
      let cur = minMK;
      while(true){
        keys.push(cur);
        if(cur === maxMK) break;
        cur = nextMonthKey(cur);
        if(keys.length > 600) break;
      }
      return keys;
    }

    function allMonthKeysFromData(){
      const set = new Set();
      state.data.transactions.forEach(t => set.add(t.monthKey));
      state.data.directDebits.forEach(d => set.add(d.monthKey));
      return Array.from(set).sort();
    }

    // ========= Carry-forward chain (auto opening balances) =========
    function monthTotals(mk){
      const tx = state.data.transactions.filter(t => t.monthKey === mk);
      const dds = state.data.directDebits.filter(d => d.monthKey === mk && d.active === true);

      const income = tx.filter(t => t.type === "income").reduce((a,b)=>a + (Number(b.amount)||0), 0);
      const spend  = tx.filter(t => t.type === "spend").reduce((a,b)=>a + (Number(b.amount)||0), 0);
      const dd     = dds.reduce((a,b)=>a + (Number(b.amount)||0), 0);

      const left = income - dd - spend;
      return { income, spend, dd, left };
    }

    function getOpeningTx(mk){
      return state.data.transactions.find(t => t.monthKey === mk && t.isAutoOpening === true);
    }

    function setOpeningTx(mk, amount){
      const existing = getOpeningTx(mk);
      if(existing){
        existing.amount = amount;
        existing.dateISO = `${mk}-01`;
        existing.description = "Opening balance (auto)";
        existing.type = "income";
      }else{
        state.data.transactions.push({
          id: uid(),
          monthKey: mk,
          dateISO: `${mk}-01`,
          type: "income",
          description: "Opening balance (auto)",
          amount: amount,
          isAutoOpening: true
        });
      }
    }

    function removeOpeningTx(mk){
      state.data.transactions = state.data.transactions.filter(t => !(t.monthKey === mk && t.isAutoOpening === true));
    }

    function recomputeCarryChain(){
      const keys = allMonthKeysFromData();
      if(keys.length === 0) return;

      const minMK = keys[0];
      const maxMK = keys[keys.length - 1];

      // Build continuous chain across months, even if some are "empty"
      const chain = monthRangeKeys(minMK, maxMK);

      // First month: no opening balance
      removeOpeningTx(chain[0]);

      for(let i=1;i<chain.length;i++){
        const prev = chain[i-1];
        const cur  = chain[i];

        const prevTotals = monthTotals(prev);
        const carry = prevTotals.left;

        // Only create opening if there is ANY reason the month exists (has tx or dd) OR carry is non-zero
        const hasAnyCur =
          state.data.transactions.some(t => t.monthKey === cur && !t.isAutoOpening) ||
          state.data.directDebits.some(d => d.monthKey === cur);

        if(hasAnyCur || carry !== 0){
          setOpeningTx(cur, carry);
        }else{
          // no data and nothing to carry, keep it clean
          removeOpeningTx(cur);
        }
      }
    }

    // ========= UI state =========
    const els = {};
    function bindEls(){
      const ids = [
        "monthLabel","openingValue",
        "incomeTotal","ddTotal","spendTotal","leftTotal","leftPill",
        "donutArc","donutPct","donutHeadline","donutSubtext",
        "miniCanvas","whatIf","whatIfLabel","whatIfResetBtn",
        "txDate","txType","txDesc","txAmount","addTxBtn","txList",
        "ddName","ddAmount","ddDay","ddCategory","addDDBtn","ddList",
        "prevMonthBtn","nextMonthBtn",
        "exportBtn","resetBtn",
        "donutCard","donutModalBackdrop","closeDonutModalBtn",
        "donutModalTitle","mIncome","mDD","mSpend","mLeft","modalTxList","modalDDList",
        "editModalBackdrop","closeEditModalBtn","editTitle","editBody",
        "copyDDBanner","copyDDBtn","dismissCopyDDBtn"
      ];
      ids.forEach(id => els[id] = document.getElementById(id));
    }

    // ========= What-if =========
    let whatIfOffset = 0;

    function applyWhatIfLabel(){
      const sign = whatIfOffset === 0 ? "" : (whatIfOffset > 0 ? "+" : "−");
      els.whatIfLabel.textContent = `Change: ${sign}${fmtMoney(Math.abs(whatIfOffset))}`;
    }

    function resetWhatIf(){
      whatIfOffset = 0;
      els.whatIf.value = "0";
      applyWhatIfLabel();
      render();
    }

    // ========= Data getters for current month =========
    function currentTransactions(){
      return state.data.transactions
        .filter(t => t.monthKey === state.selectedMonth)
        .slice()
        .sort((a,b)=> (b.dateISO || "").localeCompare(a.dateISO || ""));
    }

    function currentDirectDebits(){
      return state.data.directDebits
        .filter(d => d.monthKey === state.selectedMonth)
        .slice()
        .sort((a,b)=> (a.day - b.day) || (a.name||"").localeCompare(b.name||""));
    }

    // ========= Copy DDs forward helper =========
    function shouldShowCopyDDPrompt(){
      const mk = state.selectedMonth;
      const hasDD = state.data.directDebits.some(d => d.monthKey === mk);
      if(hasDD) return false;

      const prev = prevMonthKey(mk);
      const prevHas = state.data.directDebits.some(d => d.monthKey === prev);
      if(!prevHas) return false;

      if(state.dismissedCopyDDBanner[mk]) return false;
      return true;
    }

    function copyDDsFromPreviousMonth(){
      const mk = state.selectedMonth;
      const prev = prevMonthKey(mk);
      const prevDDs = state.data.directDebits.filter(d => d.monthKey === prev);
      if(prevDDs.length === 0) return;

      // Prevent duplicates
      if(state.data.directDebits.some(d => d.monthKey === mk)) return;

      prevDDs.forEach(d => {
        state.data.directDebits.push({
          id: uid(),
          monthKey: mk,
          name: d.name,
          amount: d.amount,
          day: d.day,
          category: d.category,
          active: d.active
        });
      });

      save();
      render();
    }

    // ========= Rendering =========
    function render(){
      // Ensure carry-forward is correct after any changes
      recomputeCarryChain();
      save();

      els.monthLabel.textContent = monthKeyToLabel(state.selectedMonth);

      // Opening balance display
      const openTx = getOpeningTx(state.selectedMonth);
      els.openingValue.textContent = openTx ? fmtMoney(openTx.amount) : "—";

      // Totals
      const { income, spend, dd, left } = monthTotals(state.selectedMonth);

      els.incomeTotal.textContent = fmtMoney(income);
      els.spendTotal.textContent = fmtMoney(spend);
      els.ddTotal.textContent = fmtMoney(dd);

      const leftAfter = left - whatIfOffset;
      els.leftTotal.textContent = fmtMoney(leftAfter);

      // Colour pill
      els.leftTotal.classList.remove("green","red","amber");
      if(leftAfter > 0){
        els.leftTotal.classList.add("green");
        els.leftPill.style.background = "rgba(34,197,94,.14)";
      }else if(leftAfter === 0){
        els.leftTotal.classList.add("amber");
        els.leftPill.style.background = "rgba(245,158,11,.14)";
      }else{
        els.leftTotal.classList.add("red");
        els.leftPill.style.background = "rgba(251,113,133,.14)";
      }

      // Donut percent = income left as % of income (guard)
      let pct = 0;
      if(income > 0){
        pct = Math.max(0, Math.min(100, (leftAfter / income) * 100));
      }
      els.donutPct.textContent = `${Math.round(pct)}%`;

      // Donut arc (circumference approx 2πr with r=44 -> 276.46)
      const C = 276;
      const dash = (pct/100) * C;
      els.donutArc.setAttribute("stroke-dasharray", `${dash} ${C - dash}`);

      // Headline / text
      if(income <= 0){
        els.donutHeadline.textContent = "Waiting for income";
        els.donutHeadline.style.color = "var(--text)";
        els.donutSubtext.textContent = "Add salary and bills to see how much is left.";
      }else if(leftAfter > 0){
        els.donutHeadline.textContent = "You’re in the green";
        els.donutHeadline.style.color = "var(--greenSoft)";
        els.donutSubtext.textContent = `${fmtMoney(leftAfter)} left after this month’s direct debits and spending.`;
      }else if(leftAfter === 0){
        els.donutHeadline.textContent = "Every pound is allocated";
        els.donutHeadline.style.color = "var(--text)";
        els.donutSubtext.textContent = "You’ve used 100% of this month’s income.";
      }else{
        els.donutHeadline.textContent = "Spending over income";
        els.donutHeadline.style.color = "var(--red)";
        els.donutSubtext.textContent = `Over by ${fmtMoney(Math.abs(leftAfter))} this month.`;
      }

      // Transactions list
      renderTransactions();

      // DD list
      renderDirectDebits();

      // Copy-DD prompt
      els.copyDDBanner.hidden = !shouldShowCopyDDPrompt();

      // Mini graph
      drawMiniGraph();

      // Donut modal values (if open)
      if(els.donutModalBackdrop.classList.contains("show")){
        renderDonutModal();
      }
    }

    function renderTransactions(targetEl = els.txList){
      const txs = currentTransactions().filter(t => !t.isAutoOpening || true); // show opening too (useful)
      if(txs.length === 0){
        targetEl.innerHTML = `<div class="subtle">No transactions yet.</div>`;
        return;
      }

      targetEl.innerHTML = txs.map(t => {
        const amtClass = (t.type === "income") ? "green" : "red";
        const typeLabel = (t.type === "income") ? "Income" : "Spending";
        const meta = `${fmtDateDisplay(t.dateISO)} · ${typeLabel}${t.isAutoOpening ? " · Auto" : ""}`;
        return `
          <div class="item">
            <div class="left">
              <div class="name">${escapeHtml(t.description || "")}</div>
              <div class="meta">${escapeHtml(meta)}</div>
            </div>
            <div class="right">
              <div class="amount" style="color:${t.type === "income" ? "var(--green)" : "var(--red)"}">${fmtMoney(t.amount)}</div>
              <button class="pillBtn small ghost" data-edit-tx="${t.id}" style="position:relative; top:-1px;">Edit</button>
            </div>
          </div>
        `;
      }).join("");

      targetEl.querySelectorAll("[data-edit-tx]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-edit-tx");
          openTxEditor(id);
        });
      });
    }

    function renderDirectDebits(targetEl = els.ddList){
      const dds = currentDirectDebits();
      if(dds.length === 0){
        targetEl.innerHTML = `<div class="subtle">No direct debits yet for this month.</div>`;
        return;
      }

      targetEl.innerHTML = dds.map(d => {
        const isActive = d.active === true;
        const meta = `${fmtMoney(d.amount)} · day ${d.day}${d.category ? " · " + d.category : ""}`;
        return `
          <div class="item ${isActive ? "" : "mutedRow"}">
            <div class="left">
              <div class="name">${escapeHtml(d.name || "")}</div>
              <div class="meta">${escapeHtml(meta)}</div>
            </div>
            <div class="right">
              <span class="badge ${isActive ? "green" : "red"}">${isActive ? "Active" : "Paused"}</span>
              <button class="pillBtn small ghost" data-edit-dd="${d.id}">Edit</button>
            </div>
          </div>
        `;
      }).join("");

      targetEl.querySelectorAll("[data-edit-dd]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-edit-dd");
          openDDEditor(id);
        });
      });
    }

    // ========= Mini graph (can go negative, with visible x-axis) =========
    function drawMiniGraph(){
      const canvas = els.miniCanvas;
      const ctx = canvas.getContext("2d");

      const w = canvas.clientWidth;
      const h = canvas.height;
      canvas.width = Math.floor(w * devicePixelRatio);
      canvas.height = Math.floor(h * devicePixelRatio);
      ctx.scale(devicePixelRatio, devicePixelRatio);

      ctx.clearRect(0,0,w,h);

      const values = dailyBalancesForMonth(state.selectedMonth, whatIfOffset);
      if(values.length < 2){
        // draw x-axis anyway
        drawAxis(ctx, w, h, 0.6);
        return;
      }

      const minV = Math.min(...values);
      const maxV = Math.max(...values);
      const range = Math.max(1, maxV - minV);

      // padding
      const padX = 8;
      const padY = 10;

      const plotW = w - padX*2;
      const plotH = h - padY*2;

      // map value to y
      function yFor(v){
        const t = (v - minV) / range; // 0..1
        return padY + (1 - t) * plotH;
      }

      // x-axis should be y=0 line if 0 is within range, else bottom
      let axisY;
      if(minV <= 0 && maxV >= 0){
        axisY = yFor(0);
      }else{
        axisY = padY + plotH; // bottom
      }

      // axis
      ctx.strokeStyle = "rgba(255,255,255,.22)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padX, axisY);
      ctx.lineTo(padX + plotW, axisY);
      ctx.stroke();

      // line
      const step = plotW / (values.length - 1);

      ctx.lineWidth = 3;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";

      // gradient line
      const grad = ctx.createLinearGradient(padX,0,padX+plotW,0);
      grad.addColorStop(0, "#93c5fd");
      grad.addColorStop(0.55, "#22c55e");
      grad.addColorStop(1, "#38bdf8");
      ctx.strokeStyle = grad;

      ctx.beginPath();
      values.forEach((v,i)=>{
        const x = padX + i*step;
        const y = yFor(v);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    function drawAxis(ctx,w,h,opacity=0.25){
      ctx.strokeStyle = `rgba(255,255,255,${opacity})`;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(8, h-12);
      ctx.lineTo(w-8, h-12);
      ctx.stroke();
    }

    function dailyBalancesForMonth(mk, offset){
      // Start from total income for month, then subtract DDs as days pass and spending by date
      const txs = state.data.transactions.filter(t => t.monthKey === mk);
      const dds = state.data.directDebits.filter(d => d.monthKey === mk && d.active === true);

      const income = txs.filter(t => t.type === "income").reduce((a,b)=>a + (Number(b.amount)||0),0);

      // days in month
      const [y,m] = mk.split("-").map(Number);
      const days = new Date(y, m, 0).getDate();

      // group spending by day
      const spendByDay = new Array(days+1).fill(0);
      txs.filter(t=>t.type==="spend").forEach(t=>{
        const day = Number((t.dateISO||"").slice(8,10)) || 1;
        spendByDay[day] += Number(t.amount)||0;
      });

      const ddByDay = new Array(days+1).fill(0);
      dds.forEach(d=>{
        const day = Math.min(days, Math.max(1, Number(d.day)||1));
        ddByDay[day] += Number(d.amount)||0;
      });

      // apply what-if gradually
      const values = [];
      let bal = income;

      for(let day=1; day<=days; day++){
        bal -= ddByDay[day];
        bal -= spendByDay[day];

        // spread offset across month
        if(offset !== 0){
          const factor = day / days;
          const adj = offset * factor;
          values.push(bal - adj);
        }else{
          values.push(bal);
        }
      }
      return values;
    }

    // ========= Add / Edit =========
    function addTransaction(){
      const dateISO = els.txDate.value || `${state.selectedMonth}-01`;
      const monthKey = dateISOToMonthKey(dateISO) || state.selectedMonth;
      const type = els.txType.value;
      const desc = (els.txDesc.value || "").trim();
      const amt = parseAmount(els.txAmount.value);

      if(!desc){
        alert("Please add a description.");
        return;
      }
      if(!Number.isFinite(amt)){
        alert("Please enter a valid amount.");
        return;
      }

      state.data.transactions.push({
        id: uid(),
        monthKey,
        dateISO,
        type,
        description: desc,
        amount: amt,
        isAutoOpening: false
      });

      // clear inputs + hide keyboard
      els.txDesc.value = "";
      els.txAmount.value = "";
      els.txDesc.blur();
      els.txAmount.blur();

      save();
      render();
    }

    function addDirectDebit(){
      const name = (els.ddName.value || "").trim();
      const amount = parseAmount(els.ddAmount.value);
      const day = parseIntSafe(els.ddDay.value);
      const category = (els.ddCategory.value || "").trim();

      if(!name){
        alert("Please add a name.");
        return;
      }
      if(!Number.isFinite(amount)){
        alert("Please enter a valid amount.");
        return;
      }
      if(!Number.isFinite(day) || day < 1 || day > 31){
        alert("Please enter a day between 1 and 31.");
        return;
      }

      state.data.directDebits.push({
        id: uid(),
        monthKey: state.selectedMonth,
        name,
        amount,
        day,
        category,
        active: true
      });

      // clear inputs + hide keyboard
      els.ddName.value = "";
      els.ddAmount.value = "";
      els.ddDay.value = "";
      els.ddCategory.value = "";
      els.ddName.blur();
      els.ddAmount.blur();
      els.ddDay.blur();
      els.ddCategory.blur();

      save();
      render();
    }

    // ========= Editors =========
    function openTxEditor(id){
      const tx = state.data.transactions.find(t=>t.id===id);
      if(!tx) return;

      // Prevent editing auto opening date/type, but allow amount if needed (still auto gets recomputed)
      const isAuto = tx.isAutoOpening === true;

      els.editTitle.textContent = isAuto ? "Opening balance (auto)" : "Edit transaction";

      els.editBody.innerHTML = `
        <div class="formGrid">
          <div class="field">
            <label>Date</label>
            <input class="control" type="date" id="eTxDate" ${isAuto ? "disabled" : ""} value="${escapeAttr(tx.dateISO)}" />
          </div>

          <div class="field">
            <label>Type</label>
            <select class="control" id="eTxType" ${isAuto ? "disabled" : ""}>
              <option value="income" ${tx.type==="income"?"selected":""}>Income</option>
              <option value="spend" ${tx.type==="spend"?"selected":""}>Spending</option>
            </select>
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Description</label>
            <input class="control" type="text" id="eTxDesc" ${isAuto ? "disabled" : ""} value="${escapeAttr(tx.description||"")}" />
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Amount</label>
            <input class="control" type="text" inputmode="decimal" id="eTxAmt" value="${escapeAttr(String(tx.amount))}" />
          </div>
        </div>

        <div class="rowBtns">
          <button class="pillBtn primary" id="saveTxEditBtn">Save</button>
          ${isAuto ? "" : `<button class="pillBtn danger" id="deleteTxBtn">Delete</button>`}
        </div>

        ${isAuto ? `<p class="subtle" style="margin-top:10px">This value is recomputed from the previous month. If you edit it, it may be overwritten when you change data in earlier months.</p>` : ""}
      `;

      showEditModal();

      document.getElementById("saveTxEditBtn").addEventListener("click", ()=>{
        const amt = parseAmount(document.getElementById("eTxAmt").value);
        if(!Number.isFinite(amt)){
          alert("Please enter a valid amount.");
          return;
        }

        if(!isAuto){
          const newDate = document.getElementById("eTxDate").value;
          const newType = document.getElementById("eTxType").value;
          const newDesc = (document.getElementById("eTxDesc").value || "").trim();
          if(!newDesc){
            alert("Please add a description.");
            return;
          }
          tx.dateISO = newDate;
          tx.monthKey = dateISOToMonthKey(newDate);
          tx.type = newType;
          tx.description = newDesc;
        }
        tx.amount = amt;

        closeEditModal();
        save();
        render();
      });

      const delBtn = document.getElementById("deleteTxBtn");
      if(delBtn){
        delBtn.addEventListener("click", ()=>{
          if(!confirm("Delete this transaction?")) return;
          state.data.transactions = state.data.transactions.filter(t=>t.id!==id);
          closeEditModal();
          save();
          render();
        });
      }
    }

    function openDDEditor(id){
      const dd = state.data.directDebits.find(d=>d.id===id);
      if(!dd) return;

      els.editTitle.textContent = "Edit direct debit (this month only)";

      els.editBody.innerHTML = `
        <div class="formGrid">
          <div class="field" style="grid-column:1/-1">
            <label>Name</label>
            <input class="control" type="text" id="eDDName" value="${escapeAttr(dd.name||"")}" />
          </div>

          <div class="field">
            <label>Amount</label>
            <input class="control" type="text" inputmode="decimal" id="eDDAmt" value="${escapeAttr(String(dd.amount))}" />
          </div>

          <div class="field">
            <label>Day of month</label>
            <input class="control" type="text" inputmode="numeric" id="eDDDay" value="${escapeAttr(String(dd.day))}" />
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Category</label>
            <input class="control" type="text" id="eDDCat" value="${escapeAttr(dd.category||"")}" />
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Paused</label>
            <select class="control" id="eDDPaused">
              <option value="no" ${dd.active ? "selected" : ""}>No (Active)</option>
              <option value="yes" ${!dd.active ? "selected" : ""}>Yes (Paused)</option>
            </select>
          </div>
        </div>

        <div class="rowBtns">
          <button class="pillBtn primary" id="saveDDEditBtn">Save</button>
          <button class="pillBtn danger" id="deleteDDBtn">Delete (this month)</button>
        </div>

        <p class="subtle" style="margin-top:10px">
          This is a monthly snapshot. Editing here changes only <b>${monthKeyToLabel(dd.monthKey)}</b>.
          If it changes next month, edit next month’s snapshot instead.
        </p>
      `;

      showEditModal();

      document.getElementById("saveDDEditBtn").addEventListener("click", ()=>{
        const name = (document.getElementById("eDDName").value || "").trim();
        const amt = parseAmount(document.getElementById("eDDAmt").value);
        const day = parseIntSafe(document.getElementById("eDDDay").value);
        const cat = (document.getElementById("eDDCat").value || "").trim();
        const paused = document.getElementById("eDDPaused").value === "yes";

        if(!name){
          alert("Please add a name.");
          return;
        }
        if(!Number.isFinite(amt)){
          alert("Please enter a valid amount.");
          return;
        }
        if(!Number.isFinite(day) || day < 1 || day > 31){
          alert("Please enter a day between 1 and 31.");
          return;
        }

        dd.name = name;
        dd.amount = amt;
        dd.day = day;
        dd.category = cat;
        dd.active = !paused;

        closeEditModal();
        save();
        render();
      });

      document.getElementById("deleteDDBtn").addEventListener("click", ()=>{
        if(!confirm("Delete this direct debit for this month only?")) return;
        state.data.directDebits = state.data.directDebits.filter(d=>d.id!==id);
        closeEditModal();
        save();
        render();
      });
    }

    // ========= Donut detail modal =========
    function openDonutModal(){
      renderDonutModal();
      els.donutModalBackdrop.classList.add("show");
      els.donutModalBackdrop.setAttribute("aria-hidden","false");
    }

    function closeDonutModal(){
      els.donutModalBackdrop.classList.remove("show");
      els.donutModalBackdrop.setAttribute("aria-hidden","true");
    }

    function renderDonutModal(){
      const mk = state.selectedMonth;
      els.donutModalTitle.textContent = `Monthly Breakdown — ${monthKeyToLabel(mk)}`;

      const { income, spend, dd, left } = monthTotals(mk);
      const leftAfter = left - whatIfOffset;

      els.mIncome.textContent = fmtMoney(income);
      els.mSpend.textContent  = fmtMoney(spend);
      els.mDD.textContent     = fmtMoney(dd);
      els.mLeft.textContent   = fmtMoney(leftAfter);

      els.mLeft.classList.remove("green","red","amber");
      if(leftAfter > 0) els.mLeft.classList.add("green");
      else if(leftAfter === 0) els.mLeft.classList.add("amber");
      else els.mLeft.classList.add("red");

      renderTransactions(els.modalTxList);
      renderDirectDebits(els.modalDDList);
    }

    // ========= Modal helpers =========
    function showEditModal(){
      els.editModalBackdrop.classList.add("show");
      els.editModalBackdrop.setAttribute("aria-hidden","false");
    }
    function closeEditModal(){
      els.editModalBackdrop.classList.remove("show");
      els.editModalBackdrop.setAttribute("aria-hidden","true");
    }

    // ========= Export / Reset =========
    function csvEscape(v){
      const s = (v == null) ? "" : String(v);
      const e = s.replaceAll('"','""');
      return `"${e}"`;
    }

    function exportAllCSV(){
      // Single file with your headers:
      const headers = [
        "RowType","MonthKey","Date","TxType","Description","TxAmount",
        "DDName","DDAmount","DDDay","DDCategory","DDActive",
        "OverrideMonth","OverrideType","OverrideAmount","OverrideDay","OverrideCategory","OverrideActive"
      ];

      const rows = [];
      // Transactions
      state.data.transactions
        .slice()
        .sort((a,b)=> (a.monthKey.localeCompare(b.monthKey)) || (a.dateISO.localeCompare(b.dateISO)))
        .forEach(t=>{
          rows.push([
            "TRANSACTION",
            t.monthKey,
            t.dateISO,
            t.type,
            t.description || "",
            (Number(t.amount)||0).toFixed(2),
            "", "", "", "", "",
            "", "", "", "", "", ""
          ]);
        });

      // Direct debits (monthly snapshot)
      state.data.directDebits
        .slice()
        .sort((a,b)=> (a.monthKey.localeCompare(b.monthKey)) || (a.day - b.day) || (a.name||"").localeCompare(b.name||""))
        .forEach(d=>{
          rows.push([
            "DIRECT_DEB",
            d.monthKey,
            "",
            "",
            "",
            "",
            d.name || "",
            (Number(d.amount)||0).toFixed(2),
            String(d.day || ""),
            d.category || "",
            d.active ? "Yes" : "No",
            "", "", "", "", "", ""
          ]);
        });

      const csv = [
        headers.join(","),
        ...rows.map(r=>r.map(csvEscape).join(","))
      ].join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "BishopBudget-AllData.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 800);
    }

    function resetAll(){
      if(!confirm("This will delete ALL data in the app on this device/browser. Are you sure?")) return;
      localStorage.removeItem(STORAGE_KEY);
      // hard reset
      state.selectedMonth = monthKeyFromDate(new Date());
      state.data = { transactions: [], directDebits: [] };
      state.dismissedCopyDDBanner = {};
      whatIfOffset = 0;
      render();
    }

    // ========= Safety HTML escaping =========
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

    // ========= Events =========
    function wire(){
      els.prevMonthBtn.addEventListener("click", ()=>{
        state.selectedMonth = prevMonthKey(state.selectedMonth);
        save();
        render();
        window.scrollTo({top:0, behavior:"smooth"});
      });

      els.nextMonthBtn.addEventListener("click", ()=>{
        state.selectedMonth = nextMonthKey(state.selectedMonth);
        save();
        render();
        window.scrollTo({top:0, behavior:"smooth"});
      });

      els.addTxBtn.addEventListener("click", addTransaction);
      els.addDDBtn.addEventListener("click", addDirectDebit);

      els.exportBtn.addEventListener("click", exportAllCSV);
      els.resetBtn.addEventListener("click", resetAll);

      els.whatIf.addEventListener("input", ()=>{
        whatIfOffset = Number(els.whatIf.value) || 0;
        applyWhatIfLabel();
        render();
      });
      els.whatIfResetBtn.addEventListener("click", resetWhatIf);

      els.donutCard.addEventListener("click", openDonutModal);
      els.closeDonutModalBtn.addEventListener("click", closeDonutModal);
      els.donutModalBackdrop.addEventListener("click", (e)=>{
        if(e.target === els.donutModalBackdrop) closeDonutModal();
      });

      els.closeEditModalBtn.addEventListener("click", closeEditModal);
      els.editModalBackdrop.addEventListener("click", (e)=>{
        if(e.target === els.editModalBackdrop) closeEditModal();
      });

      // Copy DD prompt
      els.copyDDBtn.addEventListener("click", ()=>{
        copyDDsFromPreviousMonth();
        els.copyDDBanner.hidden = true;
      });
      els.dismissCopyDDBtn.addEventListener("click", ()=>{
        state.dismissedCopyDDBanner[state.selectedMonth] = true;
        save();
        render();
      });
    }

    // ========= Init =========
    function init(){
      bindEls();
      load();

      // set default tx date to today
      const today = new Date();
      const iso = today.toISOString().slice(0,10);
      els.txDate.value = iso;

      applyWhatIfLabel();
      wire();
      render();
    }

    init();
  </script>
</body>
</html>
