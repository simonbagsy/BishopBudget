<title>22 Bishop Road Budget</title>

<!-- No pinch zoom -->
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

<!-- Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
@@ -37,7 +34,6 @@
--border-subtle: rgba(255, 255, 255, 0.04);
--border-strong: rgba(255, 255, 255, 0.12);
--shadow-strong: 0 22px 65px rgba(0, 0, 0, 0.75);

--easeOut: cubic-bezier(0.18, 0.9, 0.2, 1);
}

@@ -79,7 +75,6 @@
.app-container { padding: 20px; }
}

    /* --- Subtle entrance animation --- */
@keyframes fadeUp {
from { opacity: 0; transform: translateY(8px); }
to { opacity: 1; transform: translateY(0); }
@@ -158,7 +153,6 @@
overflow: hidden;
}

    /* subtle highlight sheen */
.btn::after{
content:"";
position:absolute;
@@ -213,17 +207,13 @@
font-weight: 700;
outline: none;
margin-bottom: 6px;
      transition: transform 0.08s ease, border-color 0.12s ease, box-shadow 0.12s ease;
}

    .input:focus {
      border-color: rgba(142,197,255,0.95);
      box-shadow: 0 0 0 3px rgba(95,169,255,0.12);
      transform: translateY(-0.5px);
    .input::placeholder {
      color: rgba(154, 163, 181, 0.82);
      font-weight: 600;
}

    .input::placeholder { color: rgba(154, 163, 181, 0.82); font-weight: 600; }

input[type="date"].input {
-webkit-appearance: none;
appearance: none;
@@ -234,11 +224,7 @@

select.input {
padding-right: 28px;
      background-image: linear-gradient(
        180deg,
        rgba(255, 255, 255, 0.06),
        rgba(255, 255, 255, 0)
      );
      background-image: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0));
}

.inputs-row {
@@ -260,12 +246,6 @@
padding: 8px 9px;
border: 1px solid rgba(255, 255, 255, 0.06);
box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      transition: transform 0.12s var(--easeOut), box-shadow 0.12s var(--easeOut);
    }

    .dashboard-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(0,0,0,0.65);
}

.dashboard-label { font-size: 11px; color: var(--text-soft); }
@@ -302,12 +282,6 @@
align-items: center;
}

    @keyframes donutPulse {
      0% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.012); filter: brightness(1.03); }
      100% { transform: scale(1); filter: brightness(1); }
    }

.donut-wrapper {
flex: 0 0 150px;
display: flex;
@@ -318,11 +292,10 @@
.donut-wrapper canvas {
cursor: pointer;
border-radius: 999px;
      animation: donutPulse 3.4s ease-in-out infinite;
      box-shadow: 0 12px 30px rgba(0,0,0,0.55);
}

.donut-legend { flex: 1; font-size: 11px; color: var(--text-soft); }

.donut-legend-row {
display: flex;
align-items: center;
@@ -356,17 +329,12 @@
justify-content: space-between;
gap: 8px;
box-shadow: 0 10px 24px rgba(0, 0, 0, 0.55);
      animation: fadeUp 180ms var(--easeOut) both;
      transition: transform 0.12s var(--easeOut), box-shadow 0.12s var(--easeOut);
    }

    .list-item:hover {
      transform: translateY(-0.8px);
      box-shadow: 0 16px 34px rgba(0,0,0,0.7);
}

.list-main { flex: 1; min-width: 0; }

.list-title { font-size: 13px; font-weight: 700; margin-bottom: 2px; }

.list-sub {
font-size: 11px;
color: var(--text-muted);
@@ -376,18 +344,32 @@
}

.list-right { display: flex; align-items: center; gap: 6px; }
    .list-amount { font-size: 14px; font-weight: 800; text-align: right; white-space: nowrap; }

    .list-amount {
      font-size: 14px;
      font-weight: 800;
      text-align: right;
      white-space: nowrap;
    }

.dd-paused .list-title { color: var(--red-soft); }
.dd-paused .list-sub { color: #ff9fab; }

.summary-rows { margin-top: 4px; font-size: 12px; }
    .summary-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2px; }

    .summary-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2px;
    }

.summary-row-label { color: var(--text-soft); }
.summary-row-value { font-weight: 600; }

.summary-row-strong { font-weight: 700; margin-top: 3px; }
.summary-row-strong .summary-row-label { color: var(--text); }
    .summary-row-strong .summary-row-value { font-weight: 900; }
    .summary-row-strong .summary-row-value { font-weight: 800; }

.summary-card-inner {
background: rgba(9, 15, 33, 0.96);
@@ -399,12 +381,7 @@

.subtle-divider {
height: 1px;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.18),
        transparent
      );
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.18), transparent);
margin: 4px 0;
}

@@ -417,99 +394,19 @@
box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7);
}

    .line-graph-label { font-size: 11px; color: var(--text-soft); margin-bottom: 4px; }
    .line-graph-canvas { width: 100%; height: 70px; display: block; border-radius: 10px; }

    .slider-row { margin-top: 8px; font-size: 11px; color: var(--text-soft); }
    .slider-row-top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      align-items: center;
      gap: 8px;
    }

    .slider-reset-btn {
    .line-graph-label {
font-size: 11px;
      background: rgba(9, 15, 33, 0.9);
      border-radius: 999px;
      padding: 3px 7px;
      border: 1px solid rgba(255, 255, 255, 0.26);
      cursor: pointer;
color: var(--text-soft);
      font-weight: 800;
      transition: transform 0.08s ease, filter 0.12s ease;
    }

    .slider-reset-btn:hover { filter: brightness(1.1); transform: translateY(-0.5px); }
    .slider-reset-btn:active { transform: translateY(0.5px) scale(0.98); }

    .slider { width: 100%; accent-color: var(--blue-soft); }

    /* --- Trend section --- */
    .trend-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 6px;
    }

    .trend-card {
      background: rgba(9, 15, 33, 0.96);
      border-radius: 14px;
      padding: 8px 9px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.65);
      transition: transform 0.12s var(--easeOut), box-shadow 0.12s var(--easeOut);
    }

    .trend-card:hover { transform: translateY(-1px); box-shadow: 0 16px 36px rgba(0,0,0,0.78); }

    .trend-label { font-size: 11px; color: var(--text-soft); }
    .trend-value { font-size: 14px; font-weight: 900; margin-top: 3px; }
    .trend-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    .delta {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-weight: 900;
    }
    .delta.up { color: var(--green-soft); }
    .delta.down { color: var(--red-soft); }
    .delta.flat { color: var(--text); opacity: 0.85; }

    .spark-wrap {
      grid-column: 1 / 3;
      background: rgba(9, 15, 33, 0.96);
      border-radius: 14px;
      padding: 8px 9px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.65);
      margin-top: 2px;
    }

    .spark-head {
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      margin-bottom: 4px;
}

    .spark-title { font-size: 12px; font-weight: 800; color: var(--text); }
    .spark-sub { font-size: 11px; color: var(--text-muted); }

    .spark-canvas {
    .line-graph-canvas {
width: 100%;
      height: 64px;
      display:block;
      height: 70px;
      display: block;
border-radius: 10px;
      background: rgba(5, 8, 18, 0.35);
      border: 1px solid rgba(255,255,255,0.05);
}

    /* --- Modals --- */
.modal-overlay {
position: fixed;
inset: 0;
@@ -520,11 +417,6 @@
z-index: 20;
}

    @keyframes sheetUp {
      from { transform: translateY(18px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

.modal-sheet {
width: 100%;
max-width: 520px;
@@ -533,7 +425,6 @@
border-top: 1px solid rgba(255, 255, 255, 0.16);
padding: 14px 14px 18px;
box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.9);
      animation: sheetUp 180ms var(--easeOut) both;
}

.modal-header {
@@ -543,14 +434,15 @@
margin-bottom: 6px;
}

    .modal-title { font-size: 15px; font-weight: 800; }
    .modal-title { font-size: 15px; font-weight: 700; }
.modal-row { margin-top: 6px; }

.modal-actions {
display: flex;
justify-content: space-between;
gap: 6px;
margin-top: 10px;
      flex-wrap: wrap;
}

.toggle-row {
@@ -561,7 +453,7 @@
margin-top: 8px;
}

    .toggle-label { font-size: 12px; color: var(--text-soft); font-weight: 700; }
    .toggle-label { font-size: 12px; color: var(--text-soft); }

.toggle-pill {
width: 44px;
@@ -591,9 +483,41 @@
border-color: rgba(159, 255, 205, 0.9);
}

    .toggle-pill.on .toggle-thumb { transform: translateX(18px); }
    .toggle-pill.on .toggle-thumb {
      transform: translateX(18px);
    }

    /* Scope selector (this month vs future) */
    .scope-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 4px;
    }

    .scope-btn {
      width: 100%;
      text-align: center;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(9, 15, 33, 0.75);
      color: var(--text-soft);
      font-weight: 800;
      cursor: pointer;
      transition: filter 0.12s ease, transform 0.08s ease, box-shadow 0.12s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }

    .scope-btn:active { transform: scale(0.985); }

    .scope-btn.active {
      color: #ffffff;
      border-color: rgba(142,197,255,0.55);
      background: radial-gradient(circle at top, #223461 0, #141e3e 65%);
      box-shadow: 0 14px 32px rgba(0,0,0,0.5);
    }

    /* --- Donut breakdown screen --- */
#donutBreakdown {
display: none;
position: fixed;
@@ -607,7 +531,12 @@
color: var(--text);
}

    .bd-inner { width: 100%; max-width: 520px; margin: 0 auto; }
    .bd-inner {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
    }

.bd-back-row { margin-bottom: 8px; }

.bd-card {
@@ -616,7 +545,6 @@
border: 1px solid var(--border-strong);
padding: 14px;
box-shadow: 0 22px 70px rgba(0, 0, 0, 0.86);
      animation: fadeUp 220ms var(--easeOut) both;
}

.bd-grid {
@@ -635,7 +563,7 @@
}

.bd-label { font-size: 11px; color: var(--text-soft); }
    .bd-value { font-size: 14px; font-weight: 900; margin-top: 3px; }
    .bd-value { font-size: 14px; font-weight: 800; margin-top: 3px; }

.bd-donut-wrap {
display: flex;
@@ -644,10 +572,7 @@
margin-bottom: 6px;
}

    .bd-donut-wrap canvas {
      border-radius: 999px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.75);
    }
    .bd-donut-wrap canvas { border-radius: 999px; }

.bd-subtext { font-size: 12px; color: var(--text-soft); margin-top: 2px; }

@@ -661,9 +586,14 @@
font-size: 12px;
}

    .compare-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
    .compare-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }

.compare-label { color: var(--text-soft); }
    .compare-value { font-weight: 800; }
    .compare-value { font-weight: 700; }
</style>
</head>

@@ -742,110 +672,33 @@
<div class="legend-swatch legend-swatch-carry"></div>
<span>Opening balance + income</span>
</div>
              <span id="legendIncome" style="font-weight:800;">£0.00</span>
              <span id="legendIncome" style="font-weight:700;">£0.00</span>
</div>
<div class="donut-legend-row">
<div class="donut-legend-label">
<div class="legend-swatch legend-swatch-red"></div>
<span>DDs & spending</span>
</div>
              <span id="legendOut" style="font-weight:800;">£0.00</span>
              <span id="legendOut" style="font-weight:700;">£0.00</span>
</div>
<div class="donut-legend-row">
<div class="donut-legend-label">
<div class="legend-swatch"></div>
<span>Left after everything</span>
</div>
              <span id="legendLeft" style="font-weight:800;">£0.00</span>
              <span id="legendLeft" style="font-weight:700;">£0.00</span>
</div>

            <button
              id="seeMoreDonut"
              class="btn btn-subtle"
              style="margin-top:6px;width:100%;justify-content:center;"
            >
            <button id="seeMoreDonut" class="btn btn-subtle" style="margin-top:6px;width:100%;justify-content:center;">
View detailed donut breakdown
</button>
</div>
</div>

<div class="line-graph-container">
          <div class="line-graph-label">
            Balance curve across the month (with opening balance applied)
          </div>
          <div class="line-graph-label">Balance curve across the month (with opening balance applied)</div>
<canvas id="balanceCanvas" class="line-graph-canvas"></canvas>
</div>

        <div class="slider-row">
          <div class="slider-row-top">
            <span>What if this month changed by…</span>
            <button id="resetWhatIf" class="slider-reset-btn">Reset</button>
          </div>
          <input id="whatIfSlider" class="slider" type="range" min="-2000" max="2000" step="10" value="0" />
          <div style="display:flex;justify-content:space-between;margin-top:2px;">
            <span id="whatIfChange">Change: £0.00</span>
            <span id="whatIfAfter">After change: £0.00</span>
          </div>
        </div>
      </div>

      <!-- NEW: Trend Intelligence -->
      <div class="section">
        <div class="section-header">
          <div>
            <div class="section-title">Trend intelligence</div>
            <div class="section-subtitle">Deltas, averages, and a run-rate projection.</div>
          </div>
        </div>

        <div class="trend-grid">
          <div class="trend-card">
            <div class="trend-label">Left vs last month</div>
            <div id="trendAfterDelta" class="trend-value">–</div>
            <div id="trendAfterDeltaSub" class="trend-sub">Compares “Left after everything”.</div>
          </div>

          <div class="trend-card">
            <div class="trend-label">Income vs last month</div>
            <div id="trendIncomeDelta" class="trend-value">–</div>
            <div class="trend-sub">Opening + income movement.</div>
          </div>

          <div class="trend-card">
            <div class="trend-label">Outgoing vs last month</div>
            <div id="trendOutDelta" class="trend-value">–</div>
            <div class="trend-sub">DDs + spending.</div>
          </div>

          <div class="trend-card">
            <div class="trend-label">Projected end-of-month left</div>
            <div id="trendProjection" class="trend-value">–</div>
            <div id="trendProjectionSub" class="trend-sub">Based on current pace this month.</div>
          </div>

          <div class="trend-card">
            <div class="trend-label">3-month average left</div>
            <div id="trendAvgAfter" class="trend-value">–</div>
            <div class="trend-sub">Smoother picture than one month.</div>
          </div>

          <div class="trend-card">
            <div class="trend-label">3-month average outgoing</div>
            <div id="trendAvgOut" class="trend-value">–</div>
            <div class="trend-sub">Bills + spending average.</div>
          </div>

          <div class="spark-wrap">
            <div class="spark-head">
              <div>
                <div class="spark-title">Last 6 months, left after everything</div>
                <div class="spark-sub">Quick signal if you’re trending up or bleeding cash.</div>
              </div>
              <div id="sparkHint" class="spark-sub">–</div>
            </div>
            <canvas id="afterSpark" class="spark-canvas"></canvas>
          </div>
        </div>
</div>

<div class="section">
@@ -881,10 +734,7 @@
</div>
</div>

        <button id="addTxBtn" class="btn btn-full" style="margin-top:4px;">
          Add transaction
        </button>

        <button id="addTxBtn" class="btn btn-full" style="margin-top:4px;">Add transaction</button>
<div id="txList" class="list-container"></div>
</div>

@@ -918,10 +768,7 @@
</div>
</div>

        <button id="addDdBtn" class="btn btn-full" style="margin-top:4px;">
          Add direct debit
        </button>

        <button id="addDdBtn" class="btn btn-full" style="margin-top:4px;">Add direct debit</button>
<div id="ddList" class="list-container"></div>
</div>

@@ -956,15 +803,10 @@
</div>

<div style="margin-top:8px;display:flex;gap:6px;justify-content:space-between;">
          <button id="exportCsvBtn" class="btn btn-small btn-secondary" style="flex:1;">
            Export all data (CSV)
          </button>
          <button id="resetAppBtn" class="btn btn-small btn-ghost" style="flex:1;">
            Reset app
          </button>
          <button id="exportCsvBtn" class="btn btn-small btn-secondary" style="flex:1;">Export all data (CSV)</button>
          <button id="resetAppBtn" class="btn btn-small btn-ghost" style="flex:1;">Reset app</button>
</div>
</div>

</div>
</div>

@@ -998,9 +840,7 @@

<div class="modal-actions">
<button id="deleteTxBtn" class="btn btn-danger">Delete</button>
        <button id="saveTxBtn" class="btn btn-secondary" style="flex:1;">
          Save changes
        </button>
        <button id="saveTxBtn" class="btn btn-secondary" style="flex:1;">Save changes</button>
</div>
</div>
</div>
@@ -1031,17 +871,24 @@
</div>

<div class="toggle-row">
        <span class="toggle-label">Paused for this month</span>
        <span class="toggle-label">Paused</span>
<div id="ddPausedToggle" class="toggle-pill">
<div class="toggle-thumb"></div>
</div>
</div>

      <div class="modal-row">
        <div class="input-label">Apply changes</div>
        <div class="scope-row">
          <button id="scopeMonthBtn" class="scope-btn active" type="button">This month only</button>
          <button id="scopeFutureBtn" class="scope-btn" type="button">This month + future</button>
        </div>
      </div>

<div class="modal-actions">
        <button id="deleteDdBtn" class="btn btn-danger">Delete this month</button>
        <button id="saveDdBtn" class="btn btn-secondary" style="flex:1;">
          Save changes
        </button>
        <button id="deleteDdThisMonthBtn" class="btn btn-danger">Delete this month</button>
        <button id="deleteDdFutureBtn" class="btn btn-danger">Delete month + future</button>
        <button id="saveDdBtn" class="btn btn-secondary" style="flex:1;">Save changes</button>
</div>
</div>
</div>
@@ -1050,9 +897,7 @@
<div id="donutBreakdown">
<div class="bd-inner">
<div class="bd-back-row">
        <button class="btn btn-small btn-ghost" id="closeDonutBreakdown">
          ← Back to month
        </button>
        <button class="btn btn-small btn-ghost" id="closeDonutBreakdown">← Back to month</button>
</div>

<div class="bd-card">
@@ -1147,9 +992,7 @@
return "id-" + Math.random().toString(16).slice(2);
}

    function firstOfMonth(d) {
      return new Date(d.getFullYear(), d.getMonth(), 1);
    }
    function firstOfMonth(d) { return new Date(d.getFullYear(), d.getMonth(), 1); }

function monthKey(d) {
return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
@@ -1161,6 +1004,29 @@
return new Date(y, m - 1, 1);
}

    function compareMonthKey(a, b) {
      const da = parseMonthKey(a);
      const db = parseMonthKey(b);
      if (!da || !db) return 0;
      const ta = da.getTime();
      const tb = db.getTime();
      return ta === tb ? 0 : ta < tb ? -1 : 1;
    }

    function prevMonthKey(mk) {
      const d = parseMonthKey(mk);
      if (!d) return mk;
      const prev = new Date(d.getFullYear(), d.getMonth() - 1, 1);
      return monthKey(prev);
    }

    function isMonthInRange(currentMK, startMK, endMK) {
      if (!startMK) return false;
      if (compareMonthKey(currentMK, startMK) < 0) return false;
      if (endMK && compareMonthKey(currentMK, endMK) > 0) return false;
      return true;
    }

function monthLabel(d) {
return d.toLocaleDateString("en-GB", { month: "short", year: "2-digit" });
}
@@ -1181,52 +1047,7 @@
}

function isAutoOpening(tx) {
      return (
        tx.type === "income" &&
        tx.description === "Opening balance (auto)"
      );
    }

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    function deltaLabel(value) {
      if (!isFinite(value) || value === null) return { text: "–", cls: "flat" };
      if (value > 0) return { text: `+${formatMoney(value)}`, cls: "up" };
      if (value < 0) return { text: `−${formatMoney(Math.abs(value))}`, cls: "down" };
      return { text: "±£0.00", cls: "flat" };
    }

    // Count-up numbers (subtle)
    const numberAnimState = new Map();
    function animateMoney(el, nextValue) {
      if (!el) return;
      if (!isFinite(nextValue)) nextValue = 0;

      const key = el.id || el;
      const prev = numberAnimState.has(key) ? numberAnimState.get(key) : null;

      // First render, no drama
      if (prev === null) {
        numberAnimState.set(key, nextValue);
        el.textContent = formatMoney(nextValue);
        return;
      }

      const start = prev;
      const end = nextValue;
      const duration = 220;
      const t0 = performance.now();

      function frame(t) {
        const p = clamp((t - t0) / duration, 0, 1);
        const eased = 1 - Math.pow(1 - p, 3);
        const v = start + (end - start) * eased;
        el.textContent = formatMoney(v);
        if (p < 1) requestAnimationFrame(frame);
        else numberAnimState.set(key, end);
      }

      requestAnimationFrame(frame);
      return (tx.type === "income" && tx.description === "Opening balance (auto)");
}

// ------------ DONUT & GRAPH DRAWING ------------
@@ -1242,7 +1063,6 @@
const radius = Math.min(cx, cy) - 12;
const ringWidth = 18;

      // Base ring
ctx.beginPath();
ctx.arc(cx, cy, radius, 0, Math.PI * 2);
const baseGrad = ctx.createLinearGradient(cx - radius, cy, cx + radius, cy);
@@ -1263,7 +1083,6 @@
const leftAngle = (left / total) * Math.PI * 2;
const startAngle = -Math.PI / 2;

      // Outgoing segment
if (outgoing > 0) {
ctx.beginPath();
ctx.arc(cx, cy, radius, startAngle, startAngle + outAngle);
@@ -1276,14 +1095,9 @@
ctx.stroke();
}

      // Left segment
if (left > 0) {
ctx.beginPath();
        ctx.arc(
          cx, cy, radius,
          startAngle + outAngle,
          startAngle + outAngle + leftAngle
        );
        ctx.arc(cx, cy, radius, startAngle + outAngle, startAngle + outAngle + leftAngle);
const gradGreen = ctx.createLinearGradient(cx - radius, cy, cx + radius, cy);
gradGreen.addColorStop(0, "#9af7c7");
gradGreen.addColorStop(1, "#40e38a");
@@ -1293,60 +1107,48 @@
ctx.stroke();
}

      // Centre text
ctx.fillStyle = "#e8edf8";
      ctx.font = "800 22px -apple-system, system-ui, sans-serif";
      ctx.font = "700 22px -apple-system, system-ui, sans-serif";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.fillText(`${Math.round(percentLeft)}%`, cx, cy - 5);

ctx.fillStyle = "#9aa3b1";
      ctx.font = "12px -apple-system, system-ui, sans-serif";
      ctx.font = "11px -apple-system, system-ui, sans-serif";
ctx.fillText("income left", cx, cy + 12);
}

function drawBalanceLine(canvas, dailyBalances) {
const ctx = canvas.getContext("2d");

      // Ensure actual pixel buffer matches CSS size for sharpness
      const cssW = canvas.clientWidth || 300;
      const cssH = canvas.clientHeight || 70;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(cssW * dpr);
      canvas.height = Math.floor(cssH * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      const w = cssW;
      const h = cssH;

      const w = canvas.width;
      const h = canvas.height;
ctx.clearRect(0, 0, w, h);

if (!dailyBalances || dailyBalances.length === 0) return;

const maxVal = Math.max(...dailyBalances, 0);
const minVal = Math.min(...dailyBalances, 0);
const range = maxVal - minVal || 1;

      const leftPadding = 6;
      const rightPadding = 6;
      const topPadding = 6;
      const bottomPadding = 6;
      const leftPadding = 4;
      const rightPadding = 4;
      const topPadding = 4;
      const bottomPadding = 4;
const usableWidth = w - leftPadding - rightPadding;
const usableHeight = h - topPadding - bottomPadding;

const count = dailyBalances.length;
const stepX = count > 1 ? usableWidth / (count - 1) : 0;

      // x-axis baseline at 0
const zeroY = topPadding + usableHeight - ((0 - minVal) / range) * usableHeight;

      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.strokeStyle = "rgba(255,255,255,0.16)";
ctx.lineWidth = 1;
ctx.beginPath();
ctx.moveTo(leftPadding, zeroY);
ctx.lineTo(w - rightPadding, zeroY);
ctx.stroke();

      // Line
ctx.beginPath();
dailyBalances.forEach((val, idx) => {
const x = leftPadding + idx * stepX;
@@ -1367,69 +1169,6 @@
ctx.stroke();
}

    function drawAfterSpark(canvas, values) {
      const ctx = canvas.getContext("2d");
      const cssW = canvas.clientWidth || 300;
      const cssH = canvas.clientHeight || 64;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(cssW * dpr);
      canvas.height = Math.floor(cssH * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      const w = cssW;
      const h = cssH;
      ctx.clearRect(0, 0, w, h);

      if (!values || values.length < 2) return;

      const maxVal = Math.max(...values, 0);
      const minVal = Math.min(...values, 0);
      const range = maxVal - minVal || 1;

      const pad = 8;
      const uw = w - pad * 2;
      const uh = h - pad * 2;
      const stepX = uw / (values.length - 1);

      // 0 line
      const zeroY = pad + uh - ((0 - minVal) / range) * uh;
      ctx.strokeStyle = "rgba(255,255,255,0.16)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, zeroY);
      ctx.lineTo(w - pad, zeroY);
      ctx.stroke();

      // line
      ctx.beginPath();
      values.forEach((v, i) => {
        const x = pad + i * stepX;
        const y = pad + uh - ((v - minVal) / range) * uh;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });

      const grad = ctx.createLinearGradient(pad, 0, w - pad, 0);
      grad.addColorStop(0, "#8ec5ff");
      grad.addColorStop(0.5, "#9af7c7");
      grad.addColorStop(1, "#ff8a94");
      ctx.strokeStyle = grad;
      ctx.lineWidth = 2;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.stroke();

      // dots
      values.forEach((v, i) => {
        const x = pad + i * stepX;
        const y = pad + uh - ((v - minVal) / range) * uh;
        ctx.beginPath();
        ctx.arc(x, y, 2.2, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(255,255,255,0.7)";
        ctx.fill();
      });
    }

// ------------ MONTH CALC WITH CARRY ------------

function getAllMonthKeysIncluding(targetMonth) {
@@ -1445,6 +1184,7 @@

for (const dd of directDebits) {
if (dd.month) set.add(dd.month);
        if (dd.endMonth) set.add(dd.endMonth);
}

for (const ov of ddOverrides) {
@@ -1465,33 +1205,59 @@
return monthKey(d) === mk;
});

      // DD series: any DD with start month <= this month repeats
const monthBaseDDs = directDebits.filter((dd) => {
if (!dd.month) return false;
        const baseDate = parseMonthKey(dd.month);
        if (!baseDate) return false;
        return baseDate <= monthDate;
        return isMonthInRange(mk, dd.month, dd.endMonth);
});

      const actualDDs = monthBaseDDs.map((dd) => {
        const override = ddOverrides.find((ov) => ov.baseId === dd.id && ov.month === mk);
        if (!override || override.type === "none") {
          const active = override ? override.active : dd.active;
          return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: active !== false };
        }
        if (override.type === "modified") {
          return { baseId: dd.id, name: override.name, amount: override.amount, day: override.day, category: override.category, active: override.active !== false };
        }
        if (override.type === "skipped") {
          return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: false };
        }
        return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: dd.active };
      });
      const actualDDs = monthBaseDDs
        .map((dd) => {
          const override = ddOverrides.find((ov) => ov.baseId === dd.id && ov.month === mk);

          if (override && override.type === "skipped") {
            // Deleted for this month, do not show, do not count
            return null;
          }

          if (!override || override.type === "none") {
            const active = override ? override.active : dd.active;
            return {
              baseId: dd.id,
              name: dd.name,
              amount: dd.amount,
              day: dd.day,
              category: dd.category,
              active: active !== false
            };
          }

          if (override.type === "modified") {
            return {
              baseId: dd.id,
              name: override.name,
              amount: override.amount,
              day: override.day,
              category: override.category,
              active: override.active !== false
            };
          }

          return {
            baseId: dd.id,
            name: dd.name,
            amount: dd.amount,
            day: dd.day,
            category: dd.category,
            active: dd.active !== false
          };
        })
        .filter(Boolean);

const activeDDs = actualDDs.filter((d) => d.active);

const income = monthTx.filter((t) => t.type === "income").reduce((sum, t) => sum + (t.amount || 0), 0);
const spend  = monthTx.filter((t) => t.type === "spend").reduce((sum, t) => sum + (t.amount || 0), 0);

const ddTotal = activeDDs.reduce((sum, d) => sum + (d.amount || 0), 0);

const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
@@ -1501,33 +1267,51 @@
const ddUpToDay = activeDDs.filter((d) => d.day <= day).reduce((sum, d) => sum + (d.amount || 0), 0);

const spendUpToDay = monthTx
          .filter((t) => t.type === "spend" && new Date(t.date).getDate() <= day)
          .filter((t) => {
            if (t.type !== "spend") return false;
            const d = new Date(t.date);
            if (Number.isNaN(d.getTime())) return false;
            return d.getDate() <= day;
          })
.reduce((sum, t) => sum + (t.amount || 0), 0);

const incomeUpToDay = monthTx
          .filter((t) => t.type === "income" && new Date(t.date).getDate() <= day)
          .filter((t) => {
            if (t.type !== "income") return false;
            const d = new Date(t.date);
            if (Number.isNaN(d.getTime())) return false;
            return d.getDate() <= day;
          })
.reduce((sum, t) => sum + (t.amount || 0), 0);

        dailyBalances.push(carryIn + incomeUpToDay - ddUpToDay - spendUpToDay);
        const bal = carryIn + incomeUpToDay - ddUpToDay - spendUpToDay;
        dailyBalances.push(bal);
}

const afterAll = carryIn + income - ddTotal - spend;

      return { carryIn, income, spend, ddTotal, afterAll, dailyBalances, activeDDs, rawTransactions: monthTx };
      return {
        carryIn,
        income,
        spend,
        ddTotal,
        afterAll,
        dailyBalances,
        rawTransactions: monthTx
      };
}

function computeMonthWithCarry(targetMonth) {
const targetMK = monthKey(targetMonth);
const allMKs = getAllMonthKeysIncluding(targetMonth);

let carry = 0;
let result = null;

for (const mk of allMKs) {
const mDate = parseMonthKey(mk);
if (!mDate) continue;
        const raw = computeRawMonthTotals(mDate, carry);

        const raw = computeRawMonthTotals(mDate, carry);
if (mk === targetMK) {
result = raw;
break;
@@ -1536,111 +1320,17 @@
}
}

      return result || computeRawMonthTotals(targetMonth, 0);
    }

    function monthMinus(d, n) {
      return new Date(d.getFullYear(), d.getMonth() - n, 1);
    }

    function monthPlus(d, n) {
      return new Date(d.getFullYear(), d.getMonth() + n, 1);
      if (!result) return computeRawMonthTotals(targetMonth, 0);
      return result;
}

// ------------ UI RENDERING ------------

let selectedMonth = firstOfMonth(new Date());
    let whatIfOffset = 0;

let currentEditingTxId = null;
let currentEditingDdBaseId = null;
let currentEditingDdMonthKey = null;

    function refreshTrendIntelligence() {
      const tAfterEl = document.getElementById("trendAfterDelta");
      const tAfterSubEl = document.getElementById("trendAfterDeltaSub");
      const tIncomeEl = document.getElementById("trendIncomeDelta");
      const tOutEl = document.getElementById("trendOutDelta");
      const tProjEl = document.getElementById("trendProjection");
      const tProjSubEl = document.getElementById("trendProjectionSub");
      const tAvgAfterEl = document.getElementById("trendAvgAfter");
      const tAvgOutEl = document.getElementById("trendAvgOut");
      const spark = document.getElementById("afterSpark");
      const sparkHint = document.getElementById("sparkHint");

      const thisTotals = computeMonthWithCarry(selectedMonth);
      const prevTotals = computeMonthWithCarry(monthMinus(selectedMonth, 1));

      const thisOpeningPlusIncome = thisTotals.carryIn + thisTotals.income;
      const prevOpeningPlusIncome = prevTotals.carryIn + prevTotals.income;

      const thisOut = thisTotals.ddTotal + thisTotals.spend;
      const prevOut = prevTotals.ddTotal + prevTotals.spend;

      const dAfter = thisTotals.afterAll - prevTotals.afterAll;
      const dIncome = thisOpeningPlusIncome - prevOpeningPlusIncome;
      const dOut = thisOut - prevOut;

      const a = deltaLabel(dAfter);
      tAfterEl.innerHTML = `<span class="delta ${a.cls}">${a.text}</span>`;
      tAfterSubEl.textContent = `Last month: ${formatMoney(prevTotals.afterAll)} · This month: ${formatMoney(thisTotals.afterAll)}`;

      const i = deltaLabel(dIncome);
      tIncomeEl.innerHTML = `<span class="delta ${i.cls}">${i.text}</span>`;

      const o = deltaLabel(dOut);
      tOutEl.innerHTML = `<span class="delta ${o.cls}">${o.text}</span>`;

      // 3-month averages (this month + previous 2)
      const m0 = computeMonthWithCarry(selectedMonth);
      const m1 = computeMonthWithCarry(monthMinus(selectedMonth, 1));
      const m2 = computeMonthWithCarry(monthMinus(selectedMonth, 2));

      const avgAfter = (m0.afterAll + m1.afterAll + m2.afterAll) / 3;
      const avgOut = ((m0.ddTotal + m0.spend) + (m1.ddTotal + m1.spend) + (m2.ddTotal + m2.spend)) / 3;

      animateMoney(tAvgAfterEl, avgAfter);
      animateMoney(tAvgOutEl, avgOut);

      // Projection: simple run-rate using current day balance vs end-of-month
      // If viewing current real month: use today's day index. Otherwise use mid-month (15) to avoid nonsense.
      const now = new Date();
      const sameRealMonth = (now.getFullYear() === selectedMonth.getFullYear() && now.getMonth() === selectedMonth.getMonth());
      const daysInMonth = new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1, 0).getDate();
      const dayIndex = sameRealMonth ? clamp(now.getDate(), 1, daysInMonth) : 15;

      const balToday = thisTotals.dailyBalances[dayIndex - 1] ?? thisTotals.afterAll;
      const balEnd = thisTotals.afterAll;

      // Estimate slope from start-of-month balance to today, then project to end
      const balStart = thisTotals.dailyBalances[0] ?? (thisTotals.carryIn);
      const daysPassed = Math.max(1, dayIndex - 1);
      const dailyChange = (balToday - balStart) / daysPassed;
      const daysRemaining = Math.max(0, daysInMonth - dayIndex);
      const projectedEnd = balToday + dailyChange * daysRemaining;

      animateMoney(tProjEl, projectedEnd);
      const projDiff = projectedEnd - balEnd;
      const projDelta = deltaLabel(projDiff);
      tProjSubEl.innerHTML = `Model: pace-based · vs current “Left”: <span class="delta ${projDelta.cls}">${projDelta.text}</span>`;

      // 6-month sparkline for afterAll
      const series = [];
      const labels = [];
      for (let i6 = 5; i6 >= 0; i6--) {
        const d = monthMinus(selectedMonth, i6);
        const tot = computeMonthWithCarry(d);
        series.push(tot.afterAll);
        labels.push(monthLabel(d));
      }

      drawAfterSpark(spark, series);

      const slope = series[series.length - 1] - series[0];
      if (slope > 0) sparkHint.textContent = "Trend: improving";
      else if (slope < 0) sparkHint.textContent = "Trend: declining";
      else sparkHint.textContent = "Trend: flat";
    }
    let ddEditScope = "month"; // "month" | "future"

function refreshUI() {
const monthLabelEl = document.getElementById("monthLabel");
@@ -1649,9 +1339,6 @@
const spendValueEl = document.getElementById("spendValue");
const leftValueEl = document.getElementById("leftValue");
const leftCardEl = document.getElementById("leftCard");
      const whatIfSlider = document.getElementById("whatIfSlider");
      const whatIfChangeEl = document.getElementById("whatIfChange");
      const whatIfAfterEl = document.getElementById("whatIfAfter");
const donutCanvas = document.getElementById("donutCanvas");
const balanceCanvas = document.getElementById("balanceCanvas");

@@ -1680,20 +1367,19 @@
const openingPlusIncome = carryIn + income;
const totalOut = ddTotal + spend;

      // animate main values
      animateMoney(incomeValueEl, income);
      animateMoney(ddValueEl, ddTotal);
      animateMoney(spendValueEl, spend);
      animateMoney(leftValueEl, baseAfterAll);
      incomeValueEl.textContent = formatMoney(income);
      ddValueEl.textContent = formatMoney(ddTotal);
      spendValueEl.textContent = formatMoney(spend);
      leftValueEl.textContent = formatMoney(baseAfterAll);

      animateMoney(legendIncomeEl, openingPlusIncome);
      animateMoney(legendOutEl, totalOut);
      animateMoney(legendLeftEl, baseAfterAll);
      legendIncomeEl.textContent = formatMoney(openingPlusIncome);
      legendOutEl.textContent = formatMoney(totalOut);
      legendLeftEl.textContent = formatMoney(baseAfterAll);

      animateMoney(summaryStartEl, openingPlusIncome);
      animateMoney(summaryDdEl, ddTotal);
      animateMoney(summarySpendEl, spend);
      animateMoney(summaryAfterEl, baseAfterAll);
      summaryStartEl.textContent = formatMoney(openingPlusIncome);
      summaryDdEl.textContent = formatMoney(ddTotal);
      summarySpendEl.textContent = formatMoney(spend);
      summaryAfterEl.textContent = formatMoney(baseAfterAll);

if (baseAfterAll > 0) {
leftCardEl.style.borderColor = "rgba(64,227,138,0.5)";
@@ -1727,33 +1413,11 @@
statusSubEl.textContent = "You’ve used 100% of this month’s opening + income.";
}

      const maxSlider = Math.max(2000, Math.round(openingPlusIncome) || 0);
      whatIfSlider.min = -maxSlider;
      whatIfSlider.max = maxSlider;
      whatIfSlider.value = whatIfOffset;

      const absChange = Math.abs(whatIfOffset);
      const sign = whatIfOffset === 0 ? "" : whatIfOffset > 0 ? "+" : "−";
      const afterChange = baseAfterAll - whatIfOffset;

      whatIfChangeEl.textContent = `Change: ${sign}${formatMoney(absChange).replace("£", "")}`;
      whatIfAfterEl.textContent = `After change: ${formatMoney(afterChange)}`;

      const adjustedBalances = totals.dailyBalances.map((v, idx, arr) => {
        if (whatIfOffset === 0 || arr.length === 0) return v;
        const factor = (idx + 1) / arr.length;
        return v - whatIfOffset * factor;
      });

      drawBalanceLine(balanceCanvas, adjustedBalances);

      const adjustedOpeningPlusIncome = openingPlusIncome - whatIfOffset;
      drawDonut(donutCanvas, adjustedOpeningPlusIncome, totalOut);
      drawBalanceLine(balanceCanvas, totals.dailyBalances);
      drawDonut(donutCanvas, openingPlusIncome, totalOut);

renderTransactionList();
renderDirectDebitList();

      refreshTrendIntelligence();
}

function renderTransactionList() {
@@ -1825,27 +1489,40 @@
const ddList = document.getElementById("ddList");
ddList.innerHTML = "";

      const monthBaseDDs = directDebits.filter((dd) => {
        if (!dd.month) return false;
        const baseDate = parseMonthKey(dd.month);
        if (!baseDate) return false;
        return baseDate <= selectedMonth;
      });

      const actualDDs = monthBaseDDs.map((dd) => {
        const override = ddOverrides.find((ov) => ov.baseId === dd.id && ov.month === mk);
        if (!override || override.type === "none") {
          const active = override ? override.active : dd.active;
          return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: active !== false };
        }
        if (override.type === "modified") {
          return { baseId: dd.id, name: override.name, amount: override.amount, day: override.day, category: override.category, active: override.active !== false };
        }
        if (override.type === "skipped") {
          return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: false };
        }
        return { baseId: dd.id, name: dd.name, amount: dd.amount, day: dd.day, category: dd.category, active: dd.active };
      });
      const monthBaseDDs = directDebits.filter((dd) => isMonthInRange(mk, dd.month, dd.endMonth));

      const actualDDs = monthBaseDDs
        .map((dd) => {
          const override = ddOverrides.find((ov) => ov.baseId === dd.id && ov.month === mk);

          if (override && override.type === "skipped") {
            // Deleted for this month -> do not show
            return null;
          }

          let effective = {
            baseId: dd.id,
            name: dd.name,
            amount: dd.amount,
            day: dd.day,
            category: dd.category,
            active: dd.active !== false
          };

          if (override && override.type === "modified") {
            effective = {
              baseId: dd.id,
              name: override.name,
              amount: override.amount,
              day: override.day,
              category: override.category,
              active: override.active !== false
            };
          }

          return effective;
        })
        .filter(Boolean);

if (actualDDs.length === 0) {
const empty = document.createElement("div");
@@ -1924,6 +1601,7 @@
directDebits.push({
id: uuid(),
month: monthKey(selectedMonth),
        endMonth: null,
name: nameVal,
amount: amt,
day: dayVal,
@@ -1946,7 +1624,7 @@
document.getElementById("editTxDate").value = tx.date;
document.getElementById("editTxType").value = tx.type;
document.getElementById("editTxDesc").value = tx.description;
      document.getElementById("editTxAmt").value = (tx.amount || 0).toFixed(2);
      document.getElementById("editTxAmt").value = tx.amount.toFixed(2);
document.getElementById("txModal").style.display = "flex";
}

@@ -1986,46 +1664,66 @@
closeTransactionEditModal();
}

    function setScope(scope) {
      ddEditScope = scope;
      document.getElementById("scopeMonthBtn").classList.toggle("active", scope === "month");
      document.getElementById("scopeFutureBtn").classList.toggle("active", scope === "future");
    }

function openDirectDebitEditModal(baseId) {
currentEditingDdBaseId = baseId;
currentEditingDdMonthKey = monthKey(selectedMonth);

const base = directDebits.find((d) => d.id === baseId);
if (!base) return;

      const mk = monthKey(selectedMonth);
      const mk = currentEditingDdMonthKey;
const override = ddOverrides.find((ov) => ov.baseId === baseId && ov.month === mk);

      let effective = { name: base.name, amount: base.amount, day: base.day, category: base.category, active: base.active };

      if (override) {
        if (override.type === "modified") {
          effective = { name: override.name, amount: override.amount, day: override.day, category: override.category, active: override.active };
        } else if (override.type === "skipped") {
          effective.active = false;
        }
      let effective = {
        name: base.name,
        amount: base.amount,
        day: base.day,
        category: base.category,
        active: base.active !== false
      };

      if (override && override.type === "modified") {
        effective = {
          name: override.name,
          amount: override.amount,
          day: override.day,
          category: override.category,
          active: override.active !== false
        };
}

      // If it's deleted for this month, don't open editor (it's not shown anyway)
      if (override && override.type === "skipped") return;

document.getElementById("editDdName").value = effective.name;
      document.getElementById("editDdAmt").value = (effective.amount || 0).toFixed(2);
      document.getElementById("editDdAmt").value = effective.amount.toFixed(2);
document.getElementById("editDdDay").value = effective.day;
document.getElementById("editDdCat").value = effective.category || "";

const pausedToggle = document.getElementById("ddPausedToggle");
pausedToggle.classList.toggle("on", !effective.active);

      // default scope
      setScope("month");

document.getElementById("ddModal").style.display = "flex";
}

function closeDirectDebitEditModal() {
document.getElementById("ddModal").style.display = "none";
currentEditingDdBaseId = null;
currentEditingDdMonthKey = null;
      setScope("month");
}

function toggleDdPaused() {
      const toggle = document.getElementById("ddPausedToggle");
      toggle.classList.toggle("on");
      document.getElementById("ddPausedToggle").classList.toggle("on");
}

function saveDirectDebitEdit() {
@@ -2040,47 +1738,104 @@
const dayVal = parseInt(document.getElementById("editDdDay").value, 10);
const catVal = document.getElementById("editDdCat").value.trim();
const paused = document.getElementById("ddPausedToggle").classList.contains("on");
      const selectedMK = currentEditingDdMonthKey;

if (!nameVal || !isFinite(amt) || !isFinite(dayVal)) return;
if (dayVal < 1 || dayVal > 31) return;

      let override = ddOverrides.find((ov) => ov.baseId === currentEditingDdBaseId && ov.month === currentEditingDdMonthKey);
      // THIS MONTH ONLY -> override
      if (ddEditScope === "month") {
        let override = ddOverrides.find((ov) => ov.baseId === currentEditingDdBaseId && ov.month === selectedMK);

      if (!override) {
        override = { baseId: currentEditingDdBaseId, month: currentEditingDdMonthKey, type: "none", active: base.active };
        ddOverrides.push(override);
        if (!override) {
          override = { baseId: currentEditingDdBaseId, month: selectedMK, type: "none", active: base.active !== false };
          ddOverrides.push(override);
        }

        override.type = "modified";
        override.name = nameVal;
        override.amount = amt;
        override.day = dayVal;
        override.category = catVal;
        override.active = !paused;

        // If override ends up identical to base, remove it
        const baseActive = base.active !== false;
        if (
          override.name === base.name &&
          override.amount === base.amount &&
          override.day === base.day &&
          (override.category || "") === (base.category || "") &&
          (override.active !== false) === baseActive
        ) {
          ddOverrides = ddOverrides.filter((ov) => !(ov.baseId === currentEditingDdBaseId && ov.month === selectedMK));
        }

        saveToStorage();
        closeDirectDebitEditModal();
        refreshUI();
        return;
      }

      // THIS MONTH + FUTURE
      // If selected month is the same as series start, just edit base directly.
      if (selectedMK === base.month) {
        base.name = nameVal;
        base.amount = amt;
        base.day = dayVal;
        base.category = catVal;
        base.active = !paused;

        // Remove any overrides for >= this month, because base now defines future
        ddOverrides = ddOverrides.filter((ov) => !(ov.baseId === base.id && compareMonthKey(ov.month, selectedMK) >= 0));

        saveToStorage();
        closeDirectDebitEditModal();
        refreshUI();
        return;
}

      override.type = "modified";
      override.name = nameVal;
      override.amount = amt;
      override.day = dayVal;
      override.category = catVal;
      override.active = !paused;

      // If identical to base, drop override
      if (
        override.name === base.name &&
        override.amount === base.amount &&
        override.day === base.day &&
        (override.category || "") === (base.category || "") &&
        override.active === base.active
      ) {
        ddOverrides = ddOverrides.filter((ov) => !(ov.baseId === currentEditingDdBaseId && ov.month === currentEditingDdMonthKey));
      // Otherwise split the series:
      // 1) end the existing series the month before selected
      // 2) create a new series starting selected month with new details
      const oldEnd = base.endMonth || null;
      base.endMonth = prevMonthKey(selectedMK);

      // If the old series already ended before selected, do nothing (shouldn't happen if visible)
      if (compareMonthKey(base.endMonth, base.month) < 0) {
        base.endMonth = base.month;
}

      const newId = uuid();
      const newDd = {
        id: newId,
        month: selectedMK,
        endMonth: oldEnd && compareMonthKey(selectedMK, oldEnd) <= 0 ? oldEnd : null,
        name: nameVal,
        amount: amt,
        day: dayVal,
        category: catVal,
        active: !paused
      };
      directDebits.push(newDd);

      // Remove overrides on old base from selected month onwards (they belong to future)
      ddOverrides = ddOverrides.filter((ov) => !(ov.baseId === base.id && compareMonthKey(ov.month, selectedMK) >= 0));

saveToStorage();
closeDirectDebitEditModal();
refreshUI();
}

    function deleteDirectDebitForMonth() {
    function deleteDirectDebitThisMonth() {
if (!currentEditingDdBaseId || !currentEditingDdMonthKey) return;

      let override = ddOverrides.find((ov) => ov.baseId === currentEditingDdBaseId && ov.month === currentEditingDdMonthKey);
      // Create a "skipped" override so it truly disappears for the month (not red)
      const mk = currentEditingDdMonthKey;

      let override = ddOverrides.find((ov) => ov.baseId === currentEditingDdBaseId && ov.month === mk);
if (!override) {
        override = { baseId: currentEditingDdBaseId, month: currentEditingDdMonthKey, type: "skipped", active: false };
        override = { baseId: currentEditingDdBaseId, month: mk, type: "skipped", active: false };
ddOverrides.push(override);
} else {
override.type = "skipped";
@@ -2092,6 +1847,35 @@
refreshUI();
}

    function deleteDirectDebitMonthAndFuture() {
      if (!currentEditingDdBaseId || !currentEditingDdMonthKey) return;

      const base = directDebits.find((d) => d.id === currentEditingDdBaseId);
      if (!base) return;

      const selectedMK = currentEditingDdMonthKey;

      // If series starts this month, remove it completely (and its overrides)
      if (base.month === selectedMK) {
        directDebits = directDebits.filter((d) => d.id !== base.id);
        ddOverrides = ddOverrides.filter((ov) => ov.baseId !== base.id);
        saveToStorage();
        closeDirectDebitEditModal();
        refreshUI();
        return;
      }

      // Otherwise, end it the previous month (keeps history)
      base.endMonth = prevMonthKey(selectedMK);

      // Remove overrides >= selected month (no longer relevant)
      ddOverrides = ddOverrides.filter((ov) => !(ov.baseId === base.id && compareMonthKey(ov.month, selectedMK) >= 0));

      saveToStorage();
      closeDirectDebitEditModal();
      refreshUI();
    }

// ------------ DONUT BREAKDOWN ------------

function openDonutBreakdown() {
@@ -2102,9 +1886,8 @@
const thisDd = thisTotals.ddTotal;
const thisAfter = thisTotals.afterAll;

      const prevMonth = monthMinus(selectedMonth, 1);
      const prevMonth = new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1, 1);
const prevTotals = computeMonthWithCarry(prevMonth);

const lastMonthAfter = prevTotals.afterAll;
const lastMonthIncomeTotal = prevTotals.income + prevTotals.carryIn;

@@ -2119,11 +1902,17 @@
const diffSpend = thisSpend - prevTotals.spend;

const afterLabel =
        !isFinite(lastMonthAfter) ? "–" : `${diffAfter >= 0 ? "+" : "−"}${formatMoney(Math.abs(diffAfter)).replace("£", "")}`;
        !isFinite(lastMonthAfter) || lastMonthAfter === 0
          ? "–"
          : `${diffAfter >= 0 ? "+" : "−"}${formatMoney(Math.abs(diffAfter)).replace("£", "")}`;
const incomeLabel =
        !isFinite(lastMonthIncomeTotal) ? "–" : `${diffIncome >= 0 ? "+" : "−"}${formatMoney(Math.abs(diffIncome)).replace("£", "")}`;
        !isFinite(lastMonthIncomeTotal) || lastMonthIncomeTotal === 0
          ? "–"
          : `${diffIncome >= 0 ? "+" : "−"}${formatMoney(Math.abs(diffIncome)).replace("£", "")}`;
const spendLabel =
        !isFinite(prevTotals.spend) ? "–" : `${diffSpend >= 0 ? "+" : "−"}${formatMoney(Math.abs(diffSpend)).replace("£", "")}`;
        !isFinite(prevTotals.spend) || prevTotals.spend === 0
          ? "–"
          : `${diffSpend >= 0 ? "+" : "−"}${formatMoney(Math.abs(diffSpend)).replace("£", "")}`;

document.getElementById("compareAfter").textContent = afterLabel;
document.getElementById("compareIncome").textContent = incomeLabel;
@@ -2162,39 +1951,29 @@
const d = new Date(t.date);
const mk = Number.isNaN(d.getTime()) ? "" : monthKey(d);
lines.push([
          "TRANSACTION",
          mk,
          t.date || "",
          t.type || "",
          esc(t.description || ""),
          "TRANSACTION", mk, t.date || "", t.type || "", esc(t.description || ""),
t.amount != null ? t.amount.toFixed(2) : "",
          "","","","","",
          "","","","","",""
          "","","","","", "", "", "", "", "", ""
].join(","));
}

for (const dd of directDebits) {
lines.push([
          "DIRECT_DEBIT",
          dd.month || "",
          "","","","",
          "DIRECT_DEBIT", dd.month || "", "", "", "", "",
esc(dd.name || ""),
dd.amount != null ? dd.amount.toFixed(2) : "",
dd.day != null ? String(dd.day) : "",
esc(dd.category || ""),
          dd.active ? "Yes" : "No",
          "","","","","",""
          (dd.active !== false) ? "Yes" : "No",
          "", "", "", "", "", ""
].join(","));
}

for (const ov of ddOverrides) {
lines.push([
          "DD_OVERRIDE",
          ov.month || "",
          "","","","",
          "","","","","",
          ov.month || "",
          ov.type || "",
          "DD_OVERRIDE", ov.month || "", "", "", "", "",
          "", "", "", "", "",
          ov.month || "", ov.type || "",
ov.amount != null ? ov.amount.toFixed(2) : "",
ov.day != null ? String(ov.day) : "",
esc(ov.category || ""),
@@ -2224,7 +2003,6 @@
transactions = [];
directDebits = [];
ddOverrides = [];
      whatIfOffset = 0;
selectedMonth = firstOfMonth(new Date());
refreshUI();
}
@@ -2239,14 +2017,12 @@
document.getElementById("txDate").value = today.toISOString().slice(0, 10);

document.getElementById("prevMonthBtn").addEventListener("click", () => {
        selectedMonth = monthMinus(selectedMonth, 1);
        whatIfOffset = 0;
        selectedMonth = new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1, 1);
refreshUI();
});

document.getElementById("nextMonthBtn").addEventListener("click", () => {
        selectedMonth = monthPlus(selectedMonth, 1);
        whatIfOffset = 0;
        selectedMonth = new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1, 1);
refreshUI();
});

@@ -2264,26 +2040,16 @@
document.getElementById("ddModalDone").addEventListener("click", closeDirectDebitEditModal);
document.getElementById("ddPausedToggle").addEventListener("click", toggleDdPaused);
document.getElementById("saveDdBtn").addEventListener("click", saveDirectDebitEdit);
      document.getElementById("deleteDdBtn").addEventListener("click", deleteDirectDebitForMonth);

      const whatIfSlider = document.getElementById("whatIfSlider");
      whatIfSlider.addEventListener("input", (e) => {
        whatIfOffset = parseFloat(e.target.value) || 0;
        refreshUI();
      });
      document.getElementById("scopeMonthBtn").addEventListener("click", () => setScope("month"));
      document.getElementById("scopeFutureBtn").addEventListener("click", () => setScope("future"));

      document.getElementById("resetWhatIf").addEventListener("click", () => {
        whatIfOffset = 0;
        document.getElementById("whatIfSlider").value = "0";
        refreshUI();
      });
      document.getElementById("deleteDdThisMonthBtn").addEventListener("click", deleteDirectDebitThisMonth);
      document.getElementById("deleteDdFutureBtn").addEventListener("click", deleteDirectDebitMonthAndFuture);

document.getElementById("exportCsvBtn").addEventListener("click", exportAllData);
document.getElementById("resetAppBtn").addEventListener("click", resetApp);

      // Keep canvases crisp on resize
      window.addEventListener("resize", () => refreshUI());

refreshUI();
}
